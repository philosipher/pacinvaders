<!DOCTYPE html>
<html>
<head>
    <title>Space Pac-Invaders</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://www.paypal.com/sdk/js?client-id=AdvuOlMG6Qi_4TxZotXmrupgJTUfoNl8TH5bgrNCKNq2fPfOhZP1Ufr-ZlqZNjUBTUyrPCFRgG7sSe9y&currency=GBP"></script>
    <style>
        canvas {
            border: 1px solid #00FFFF;
            background: #000000;
            max-width: 100%;
            height: auto;
            display: none;
            touch-action: none;
        }
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: #000000;
            overflow: hidden;
            touch-action: none;
            font-family: Arial, sans-serif;
        }
        #menu, #settings-menu, #game-over-menu, #pause-menu, #achievements-menu, #shop-menu, #debug-menu, #tutorial-menu {
            text-align: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: opacity 0.5s ease;
            max-height: 80vh;
            overflow-y: auto;
            padding: 10px;
            box-sizing: border-box;
            opacity: 1;
        }
        #settings-menu, #game-over-menu, #pause-menu, #achievements-menu, #shop-menu, #debug-menu, #tutorial-menu {
            display: none;
        }
        #game-over-menu, #pause-menu, #achievements-menu, #shop-menu, #debug-menu, #tutorial-menu {
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            animation: popIn 0.3s ease-out;
        }
        #debug-menu {
            position: fixed;
            top: 60px;
            left: 10px;
            width: 300px;
            max-height: calc(100vh - 70px);
            overflow-y: auto;
            z-index: 101;
            background: rgba(0, 0, 0, 0.5);
        }
        #logo {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px #00FFFF;
            animation: bounce 2s infinite;
        }
        #made-by {
            font-size: 24px;
            margin-bottom: 20px;
        }
        #start-btn, #settings-btn, #back-btn, #save-settings-btn, #main-menu-btn, #restart-btn, #game-over-settings-btn, #leaderboard-btn, #leaderboard-go-btn, #rules-btn, #resume-btn, #pause-settings-btn, #share-btn, #redeem-code-btn, #donateBtn, #achievementsBtn, #back-to-menu-achievements, #shop-btn, .shop-item-btn, .debug-btn, #debug-toggle-btn, #tutorial-btn, #copy-score-btn, #challenge-friend-btn, #save-prices-btn {
            padding: 10px 20px;
            font-size: 20px;
            background: #00FFFF;
            color: #000000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            transition: background 0.3s, transform 0.2s;
        }
        #start-btn:hover, #settings-btn:hover, #back-btn:hover, #save-settings-btn:hover, #main-menu-btn:hover, #restart-btn:hover, #game-over-settings-btn:hover, #leaderboard-btn:hover, #leaderboard-go-btn:hover, #rules-btn:hover, #resume-btn:hover, #pause-settings-btn:hover, #share-btn:hover, #redeem-code-btn:hover, #donateBtn:hover, #achievementsBtn:hover, #back-to-menu-achievements:hover, #shop-btn:hover, .shop-item-btn:hover, .debug-btn:hover, #debug-toggle-btn:hover, #tutorial-btn:hover, #copy-score-btn:hover, #challenge-friend-btn:hover, #save-prices-btn:hover {
            background: #00baba;
            transform: scale(1.1);
        }
        #theme-select, #ship-select, #bg-image-input, #bg-music-input, #game-volume, #music-volume, .color-picker, .sound-input, #code-input, #bullet-letter-input, #font-select, #game-mode-select, #pause-ship-select, #pause-bullet-letter-input, #music-select, #challenge-score-input, .price-input {
            padding: 5px;
            font-size: 16px;
            background: #000000;
            color: #FFFF00;
            border: 1px solid #00FFFF;
            border-radius: 5px;
            margin: 5px;
        }
        #player-name {
            padding: 5px;
            font-size: 16px;
            background: #000000;
            color: #FFFF00;
            border: 1px solid #00FFFF;
            border-radius: 5px;
            margin: 10px;
        }
        label {
            display: block;
            margin: 5px 0;
        }
        #score, #level, #coins {
            font-family: inherit;
            position: absolute;
            z-index: 10;
            display: none;
        }
        #score { top: 10px; left: 10px; }
        #level { top: 10px; right: 60px; }
        #coins { top: 30px; left: 10px; }
        #leaderboard {
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 16px;
            max-height: 50vh;
            overflow-y: auto;
            position: absolute;
            z-index: 10;
        }
        #joystick {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 0, 0.2);
            border-radius: 50%;
            touch-action: none;
            display: none;
        }
        #joystick-nub {
            position: absolute;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 0, 0.5);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            top: 50%;
            left: 50%;
        }
        #shoot-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            background: rgba(0, 255, 255, 0.5);
            border-radius: 50%;
            border: none;
            touch-action: none;
            display: none;
        }
        #control-bar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 20;
            display: none;
        }
        #sound-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 50px;
            height: 50px;
            background: rgba(0, 255, 255, 0.8);
            color: #000000;
            border: 2px solid #00FFFF;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s, background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        #debug-toggle-btn {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 50px;
            height: 50px;
            background: rgba(255, 0, 0, 0.8);
            color: #FFFFFF;
            border: 2px solid #FF0000;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s, background 0.3s;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        #sound-btn:hover, #debug-toggle-btn:hover {
            background: rgba(0, 186, 186, 0.8);
            transform: scale(1.1);
        }
        #sound-btn.muted {
            background: rgba(255, 0, 0, 0.8);
        }
        #pause-resume-btn {
            width: 50px;
            height: 50px;
            background: rgba(0, 255, 255, 0.8);
            color: #000000;
            border: 2px solid #00FFFF;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s, background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #pause-resume-btn:hover {
            background: rgba(0, 186, 186, 0.8);
            transform: scale(1.1);
        }
        #messageDisplay {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #FFF;
            padding: 10px;
            border-radius: 5px;
            display: none;
            z-index: 30;
        }
        .shop-item {
            display: inline-block;
            margin: 10px;
            text-align: center;
        }
        .shop-item img {
            width: 50px;
            height: 50px;
            border: 1px solid #00FFFF;
        }
        .shop-item-name {
            color: #FFFF00;
            font-size: 16px;
            margin: 5px 0;
        }
        .paypal-buttons-container {
            margin: 10px;
            display: inline-block;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-15px); }
            60% { transform: translateY(-7px); }
        }
        @keyframes popIn {
            from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .ship-option {
            display: flex;
            align-items: center;
        }
        .ship-option img {
            width: 50px;
            height: 50px;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div id="menu" style="display: block;">
        <div id="logo">PacInvaders</div>
        <div id="made-by">Made by Philo Sipher</div>
        <input type="text" id="player-name" placeholder="Enter your name" maxlength="10">
        <button id="start-btn" onclick="startGame()">Start Game</button>
        <button id="settings-btn" onclick="showSettings()">Settings</button>
        <button id="leaderboard-btn" onclick="showLeaderboard('main')">Leaderboard</button>
        <button id="rules-btn" onclick="showRules()">Rules</button>
        <button id="achievementsBtn" onclick="showAchievements()">Achievements</button>
        <button id="donateBtn" onclick="window.open('https://www.paypal.me/kingphilosipher', '_blank')">Donate via PayPal</button>
        <button id="shop-btn" onclick="showShop()">Shop</button>
        <button id="tutorial-btn" onclick="showTutorial()">Tutorial</button>
        <br>
        <select id="ship-select" onchange="changeShip()"></select>
        <input type="text" id="bullet-letter-input" maxlength="1" placeholder="Bullet Letter" onchange="updateBulletLetter()">
        <label for="ship-select">Ship Type & Bullet</label>
        <br>
        <select id="theme-select" onchange="changeTheme()">
            <option value="default">Default</option>
            <option value="retro">Retro</option>
            <option value="neon">Neon</option>
            <option value="solar">Solar</option>
            <option value="cosmic">Cosmic</option>
            <option value="galaxy">Galaxy</option>
            <option value="cyber">Cyber</option>
            <option value="dark">Dark</option>
            <option value="steampunk">Steampunk</option>
            <option value="cyberpunk">Cyberpunk</option>
            <option value="arcade">Arcade</option>
            <option value="futuristic">Futuristic</option>
        </select>
        <div id="leaderboard-main"></div>
        <div id="rules-section" style="display: none; color: #FFFF00; font-size: 18px; margin-top: 20px;"></div>
    </div>
    <div id="settings-menu">
        <div id="logo">Settings</div>
        <input type="file" id="bg-image-input" accept="image/png,image/jpeg,image/jpg" onchange="uploadBackgroundImage()" disabled>
        <label for="bg-image-input">Upload Background Image (PNG/JPG) - Premium Only</label>
        <br>
        <input type="file" id="bg-music-input" accept="audio/mpeg,audio/mp3" onchange="uploadBackgroundMusic()" disabled>
        <label for="bg-music-input">Upload Background Music (MP3) - Premium Only</label>
        <br>
        <input type="range" id="game-volume" min="0" max="1" step="0.1" value="0.5">
        <label for="game-volume">Game Sound Volume</label>
        <br>
        <input type="range" id="music-volume" min="0" max="1" step="0.1" value="0.5">
        <label for="music-volume">Music Volume</label>
        <br>
        <select id="music-select" onchange="changeMusic()">
            <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3">Default Theme</option>
            <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3">Retro Theme</option>
            <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3">Cosmic Theme</option>
        </select>
        <label for="music-select">Background Music</label>
        <br>
        <input type="color" id="ship-color" value="#FFFF00"><label for="ship-color">Ship Color</label>
        <div id="premium-options" style="display: none;">
            <input type="checkbox" id="ai-enemies" onchange="toggleAIEnemies()">
            <label for="ai-enemies">Use AI-Generated Enemies (Premium)</label>
            <br>
            <select id="font-select" onchange="changeFont()">
                <option value="Arial">Arial</option>
                <option value="Times New Roman">Times New Roman</option>
                <option value="Courier New">Courier New</option>
                <option value="Comic Sans MS">Comic Sans MS</option>
                <option value="Impact">Impact</option>
            </select>
            <label for="font-select">Text Font (Premium)</label>
        </div>
        <div id="custom-theme" style="display: none;">
            <input type="color" id="player-color" value="#FFFF00"><label for="player-color">Player Color</label>
            <input type="color" id="pacman-color" value="#FFFF00"><label for="pacman-color">Pac-Man Color</label>
            <input type="color" id="ghost-color" value="#FF0000"><label for="ghost-color">Ghost Color</label>
            <input type="color" id="bullet-color" value="#FF00FF"><label for="bullet-color">Bullet Color</label>
            <input type="color" id="bg-color" value="#000033"><label for="bg-color">Background Color</label>
            <input type="color" id="border-color" value="#00FFFF"><label for="border-color">Border Color</label>
            <input type="color" id="button-color" value="#00FFFF"><label for="button-color">Button Color</label>
            <input type="color" id="menu-color" value="#000000"><label for="menu-color">Menu Background Color</label>
            <input type="color" id="text-color" value="#FFFF00"><label for="text-color">Text Color</label>
        </div>
        <div id="custom-sounds">
            <input type="file" id="waka-sound" accept="audio/mpeg,audio/mp3" class="sound-input" onchange="uploadSound('waka')">
            <label for="waka-sound">Waka Sound (MP3)</label>
            <input type="file" id="death-sound" accept="audio/mpeg,audio/mp3" class="sound-input" onchange="uploadSound('death')">
            <label for="death-sound">Death Sound (MP3)</label>
            <input type="file" id="shoot-sound" accept="audio/mpeg,audio/mp3" class="sound-input" onchange="uploadSound('shoot')">
            <label for="shoot-sound">Shoot Sound (MP3)</label>
            <input type="file" id="enemy-hit-sound" accept="audio/mpeg,audio/mp3" class="sound-input" onchange="uploadSound('enemyHit')">
            <label for="enemy-hit-sound">Pac-Man Hit Sound (MP3)</label>
            <input type="file" id="upgrade-sound" accept="audio/mpeg,audio/mp3" class="sound-input" onchange="uploadSound('upgrade')">
            <label for="upgrade-sound">Upgrade Sound (MP3)</label>
        </div>
        <input type="text" id="code-input" placeholder="Enter code">
        <button id="redeem-code-btn" onclick="redeemCode()">Redeem Code</button>
        <div id="paypal-premium-container" class="paypal-buttons-container"></div>
        <button id="save-settings-btn" onclick="saveSettings()">Save Settings</button>
        <button id="back-btn" onclick="backToMenu()">Back</button>
        <button onclick="window.open('https://forms.gle/example-feedback', '_blank')">Leave Feedback</button>
    </div>
    <div id="game-over-menu">
        <div id="logo">Game Over</div>
        <div id="final-score">Score: 0</div>
        <button id="main-menu-btn" onclick="backToMainMenu()">Main Menu</button>
        <button id="restart-btn" onclick="restartGame()">Restart (Spacebar on PC)</button>
        <button id="game-over-settings-btn" onclick="showSettingsFromGameOver()">Settings</button>
        <button id="leaderboard-go-btn" onclick="showLeaderboard('go')">Leaderboard</button>
        <button id="share-btn" onclick="shareScore()">Share Score</button>
        <button id="copy-score-btn" onclick="copyScore()">Copy Score</button>
        <div id="leaderboard-go"></div>
    </div>
    <div id="pause-menu">
        <div id="logo">Paused</div>
        <select id="pause-ship-select" onchange="changeShipFromPause()"></select>
        <input type="text" id="pause-bullet-letter-input" maxlength="1" placeholder="Bullet Letter" onchange="updateBulletLetterFromPause()">
        <label for="pause-ship-select">Ship Type & Bullet</label>
        <br>
        <select id="game-mode-select" onchange="changeGameMode()">
            <option value="classic">Classic</option>
            <option value="endless">Endless</option>
            <option value="survival">Survival</option>
        </select>
        <label for="game-mode-select">Game Mode</label>
        <br>
        <button id="resume-btn" onclick="resumeGame()">Resume</button>
        <button id="pause-settings-btn" onclick="showSettingsFromPause()">Settings</button>
        <button id="main-menu-btn" onclick="backToMainMenuFromPause()">Main Menu</button>
    </div>
    <div id="achievements-menu">
        <div id="logo">Achievements</div>
        <div id="achievements-list" style="color: #FFFF00; font-size: 18px;"></div>
        <button id="back-to-menu-achievements" onclick="backToMenuFromAchievements()">Back</button>
    </div>
    <div id="shop-menu">
        <div id="logo">Shop</div>
        <div id="shop-items">
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMTBIMzBWMzBIMTBWMTBaIiBmaWxsPSIjRkZGRkZGIi8+PHBhdGggZD0iTTIwIDMwVjQwTTYwIDQwSDQwVjMwSDQwWiIgZmlsbD0iIzAwMDAwMCIvPjwvc3ZnPg==" alt="Car">
                <div class="shop-item-name">Car - £1 (Wheels spin)</div>
                <div id="paypal-car-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjQUFBQUFBIi8+PHBhdGggZD0iTTI1IDE1TDE1IDI1TDM1IDI1TDI1IDE1WiIgZmlsbD0iIzAwMDAwMCIvPjwvc3ZnPg==" alt="Plane">
                <div class="shop-item-name">Plane - £1 (Propeller spins)</div>
                <div id="paypal-plane-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZWxsaXBzZSBjeD0iMjUiIGN5PSIyNSIgcng9IjIwIiByeT0iMTAiIGZpbGw9IiNGRkZGRkYiLz48ZWxsaXBzZSBjeD0iMjUiIGN5PSIxNSIgcng9IjE1IiByeT0iOCIgZmlsbD0iI0FBQUFBQSIvPjwvc3ZnPg==" alt="UFO">
                <div class="shop-item-name">UFO - £1 (Lights pulse)</div>
                <div id="paypal-ufo-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjRkZGRkZGIi8+PHBhdGggZD0iTTIwIDQwVjQ1SDMwVjQwSDIwWiIgZmlsbD0iI0ZGNDUwMCIvPjwvc3ZnPg==" alt="Spaceship">
                <div class="shop-item-name">Spaceship - £1 (Flame flickers)</div>
                <div id="paypal-spaceship-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB4PSIxMCIgeT0iMTUiIHdpZHRoPSI0MCIgaGVpZ2h0PSIxNSIgZmlsbD0iIzY2NjYzMyIvPjxwYXRoIGQ9Ik0yMCAxME0zMCAzNSIgZmlsbD0iIzMzMzMzMyIvPjwvc3ZnPg==" alt="Tank">
                <div class="shop-item-name">Tank - £1 (Turret sways)</div>
                <div id="paypal-tank-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjRkZGRkZGIi8+PHBhdGggZD0iTTIwIDEwTDMwIDIwTDE1IDI1TDIwIDEwWiIgZmlsbD0iI0ZGNDUwMCIvPjwvc3ZnPg==" alt="Dragon">
                <div class="shop-item-name">Dragon - £1 (Wings flap)</div>
                <div id="paypal-dragon-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB4PSIxMCIgeT0iMTAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgZmlsbD0iI0FBQUFBQSIvPjxjaXJjbGUgY3g9IjI1IiBjeT0iMTUiIHI9IjEwIiBmaWxsPSIjRkYwMDAwIi8+PC9zdmc+" alt="Cruiser">
                <div class="shop-item-name">Cruiser - £1 (Tough armor)</div>
                <div id="paypal-cruiser-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjNjY2NjY2Ii8+PHJlY3QgeD0iMjAiIHk9IjMwIiB3aWR0aD0iMTAiIGhlaWdodD0iMTAiIGZpbGw9IiMwMDAwMDAiLz48L3N2Zz4=" alt="Bomber">
                <div class="shop-item-name">Bomber - £1 (Drops bombs)</div>
                <div id="paypal-bomber-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgNDAiIGZpbGw9IiM4QjQ1MTMiLz48cGF0aCBkPSJNMTAgMzBMMzAgNDBMMjAgMjVMMTAgMzBaIiBmaWxsPSIjRkZGRkZGIi8+PC9zdmc+" alt="Pirate">
                <div class="shop-item-name">Pirate - £1 (Treasure glow)</div>
                <div id="paypal-pirate-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjMDBGRjAwIi8+PC9zdmc+" alt="Random">
                <div class="shop-item-name">Random AI Ship - £0.50 (Unique design)</div>
                <div id="paypal-random-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzUiIGZpbGw9IiNGRkYwMDAiLz48L3N2Zz4=" alt="Speed Boost">
                <div class="shop-item-name">Speed Boost - £2 (Doubles speed)</div>
                <div id="paypal-speedboost-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIyNSIgY3k9IjI1IiByPSIyMCIgZmlsbD0iIzAwRkYwMCIvPjwvc3ZnPg==" alt="Shield Pack">
                <div class="shop-item-name">Shield Pack - £3 (Doubles shield)</div>
                <div id="paypal-shieldpack-container" class="paypal-buttons-container"></div>
            </div>
        </div>
        <button id="back-btn" onclick="backToMenuFromShop()">Back</button>
    </div>
    <div id="debug-menu">
        <div id="logo">Debug Menu</div>
        <button class="debug-btn" onclick="debugAddScore(1000)">Add 1000 Score</button>
        <button class="debug-btn" onclick="debugAddScore(10000)">Add 10000 Score</button>
        <button class="debug-btn" onclick="debugNextLevel()">Next Level</button>
        <button class="debug-btn" onclick="debugSpawnUpgrade()">Spawn Random Upgrade</button>
        <button class="debug-btn" onclick="debugToggleInvincibility()">Toggle Invincibility</button>
        <button class="debug-btn" onclick="debugResetGame()">Reset Game</button>
        <button class="debug-btn" onclick="debugMaxBullets()">Max Bullets</button>
        <button class="debug-btn" onclick="debugMaxSpeed()">Max Speed</button>
        <button class="debug-btn" onclick="debugInfiniteShield()">Infinite Shield</button>
        <button class="debug-btn" onclick="debugKillAllPacmen()">Kill All Pacmen</button>
        <button class="debug-btn" onclick="debugSpawnGhosts(5)">Spawn 5 Ghosts</button>
        <button class="debug-btn" onclick="debugIncreaseFireRate()">Increase Fire Rate</button>
        <button class="debug-btn" onclick="debugUnlockAllShips()">Unlock All Ships</button>
        <button class="debug-btn" onclick="debugDoubleSize()">Double Player Size</button>
        <button class="debug-btn" onclick="debugHalfSize()">Half Player Size</button>
        <button class="debug-btn" onclick="debugInstantLevel10()">Jump to Level 10</button>
        <button class="debug-btn" onclick="debugSlowEnemies()">Slow Enemies</button>
        <button class="debug-btn" onclick="debugFastEnemies()">Fast Enemies</button>
        <button class="debug-btn" onclick="debugExtraLives(3)">Add 3 Lives</button>
        <button class="debug-btn" onclick="debugUnlockAchievements()">Unlock All Achievements</button>
        <button class="debug-btn" onclick="debugAddCoins(1000)">Add 1000 Coins</button>
        <div style="color: #FFFF00; font-size: 14px; margin: 10px;">
            <strong>Redeem Codes:</strong><br>
            - "philo debug" - Unlock Debug Menu<br>
            - "gekyume" - Unlock Premium Features<br>
            - "easteregg" - Unlock Secret Ship<br>
            - "5ship" - Get 5 Free AI Ships<br>
            - "5fonts" - Unlock Premium Fonts<br>
            - "5themes" - Unlock Custom Themes<br>
            - "5games" - Unlock All Game Modes
        </div>
        <div style="color: #FFFF00; font-size: 14px; margin: 10px;">
            <strong>Edit Prices (£):</strong><br>
            <label>Premium: <input type="number" id="price-premium" class="price-input" step="0.01" min="0"></label><br>
            <label>Ship (e.g., Car): <input type="number" id="price-ship" class="price-input" step="0.01" min="0"></label><br>
            <label>Random AI Ship: <input type="number" id="price-random" class="price-input" step="0.01" min="0"></label><br>
            <label>Speed Boost: <input type="number" id="price-speedboost" class="price-input" step="0.01" min="0"></label><br>
            <label>Shield Pack: <input type="number" id="price-shieldpack" class="price-input" step="0.01" min="0"></label><br>
            <button id="save-prices-btn" onclick="savePrices()">Save Prices</button>
        </div>
        <button id="back-btn" onclick="toggleDebugMenu()">Collapse</button>
    </div>
    <div id="tutorial-menu">
        <div id="logo">Tutorial</div>
        <div id="tutorial-content" style="color: #FFFF00; font-size: 18px;"></div>
        <button id="back-btn" onclick="backToMenuFromTutorial()">Back</button>
    </div>
    <div id="score">Score: 0</div>
    <div id="level">Level: 1</div>
    <div id="coins">Coins: 0</div>
    <div id="control-bar">
        <button id="pause-resume-btn" onclick="pauseGame()">⏸️</button>
    </div>
    <button id="sound-btn" onclick="toggleMute()">🔊</button>
    <button id="debug-toggle-btn" onclick="toggleDebugMenu()">🐞</button>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div id="joystick">
        <div id="joystick-nub"></div>
    </div>
    <button id="shoot-btn"></button>
    <div id="messageDisplay"></div>

    <script>
        // DOM Elements
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('score');
        const levelDisplay = document.getElementById('level');
        const coinsDisplay = document.getElementById('coins');
        const joystick = document.getElementById('joystick');
        const joystickNub = document.getElementById('joystick-nub');
        const shootBtn = document.getElementById('shoot-btn');
        const soundBtn = document.getElementById('sound-btn');
        const menu = document.getElementById('menu');
        const settingsMenu = document.getElementById('settings-menu');
        const gameOverMenu = document.getElementById('game-over-menu');
        const pauseMenu = document.getElementById('pause-menu');
        const controlBar = document.getElementById('control-bar');
        const finalScore = document.getElementById('final-score');
        const messageDisplay = document.getElementById('messageDisplay');
        const debugToggleBtn = document.getElementById('debug-toggle-btn');
        const debugMenu = document.getElementById('debug-menu');
        const achievementsMenu = document.getElementById('achievements-menu');
        const shopMenu = document.getElementById('shop-menu');
        const tutorialMenu = document.getElementById('tutorial-menu');

        // Game Variables
        let player = {
            x: canvas.width / 2,
            y: canvas.height - 50,
            size: 30,
            speed: 5,
            dx: 0,
            dy: 0,
            lives: 3,
            shootCooldown: 0,
            fireRate: 20,
            bulletSpeed: 10,
            bulletCount: 1,
            shipType: 'default',
            shipLevel: 0,
            shield: 0,
            wheelAngle: 0,
            propellerAngle: 0,
            lightAngle: 0,
            flameOffset: 0,
            flapAngle: 0,
            bombCooldown: 0,
            coins: 0,
            frameCount: 0
        };
        let bullets = [];
        let pacmen = [];
        let bosses = [];
        let upgrades = [];
        let explosions = [];
        let ghosts = [];
        let score = 0;
        let level = 1;
        let gameOver = false;
        let isShooting = false;
        let isPaused = false;
        let isMuted = false;
        let backgroundImage = null;
        let backgroundMusic = new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3');
        let gameVolume = 0.5;
        let musicVolume = 0.5;
        let isInvincible = false;
        let useAIEnemies = false;
        let gameMode = 'classic';
        let challengeScore = 0;
        let customBulletLetter = '•';
        backgroundMusic.loop = true;

        // Sound Effects
        const sounds = {
            waka: new Audio('https://s3.amazonaws.com/freecodecamp/pacman-waka.mp3'),
            death: new Audio('https://s3.amazonaws.com/freecodecamp/pacman-death.mp3'),
            shoot: new Audio('https://www.soundjay.com/buttons/sounds/button-1.mp3'),
            enemyHit: new Audio('https://www.soundjay.com/buttons/sounds/button-2.mp3'),
            upgrade: new Audio('https://www.soundjay.com/buttons/sounds/button-3.mp3')
        };

        // Achievements
        const achievements = {
            pacmanSlayer: { name: 'Pac-Man Slayer', desc: 'Defeat 50 Pac-Men', count: 0, unlocked: false },
            bossBuster: { name: 'Boss Buster', desc: 'Defeat 5 Bosses', count: 0, unlocked: false },
            levelMaster: { name: 'Level Master', desc: 'Reach Level 10', count: 0, unlocked: false },
            coinCollector: { name: 'Coin Collector', desc: 'Collect 500 Coins', count: 0, unlocked: false },
            ghostHunter: { name: 'Ghost Hunter', desc: 'Collect 25 Ghosts', count: 0, unlocked: false }
        };
        const achievementRequirements = {
            pacmanSlayer: 50,
            bossBuster: 5,
            levelMaster: 10,
            coinCollector: 500,
            ghostHunter: 25
        };

        // Ship Types
        const shipTypes = [
            { name: 'default', value: 'default', desc: 'Default Ship' },
            { name: 'car', value: 'car', desc: 'Car - Wheels spin' },
            { name: 'plane', value: 'plane', desc: 'Plane - Propeller spins' },
            { name: 'ufo', value: 'ufo', desc: 'UFO - Lights pulse' },
            { name: 'spaceship', value: 'spaceship', desc: 'Spaceship - Flame flickers' },
            { name: 'tank', value: 'tank', desc: 'Tank - Turret sways' },
            { name: 'dragon', value: 'dragon', desc: 'Dragon - Wings flap' },
            { name: 'cruiser', value: 'cruiser', desc: 'Cruiser - Tough armor' },
            { name: 'bomber', value: 'bomber', desc: 'Bomber - Drops bombs' },
            { name: 'pirate', value: 'pirate', desc: 'Pirate - Treasure glow' },
            { name: 'scout', value: 'scout', desc: 'Scout - Radar pulse' }
        ];

        // Prices
        let prices = {
            premium: 5.00,
            ship: 1.00,
            random: 0.50,
            speedboost: 2.00,
            shieldpack: 3.00
        };

        // Initialize Ship Selection
        const shipSelect = document.getElementById('ship-select');
        const pauseShipSelect = document.getElementById('pause-ship-select');
        shipTypes.forEach(ship => {
            const option = document.createElement('option');
            option.value = ship.value;
            option.textContent = ship.desc;
            shipSelect.appendChild(option);
            const pauseOption = option.cloneNode(true);
            pauseShipSelect.appendChild(pauseOption);
        });

        // Event Listeners
        document.addEventListener('keydown', (e) => {
            if (gameOver && e.code === 'Space') restartGame();
            if (!gameOver && !isPaused) {
                switch (e.code) {
                    case 'ArrowLeft': player.dx = -player.speed; break;
                    case 'ArrowRight': player.dx = player.speed; break;
                    case 'ArrowUp': player.dy = -player.speed; break;
                    case 'ArrowDown': player.dy = player.speed; break;
                    case 'Space': isShooting = true; break;
                }
            }
            if (e.code === 'Escape' && !gameOver) pauseGame();
        });
        document.addEventListener('keyup', (e) => {
            switch (e.code) {
                case 'ArrowLeft':
                case 'ArrowRight': player.dx = 0; break;
                case 'ArrowUp':
                case 'ArrowDown': player.dy = 0; break;
                case 'Space': isShooting = false; break;
            }
        });

        // Joystick Controls
        let joystickActive = false;
        joystick.addEventListener('touchstart', (e) => {
            e.preventDefault();
            joystickActive = true;
        });
        joystick.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (joystickActive) {
                const touch = e.touches[0];
                const rect = joystick.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                let dx = touch.clientX - centerX;
                let dy = touch.clientY - centerY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                const maxDistance = rect.width / 2 - joystickNub.offsetWidth / 2;
                if (distance > maxDistance) {
                    dx = dx * maxDistance / distance;
                    dy = dy * maxDistance / distance;
                }
                joystickNub.style.left = `calc(50% + ${dx}px)`;
                joystickNub.style.top = `calc(50% + ${dy}px)`;
                player.dx = (dx / maxDistance) * player.speed;
                player.dy = (dy / maxDistance) * player.speed;
            }
        });
        document.addEventListener('touchend', (e) => {
            if (e.target !== shootBtn) {
                joystickActive = false;
                joystickNub.style.left = '50%';
                joystickNub.style.top = '50%';
                player.dx = 0;
                player.dy = 0;
            }
        });
        shootBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            isShooting = true;
        });
        shootBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            isShooting = false;
        });

        // Game Functions
        function startGame() {
            const playerName = document.getElementById('player-name').value.trim();
            if (playerName) localStorage.setItem('playerName', playerName);
            menu.style.display = 'none';
            canvas.style.display = 'block';
            scoreDisplay.style.display = 'block';
            levelDisplay.style.display = 'block';
            coinsDisplay.style.display = 'block';
            controlBar.style.display = 'flex';
            if (isMobile()) {
                joystick.style.display = 'block';
                shootBtn.style.display = 'block';
            }
            initLevel();
            backgroundMusic.play();
            gameLoop();
        }

        function initLevel() {
            pacmen = [];
            bosses = [];
            upgrades = [];
            explosions = [];
            ghosts = [];
            for (let i = 0; i < 5 + level; i++) {
                pacmen.push({
                    x: Math.random() * (canvas.width - 40),
                    y: -40,
                    size: 40,
                    speed: 1 + level * 0.5,
                    mouthAngle: 0,
                    mouthSpeed: 0.05,
                    spinAngle: 0,
                    health: 1,
                    isAI: useAIEnemies && Math.random() < 0.5,
                    targetX: player.x,
                    targetY: player.y
                });
            }
            if (level % 5 === 0) {
                bosses.push({
                    x: canvas.width / 2 - 50,
                    y: -100,
                    size: 100,
                    speed: 1 + level * 0.2,
                    health: 10 + level * 2
                });
            }
            scoreDisplay.textContent = `Score: ${score}`;
            levelDisplay.textContent = `Level: ${level}`;
            coinsDisplay.textContent = `Coins: ${player.coins}`;
        }

        function shoot() {
            if (player.shootCooldown <= 0) {
                const newBullets = [];
                if (player.bulletCount === 1) {
                    newBullets.push({ x: player.x, y: player.y - player.size / 2 - 5, speed: player.bulletSpeed });
                } else if (player.bulletCount === 2) {
                    newBullets.push({ x: player.x - 10, y: player.y - player.size / 2 - 5, speed: player.bulletSpeed });
                    newBullets.push({ x: player.x + 10, y: player.y - player.size / 2 - 5, speed: player.bulletSpeed });
                } else {
                    newBullets.push({ x: player.x - 15, y: player.y - player.size / 2 - 5, speed: player.bulletSpeed });
                    newBullets.push({ x: player.x, y: player.y - player.size / 2 - 5, speed: player.bulletSpeed });
                    newBullets.push({ x: player.x + 15, y: player.y - player.size / 2 - 5, speed: player.bulletSpeed });
                }
                bullets.push(...newBullets);
                player.shootCooldown = player.fireRate;
                playSound('shoot');
            }
        }

        function update() {
            if (gameOver || isPaused) return;

            player.x += player.dx;
            player.y += player.dy;
            player.x = Math.max(player.size / 2, Math.min(canvas.width - player.size / 2, player.x));
            player.y = Math.max(player.size / 2, Math.min(canvas.height - player.size / 2, player.y));

            player.wheelAngle += 0.1;
            player.propellerAngle += 0.2;
            player.lightAngle += 0.05;
            player.flameOffset = Math.sin(player.frameCount * 0.1) * 5;
            player.flapAngle = Math.sin(player.frameCount * 0.1) * 0.2;
            if (player.bombCooldown > 0) player.bombCooldown--;

            if (player.shootCooldown > 0) player.shootCooldown--;
            if (isShooting) {
                shoot();
                if (player.shipType === 'bomber' && Math.random() < 0.05) dropBomb();
                if (player.shipType === 'scout' && Math.random() < 0.02) activateRadar();
            }

            spawnGhost();

            const bulletsToRemove = [];
            const pacmenToRemove = [];
            const bossesToRemove = [];

            bullets.forEach((bullet, bIndex) => {
                bullet.y -= bullet.speed;
                if (bullet.y < 0) bulletsToRemove.push(bIndex);

                pacmen.forEach((pacman, eIndex) => {
                    const bulletWidth = 10;
                    const bulletHeight = 20;
                    if (bullet.x > pacman.x - bulletWidth && bullet.x < pacman.x + pacman.size + bulletWidth &&
                        bullet.y > pacman.y - bulletHeight && bullet.y < pacman.y + pacman.size + bulletHeight) {
                        pacman.health--;
                        bulletsToRemove.push(bIndex);
                        if (pacman.health <= 0) {
                            explosions.push({ x: pacman.x + pacman.size / 2, y: pacman.y + pacman.size / 2, size: 10, opacity: 1 });
                            pacmenToRemove.push(eIndex);
                            score += 50;
                            player.coins += 10;
                            achievements.pacmanSlayer.count++;
                            achievements.coinCollector.count += 10;
                            if (achievements.pacmanSlayer.count >= achievementRequirements.pacmanSlayer && !achievements.pacmanSlayer.unlocked) {
                                achievements.pacmanSlayer.unlocked = true;
                                showMessage('Achievement Unlocked: Pac-Man Slayer!');
                            }
                            if (achievements.coinCollector.count >= achievementRequirements.coinCollector && !achievements.coinCollector.unlocked) {
                                achievements.coinCollector.unlocked = true;
                                showMessage('Achievement Unlocked: Coin Collector!');
                            }
                            scoreDisplay.textContent = `Score: ${score}`;
                            coinsDisplay.textContent = `Coins: ${player.coins}`;
                            playSound('enemyHit');
                            if (gameMode === 'endless') {
                                pacmen.push({
                                    x: Math.random() * (canvas.width - 40),
                                    y: -40,
                                    size: 40,
                                    speed: 1 + level * 0.5,
                                    mouthAngle: 0,
                                    mouthSpeed: 0.05,
                                    spinAngle: 0,
                                    health: 1,
                                    isAI: useAIEnemies && Math.random() < 0.5,
                                    targetX: player.x,
                                    targetY: player.y
                                });
                            }
                        }
                    }
                });

                bosses.forEach((boss, bIndex) => {
                    if (bullet.x > boss.x && bullet.x < boss.x + boss.size &&
                        bullet.y > boss.y && bullet.y < boss.y + boss.size) {
                        boss.health--;
                        bulletsToRemove.push(bIndex);
                        if (boss.health <= 0) {
                            explosions.push({ x: boss.x + boss.size / 2, y: boss.y + boss.size / 2, size: 50, opacity: 1 });
                            bossesToRemove.push(bIndex);
                            score += 500;
                            player.coins += 100;
                            achievements.bossBuster.count++;
                            if (achievements.bossBuster.count >= achievementRequirements.bossBuster && !achievements.bossBuster.unlocked) {
                                achievements.bossBuster.unlocked = true;
                                showMessage('Achievement Unlocked: Boss Buster!');
                            }
                            scoreDisplay.textContent = `Score: ${score}`;
                            coinsDisplay.textContent = `Coins: ${player.coins}`;
                            playSound('enemyHit');
                        }
                    }
                });
            });

            bulletsToRemove.sort((a, b) => b - a).forEach(index => bullets.splice(index, 1));
            pacmenToRemove.sort((a, b) => b - a).forEach(index => pacmen.splice(index, 1));
            bossesToRemove.sort((a, b) => b - a).forEach(index => bosses.splice(index, 1));

            pacmen.forEach(pacman => {
                if (pacman.isAI) {
                    const dx = pacman.targetX - pacman.x;
                    const dy = pacman.targetY - pacman.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance > 5) {
                        pacman.x += (dx / distance) * pacman.speed;
                        pacman.y += (dy / distance) * pacman.speed;
                    }
                    pacman.targetX = player.x;
                    pacman.targetY = player.y;
                } else {
                    pacman.y += pacman.speed;
                }
                if (pacman.y > canvas.height) {
                    if (gameMode === 'endless') {
                        pacman.y = -pacman.size;
                        pacman.x = Math.random() * (canvas.width - pacman.size);
                    } else {
                        pacman.y = -pacman.size;
                        pacman.x = Math.random() * (canvas.width - pacman.size);
                    }
                }
                if (!isInvincible && Math.abs(pacman.x - player.x) < (pacman.size + player.size) / 2 &&
                    Math.abs(pacman.y - player.y) < (pacman.size + player.size) / 2) {
                    if (player.shield <= 0) {
                        player.lives--;
                        if (player.lives <= 0) {
                            gameOver = true;
                            playSound('death');
                            finalScore.textContent = `Score: ${score}`;
                            gameOverMenu.style.display = 'block';
                            gameOverMenu.style.opacity = '0';
                            setTimeout(() => gameOverMenu.style.opacity = '1', 10);
                        } else {
                            pacman.y = -pacman.size;
                            showMessage(`Lives remaining: ${player.lives}`);
                        }
                    } else {
                        pacman.y = -pacman.size;
                    }
                }
            });

            bosses.forEach(boss => {
                boss.y += boss.speed;
                if (boss.y > canvas.height) {
                    boss.y = -boss.size;
                    boss.x = Math.random() * (canvas.width - boss.size);
                }
                if (!isInvincible && Math.abs(boss.x + boss.size / 2 - player.x) < (boss.size + player.size) / 2 &&
                    Math.abs(boss.y + boss.size / 2 - player.y) < (boss.size + player.size) / 2) {
                    if (player.shield <= 0) {
                        player.lives -= 2;
                        if (player.lives <= 0) {
                            gameOver = true;
                            playSound('death');
                            finalScore.textContent = `Score: ${score}`;
                            gameOverMenu.style.display = 'block';
                            gameOverMenu.style.opacity = '0';
                            setTimeout(() => gameOverMenu.style.opacity = '1', 10);
                        } else {
                            boss.y = -boss.size;
                            showMessage(`Lives remaining: ${player.lives}`);
                        }
                    } else {
                        boss.y = -boss.size;
                    }
                }
            });

            if (player.shield > 0) player.shield--;

            upgrades.forEach((upgrade, uIndex) => {
                upgrade.y += upgrade.speed;
                if (upgrade.y > canvas.height) {
                    upgrades.splice(uIndex, 1);
                } else if (Math.abs(upgrade.x + upgrade.size / 2 - player.x) < (upgrade.size + player.size) / 2 &&
                           Math.abs(upgrade.y + upgrade.size / 2 - player.y) < (upgrade.size + player.size) / 2) {
                    playSound('upgrade');
                    switch (upgrade.type) {
                        case 'gun':
                            if (player.bulletCount < 3) player.bulletCount++;
                            else if (player.fireRate > 5) player.fireRate -= 5;
                            else player.bulletSpeed += 2;
                            break;
                        case 'ship':
                            player.shipLevel = Math.min(player.shipLevel + 1, 2);
                            break;
                        case 'shield':
                            player.shield = 100;
                            break;
                        case 'speed':
                            player.speed += 2;
                            setTimeout(() => player.speed -= 2, 10000);
                            break;
                        case 'multi':
                            player.bulletCount = 5;
                            setTimeout(() => player.bulletCount = 1, 10000);
                            break;
                    }
                    upgrades.splice(uIndex, 1);
                }
            });

            ghosts.forEach((ghost, index) => {
                ghost.y += ghost.speed;
                if (ghost.y > canvas.height) {
                    ghosts.splice(index, 1);
                } else if (Math.abs(ghost.x + 10 - player.x) < (player.size / 2 + 10) &&
                           Math.abs(ghost.y + 10 - player.y) < (player.size / 2 + 10)) {
                    score += 50;
                    player.coins += 5;
                    achievements.ghostHunter.count++;
                    achievements.coinCollector.count += 5;
                    if (achievements.ghostHunter.count >= achievementRequirements.ghostHunter && !achievements.ghostHunter.unlocked) {
                        achievements.ghostHunter.unlocked = true;
                        showMessage('Achievement Unlocked: Ghost Hunter!');
                    }
                    if (achievements.coinCollector.count >= achievementRequirements.coinCollector && !achievements.coinCollector.unlocked) {
                        achievements.coinCollector.unlocked = true;
                        showMessage('Achievement Unlocked: Coin Collector!');
                    }
                    scoreDisplay.textContent = `Score: ${score}`;
                    coinsDisplay.textContent = `Coins: ${player.coins}`;
                    playSound('waka');
                    ghosts.splice(index, 1);
                }
            });

            if (gameMode === 'classic' && pacmen.length === 0 && bosses.length === 0) {
                level++;
                player.coins += 50;
                achievements.levelMaster.count++;
                achievements.coinCollector.count += 50;
                if (achievements.levelMaster.count >= achievementRequirements.levelMaster && !achievements.levelMaster.unlocked) {
                    achievements.levelMaster.unlocked = true;
                    showMessage('Achievement Unlocked: Level Master!');
                }
                if (achievements.coinCollector.count >= achievementRequirements.coinCollector && !achievements.coinCollector.unlocked) {
                    achievements.coinCollector.unlocked = true;
                    showMessage('Achievement Unlocked: Coin Collector!');
                }
                initLevel();
                levelDisplay.textContent = `Level: ${level}`;
                coinsDisplay.textContent = `Coins: ${player.coins}`;
            } else if (gameMode === 'survival' && Math.random() < 0.05) {
                pacmen.push({
                    x: Math.random() * (canvas.width - 40),
                    y: -40,
                    size: 40,
                    speed: 2 + level * 0.5,
                    mouthAngle: 0,
                    mouthSpeed: 0.05,
                    spinAngle: 0,
                    health: 1,
                    isAI: useAIEnemies && Math.random() < 0.5,
                    targetX: player.x,
                    targetY: player.y
                });
            }

            if (score > challengeScore && challengeScore > 0) {
                showMessage('You beat your friend\'s score!');
                challengeScore = 0;
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (backgroundImage) {
                ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
            }

            drawPlayer();
            bullets.forEach(bullet => {
                ctx.fillStyle = document.getElementById('bullet-color')?.value || '#FF00FF';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(customBulletLetter, bullet.x, bullet.y);
            });
            pacmen.forEach(pacman => {
                pacman.mouthAngle += pacman.mouthSpeed;
                if (pacman.mouthAngle > Math.PI / 4 || pacman.mouthAngle < 0) pacman.mouthSpeed *= -1;
                pacman.spinAngle += 0.05;
                ctx.save();
                ctx.translate(pacman.x + pacman.size / 2, pacman.y + pacman.size / 2);
                ctx.rotate(pacman.spinAngle);
                ctx.fillStyle = document.getElementById('pacman-color')?.value || '#FFFF00';
                ctx.beginPath();
                ctx.arc(0, 0, pacman.size / 2, pacman.mouthAngle, 2 * Math.PI - pacman.mouthAngle);
                ctx.lineTo(0, 0);
                ctx.fill();
                ctx.restore();
            });
            bosses.forEach(boss => {
                ctx.fillStyle = '#FF4500';
                ctx.fillRect(boss.x, boss.y, boss.size, boss.size);
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(boss.x + 10, boss.y + 10, boss.size - 20, 20);
            });
            upgrades.forEach(upgrade => {
                ctx.fillStyle = upgrade.type === 'gun' ? '#FF00FF' : upgrade.type === 'ship' ? '#00FF00' : upgrade.type === 'shield' ? '#00FFFF' : upgrade.type === 'speed' ? '#FFFF00' : '#FF4500';
                ctx.fillRect(upgrade.x, upgrade.y, upgrade.size, upgrade.size);
            });
            explosions.forEach((explosion, index) => {
                ctx.fillStyle = `rgba(255, 165, 0, ${explosion.opacity})`;
                ctx.beginPath();
                ctx.arc(explosion.x, explosion.y, explosion.size, 0, Math.PI * 2);
                ctx.fill();
                explosion.size += 2;
                explosion.opacity -= 0.05;
                if (explosion.opacity <= 0) explosions.splice(index, 1);
            });
            ghosts.forEach(ghost => {
                ctx.fillStyle = document.getElementById('ghost-color')?.value || '#FF0000';
                ctx.beginPath();
                ctx.arc(ghost.x + 10, ghost.y + 10, 10, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillRect(ghost.x + 5, ghost.y + 10, 10, 10);
            });

            if (player.shield > 0) {
                ctx.strokeStyle = '#00FFFF';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(player.x, player.y, player.size / 2 + 5, 0, Math.PI * 2);
                ctx.stroke();
            }

            ctx.fillStyle = '#FFFFFF';
            ctx.font = '20px Arial';
            ctx.fillText(`Lives: ${player.lives}`, canvas.width - 50, 30);
        }

        function drawPlayer() {
            ctx.fillStyle = document.getElementById('player-color')?.value || document.getElementById('ship-color').value || '#FFFF00';
            switch (player.shipType) {
                case 'car':
                    ctx.fillRect(player.x - player.size / 2, player.y - player.size / 2, player.size, player.size);
                    ctx.fillStyle = '#000000';
                    ctx.beginPath();
                    ctx.arc(player.x - player.size / 3, player.y + player.size / 2 + 5, 5, 0, Math.PI * 2);
                    ctx.arc(player.x + player.size / 3, player.y + player.size / 2 + 5, 5, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                case 'plane':
                    ctx.beginPath();
                    ctx.moveTo(player.x, player.y - player.size / 2);
                    ctx.lineTo(player.x - player.size / 2, player.y + player.size / 2);
                    ctx.lineTo(player.x + player.size / 2, player.y + player.size / 2);
                    ctx.fill();
                    ctx.fillStyle = '#000000';
                    ctx.save();
                    ctx.translate(player.x, player.y - player.size / 2);
                    ctx.rotate(player.propellerAngle);
                    ctx.fillRect(-10, -2, 20, 4);
                    ctx.restore();
                    break;
                case 'ufo':
                    ctx.beginPath();
                    ctx.ellipse(player.x, player.y, player.size / 2, player.size / 4, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = `hsl(${player.lightAngle * 100 % 360}, 100%, 50%)`;
                    ctx.beginPath();
                    ctx.arc(player.x, player.y + 5, 5, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                case 'spaceship':
                    ctx.beginPath();
                    ctx.moveTo(player.x, player.y - player.size / 2);
                    ctx.lineTo(player.x - player.size / 2, player.y + player.size / 2);
                    ctx.lineTo(player.x + player.size / 2, player.y + player.size / 2);
                    ctx.fill();
                    ctx.fillStyle = '#FF4500';
                    ctx.beginPath();
                    ctx.moveTo(player.x - player.size / 4, player.y + player.size / 2 + player.flameOffset);
                    ctx.lineTo(player.x + player.size / 4, player.y + player.size / 2 + player.flameOffset);
                    ctx.lineTo(player.x, player.y + player.size / 2 + 10 + player.flameOffset);
                    ctx.fill();
                    break;
                case 'tank':
                    ctx.fillRect(player.x - player.size / 2, player.y - player.size / 4, player.size, player.size / 2);
                    ctx.fillStyle = '#333333';
                    ctx.fillRect(player.x - player.size / 4, player.y - player.size / 2, player.size / 2, player.size / 4);
                    break;
                case 'dragon':
                    ctx.beginPath();
                    ctx.moveTo(player.x, player.y - player.size / 2);
                    ctx.lineTo(player.x - player.size / 2, player.y + player.size / 2);
                    ctx.lineTo(player.x + player.size / 2, player.y + player.size / 2);
                    ctx.fill();
                    ctx.fillStyle = '#FF4500';
                    ctx.save();
                    ctx.translate(player.x - player.size / 2, player.y);
                    ctx.rotate(player.flapAngle);
                    ctx.fillRect(0, -10, 20, 10);
                    ctx.restore();
                    break;
                case 'cruiser':
                    ctx.fillRect(player.x - player.size / 2, player.y - player.size / 2, player.size, player.size);
                    ctx.fillStyle = '#FF0000';
                    ctx.beginPath();
                    ctx.arc(player.x, player.y - player.size / 2 - 5, 10, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                case 'bomber':
                    ctx.beginPath();
                    ctx.moveTo(player.x, player.y - player.size / 2);
                    ctx.lineTo(player.x - player.size / 2, player.y + player.size / 2);
                    ctx.lineTo(player.x + player.size / 2, player.y + player.size / 2);
                    ctx.fill();
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(player.x - player.size / 4, player.y + player.size / 4, player.size / 2, player.size / 4);
                    break;
                case 'pirate':
                    ctx.beginPath();
                    ctx.moveTo(player.x, player.y - player.size / 2);
                    ctx.lineTo(player.x - player.size / 2, player.y + player.size / 2);
                    ctx.lineTo(player.x + player.size / 2, player.y + player.size / 2);
                    ctx.fill();
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.arc(player.x, player.y, 5, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                case 'scout':
                    ctx.beginPath();
                    ctx.moveTo(player.x, player.y - player.size / 2);
                    ctx.lineTo(player.x - player.size / 2, player.y + player.size / 2);
                    ctx.lineTo(player.x + player.size / 2, player.y + player.size / 2);
                    ctx.fill();
                    break;
                default:
                    ctx.beginPath();
                    ctx.moveTo(player.x, player.y - player.size / 2);
                    ctx.lineTo(player.x - player.size / 2, player.y + player.size / 2);
                    ctx.lineTo(player.x + player.size / 2, player.y + player.size / 2);
                    ctx.fill();
            }
        }

        function gameLoop() {
            if (!isPaused) {
                player.frameCount++;
                update();
                draw();
            }
            requestAnimationFrame(gameLoop);
        }

        function playSound(sound) {
            if (!isMuted) {
                sounds[sound].volume = gameVolume;
                sounds[sound].currentTime = 0;
                sounds[sound].play();
            }
        }

        function toggleMute() {
            isMuted = !isMuted;
            soundBtn.textContent = isMuted ? '🔇' : '🔊';
            soundBtn.classList.toggle('muted');
            backgroundMusic.volume = isMuted ? 0 : musicVolume;
        }

        function pauseGame() {
            isPaused = !isPaused;
            pauseMenu.style.display = isPaused ? 'block' : 'none';
            document.getElementById('pause-resume-btn').textContent = isPaused ? '▶️' : '⏸️';
            if (!isPaused) resumeGame();
        }

        function resumeGame() {
            isPaused = false;
            pauseMenu.style.display = 'none';
            document.getElementById('pause-resume-btn').textContent = '⏸️';
        }

        function restartGame() {
            gameOver = false;
            score = 0;
            level = 1;
            player.lives = 3;
            player.x = canvas.width / 2;
            player.y = canvas.height - 50;
            player.shield = 0;
            bullets = [];
            pacmen = [];
            bosses = [];
            upgrades = [];
            explosions = [];
            ghosts = [];
            gameOverMenu.style.display = 'none';
            initLevel();
        }

        function showSettings() {
            menu.style.display = 'none';
            settingsMenu.style.display = 'block';
            document.getElementById('game-volume').value = gameVolume;
            document.getElementById('music-volume').value = musicVolume;
            document.getElementById(            'ai-enemies').checked = useAIEnemies;
        }

        function saveSettings() {
            gameVolume = parseFloat(document.getElementById('game-volume').value);
            musicVolume = parseFloat(document.getElementById('music-volume').value);
            backgroundMusic.volume = isMuted ? 0 : musicVolume;
            useAIEnemies = document.getElementById('ai-enemies').checked;
            applyTheme();
            backToMenu();
        }

        function backToMenu() {
            settingsMenu.style.display = 'none';
            menu.style.display = 'block';
        }

        function showSettingsFromGameOver() {
            gameOverMenu.style.display = 'none';
            settingsMenu.style.display = 'block';
        }

        function showSettingsFromPause() {
            pauseMenu.style.display = 'none';
            settingsMenu.style.display = 'block';
        }

        function backToMainMenu() {
            gameOverMenu.style.display = 'none';
            menu.style.display = 'block';
            canvas.style.display = 'none';
            scoreDisplay.style.display = 'none';
            levelDisplay.style.display = 'none';
            coinsDisplay.style.display = 'none';
            controlBar.style.display = 'none';
            joystick.style.display = 'none';
            shootBtn.style.display = 'none';
        }

        function backToMainMenuFromPause() {
            pauseMenu.style.display = 'none';
            menu.style.display = 'block';
            canvas.style.display = 'none';
            scoreDisplay.style.display = 'none';
            levelDisplay.style.display = 'none';
            coinsDisplay.style.display = 'none';
            controlBar.style.display = 'none';
            joystick.style.display = 'none';
            shootBtn.style.display = 'none';
            isPaused = false;
        }

        function showLeaderboard(section) {
            const leaderboardDiv = document.getElementById(`leaderboard-${section}`);
            leaderboardDiv.style.display = 'block';
            let scores = JSON.parse(localStorage.getItem('leaderboard')) || [];
            leaderboardDiv.innerHTML = '<h3>Leaderboard</h3>' + scores.map(s => `${s.name}: ${s.score}`).join('<br>');
        }

        function saveScore() {
            let scores = JSON.parse(localStorage.getItem('leaderboard')) || [];
            const playerName = localStorage.getItem('playerName') || 'Player';
            scores.push({ name: playerName, score: score });
            scores.sort((a, b) => b.score - a.score);
            scores = scores.slice(0, 10);
            localStorage.setItem('leaderboard', JSON.stringify(scores));
        }

        function shareScore() {
            saveScore();
            const text = `I scored ${score} in Space Pac-Invaders! Can you beat me?`;
            if (navigator.share) {
                navigator.share({ title: 'Space Pac-Invaders', text: text, url: window.location.href });
            } else {
                prompt('Copy this to share your score:', text);
            }
        }

        function copyScore() {
            saveScore();
            const text = `I scored ${score} in Space Pac-Invaders! Can you beat me? Challenge code: ${score}`;
            navigator.clipboard.writeText(text).then(() => alert('Score copied to clipboard!'));
        }

        function isMobile() {
            return /Mobi|Android/i.test(navigator.userAgent);
        }

        function changeTheme() {
            const theme = document.getElementById('theme-select').value;
            applyTheme(theme);
        }

        function applyTheme(theme = document.getElementById('theme-select').value) {
            const customTheme = document.getElementById('custom-theme');
            if (customTheme.style.display === 'block') {
                document.body.style.backgroundColor = document.getElementById('bg-color').value;
                canvas.style.borderColor = document.getElementById('border-color').value;
                document.querySelectorAll('button').forEach(btn => btn.style.backgroundColor = document.getElementById('button-color').value);
                document.querySelectorAll('#menu, #settings-menu, #game-over-menu, #pause-menu, #achievements-menu, #shop-menu, #debug-menu, #tutorial-menu')
                    .forEach(menu => menu.style.backgroundColor = document.getElementById('menu-color').value);
                document.querySelectorAll('label, #score, #level, #coins, .shop-item-name').forEach(el => el.style.color = document.getElementById('text-color').value);
            } else {
                switch (theme) {
                    case 'retro':
                        document.body.style.backgroundColor = '#000000';
                        canvas.style.borderColor = '#00FF00';
                        document.querySelectorAll('button').forEach(btn => btn.style.backgroundColor = '#00FF00');
                        break;
                    case 'neon':
                        document.body.style.backgroundColor = '#000033';
                        canvas.style.borderColor = '#FF00FF';
                        document.querySelectorAll('button').forEach(btn => btn.style.backgroundColor = '#FF00FF');
                        break;
                    default:
                        document.body.style.backgroundColor = '#000000';
                        canvas.style.borderColor = '#00FFFF';
                        document.querySelectorAll('button').forEach(btn => btn.style.backgroundColor = '#00FFFF');
                }
            }
        }

        function uploadBackgroundImage() {
            const file = document.getElementById('bg-image-input').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    backgroundImage = new Image();
                    backgroundImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function uploadBackgroundMusic() {
            const file = document.getElementById('bg-music-input').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    backgroundMusic.src = e.target.result;
                    backgroundMusic.play();
                };
                reader.readAsDataURL(file);
            }
        }

        function changeMusic() {
            backgroundMusic.src = document.getElementById('music-select').value;
            backgroundMusic.play();
        }

        function uploadSound(type) {
            const file = document.getElementById(`${type}-sound`).files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    sounds[type].src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function redeemCode() {
            const code = document.getElementById('code-input').value.toLowerCase();
            switch (code) {
                case 'gekyume':
                    document.getElementById('premium-options').style.display = 'block';
                    document.getElementById('bg-image-input').disabled = false;
                    document.getElementById('bg-music-input').disabled = false;
                    document.getElementById('custom-theme').style.display = 'block';
                    alert('Premium features unlocked!');
                    break;
                case 'philo debug':
                    debugToggleBtn.style.display = 'block';
                    alert('Debug menu unlocked!');
                    break;
                case 'easteregg':
                    shipTypes.push({ name: 'secret', value: 'secret', desc: 'Secret Ship - Surprise!' });
                    updateShipSelect();
                    alert('Secret ship unlocked!');
                    break;
                case '5ship':
                    for (let i = 0; i < 5; i++) {
                        shipTypes.push({ name: `random${i}`, value: `random${i}`, desc: `Random Ship ${i}` });
                    }
                    updateShipSelect();
                    alert('5 random ships unlocked!');
                    break;
                case '5fonts':
                    document.getElementById('font-select').innerHTML += `
                        <option value="Georgia">Georgia</option>
                        <option value="Verdana">Verdana</option>
                        <option value="Helvetica">Helvetica</option>
                    `;
                    alert('Extra fonts unlocked!');
                    break;
                case '5themes':
                    document.getElementById('theme-select').innerHTML += `
                        <option value="space">Space</option>
                        <option value="ocean">Ocean</option>
                        <option value="forest">Forest</option>
                    `;
                    alert('Extra themes unlocked!');
                    break;
                case '5games':
                    document.getElementById('game-mode-select').innerHTML += `
                        <option value="timeattack">Time Attack</option>
                        <option value="hardcore">Hardcore</option>
                    `;
                    alert('Extra game modes unlocked!');
                    break;
                default:
                    alert('Invalid code!');
            }
        }

        function updateShipSelect() {
            shipSelect.innerHTML = '';
            pauseShipSelect.innerHTML = '';
            shipTypes.forEach(ship => {
                const option = document.createElement('option');
                option.value = ship.value;
                option.textContent = ship.desc;
                shipSelect.appendChild(option);
                pauseShipSelect.appendChild(option.cloneNode(true));
            });
        }

        function changeShip() {
            player.shipType = shipSelect.value;
            document.getElementById('pause-ship-select').value = player.shipType;
        }

        function changeShipFromPause() {
            player.shipType = document.getElementById('pause-ship-select').value;
            shipSelect.value = player.shipType;
        }

        function updateBulletLetter() {
            customBulletLetter = document.getElementById('bullet-letter-input').value || '•';
            document.getElementById('pause-bullet-letter-input').value = customBulletLetter;
        }

        function updateBulletLetterFromPause() {
            customBulletLetter = document.getElementById('pause-bullet-letter-input').value || '•';
            document.getElementById('bullet-letter-input').value = customBulletLetter;
        }

        function changeFont() {
            document.body.style.fontFamily = document.getElementById('font-select').value;
        }

        function toggleAIEnemies() {
            useAIEnemies = document.getElementById('ai-enemies').checked;
        }

        function changeGameMode() {
            gameMode = document.getElementById('game-mode-select').value;
            restartGame();
        }

        function showMessage(message) {
            messageDisplay.textContent = message;
            messageDisplay.style.display = 'block';
            setTimeout(() => messageDisplay.style.display = 'none', 3000);
        }

        function spawnGhost() {
            if (Math.random() < 0.01) {
                ghosts.push({
                    x: Math.random() * (canvas.width - 20),
                    y: -20,
                    speed: 2
                });
            }
        }

        function dropBomb() {
            if (player.bombCooldown <= 0) {
                bullets.push({ x: player.x, y: player.y + player.size / 2, speed: -player.bulletSpeed / 2 });
                player.bombCooldown = 50;
            }
        }

        function activateRadar() {
            pacmen.forEach(pacman => {
                pacman.speed *= 0.5;
                setTimeout(() => pacman.speed *= 2, 5000);
            });
        }

        function showAchievements() {
            menu.style.display = 'none';
            achievementsMenu.style.display = 'block';
            const list = document.getElementById('achievements-list');
            list.innerHTML = '';
            for (const key in achievements) {
                const ach = achievements[key];
                list.innerHTML += `${ach.name}: ${ach.desc} - ${ach.unlocked ? 'Unlocked' : `${ach.count}/${achievementRequirements[key]}`}<br>`;
            }
        }

        function backToMenuFromAchievements() {
            achievementsMenu.style.display = 'none';
            menu.style.display = 'block';
        }

        function showShop() {
            menu.style.display = 'none';
            shopMenu.style.display = 'block';
            initPaypalButtons();
        }

        function backToMenuFromShop() {
            shopMenu.style.display = 'none';
            menu.style.display = 'block';
        }

        function initPaypalButtons() {
            paypal.Buttons({
                createOrder: (data, actions) => {
                    return actions.order.create({
                        purchase_units: [{
                            amount: { value: prices.premium.toFixed(2) },
                            description: 'Premium Features for Space Pac-Invaders'
                        }]
                    });
                },
                onApprove: (data, actions) => {
                    return actions.order.capture().then(() => {
                        document.getElementById('premium-options').style.display = 'block';
                        document.getElementById('bg-image-input').disabled = false;
                        document.getElementById('bg-music-input').disabled = false;
                        document.getElementById('custom-theme').style.display = 'block';
                        alert('Premium features unlocked!');
                    });
                }
            }).render('#paypal-premium-container');

            const shipContainers = ['car', 'plane', 'ufo', 'spaceship', 'tank', 'dragon', 'cruiser', 'bomber', 'pirate', 'random', 'speedboost', 'shieldpack'];
            shipContainers.forEach(item => {
                paypal.Buttons({
                    createOrder: (data, actions) => {
                        const price = item === 'random' ? prices.random : item === 'speedboost' ? prices.speedboost : item === 'shieldpack' ? prices.shieldpack : prices.ship;
                        return actions.order.create({
                            purchase_units: [{
                                amount: { value: price.toFixed(2) },
                                description: `${item.charAt(0).toUpperCase() + item.slice(1)} for Space Pac-Invaders`
                            }]
                        });
                    },
                    onApprove: (data, actions) => {
                        return actions.order.capture().then(() => {
                            if (item === 'speedboost') {
                                player.speed *= 2;
                                alert('Speed Boost purchased!');
                            } else if (item === 'shieldpack') {
                                player.shield = 200;
                                alert('Shield Pack purchased!');
                            } else {
                                shipTypes.push({ name: item, value: item, desc: `${item.charAt(0).toUpperCase() + item.slice(1)} Ship` });
                                updateShipSelect();
                                alert(`${item.charAt(0).toUpperCase() + item.slice(1)} purchased!`);
                            }
                        });
                    }
                }).render(`#paypal-${item}-container`);
            });
        }

        function toggleDebugMenu() {
            debugMenu.style.display = debugMenu.style.display === 'block' ? 'none' : 'block';
        }

        function debugAddScore(amount) {
            score += amount;
            scoreDisplay.textContent = `Score: ${score}`;
        }

        function debugNextLevel() {
            level++;
            initLevel();
            levelDisplay.textContent = `Level: ${level}`;
        }

        function debugSpawnUpgrade() {
            const types = ['gun', 'ship', 'shield', 'speed', 'multi'];
            upgrades.push({
                x: Math.random() * (canvas.width - 20),
                y: -20,
                size: 20,
                speed: 2,
                type: types[Math.floor(Math.random() * types.length)]
            });
        }

        function debugToggleInvincibility() {
            isInvincible = !isInvincible;
            showMessage(`Invincibility: ${isInvincible ? 'ON' : 'OFF'}`);
        }

        function debugResetGame() {
            restartGame();
        }

        function debugMaxBullets() {
            player.bulletCount = 5;
        }

        function debugMaxSpeed() {
            player.speed = 10;
        }

        function debugInfiniteShield() {
            player.shield = Infinity;
        }

        function debugKillAllPacmen() {
            pacmen = [];
        }

        function debugSpawnGhosts(count) {
            for (let i = 0; i < count; i++) {
                ghosts.push({
                    x: Math.random() * (canvas.width - 20),
                    y: -20,
                    speed: 2
                });
            }
        }

        function debugIncreaseFireRate() {
            player.fireRate = Math.max(5, player.fireRate - 5);
        }

        function debugUnlockAllShips() {
            shipTypes.forEach(ship => {
                if (!shipSelect.querySelector(`option[value="${ship.value}"]`)) {
                    const option = document.createElement('option');
                    option.value = ship.value;
                    option.textContent = ship.desc;
                    shipSelect.appendChild(option);
                    pauseShipSelect.appendChild(option.cloneNode(true));
                }
            });
        }

        function debugDoubleSize() {
            player.size *= 2;
        }

        function debugHalfSize() {
            player.size /= 2;
        }

        function debugInstantLevel10() {
            level = 10;
            initLevel();
            levelDisplay.textContent = `Level: ${level}`;
        }

        function debugSlowEnemies() {
            pacmen.forEach(p => p.speed /= 2);
            bosses.forEach(b => b.speed /= 2);
        }

        function debugFastEnemies() {
            pacmen.forEach(p => p.speed *= 2);
            bosses.forEach(b => b.speed *= 2);
        }

        function debugExtraLives(count) {
            player.lives += count;
        }

        function debugUnlockAchievements() {
            for (const key in achievements) {
                achievements[key].unlocked = true;
                achievements[key].count = achievementRequirements[key];
            }
            showMessage('All achievements unlocked!');
        }

        function debugAddCoins(amount) {
            player.coins += amount;
            coinsDisplay.textContent = `Coins: ${player.coins}`;
        }

        function showRules() {
            const rulesSection = document.getElementById('rules-section');
            rulesSection.style.display = 'block';
            rulesSection.innerHTML = `
                <h3>Game Rules</h3>
                - Use arrow keys (PC) or joystick (mobile) to move.<br>
                - Spacebar (PC) or shoot button (mobile) to fire.<br>
                - Avoid Pac-Men and Bosses, or lose lives.<br>
                - Collect upgrades (colored boxes) for power-ups.<br>
                - Ghosts give bonus points and coins.<br>
                - Classic Mode: Clear levels to advance.<br>
                - Endless Mode: Survive endless waves.<br>
                - Survival Mode: Increasing difficulty over time.<br>
                - Earn coins to buy ships and upgrades in the shop.
            `;
        }

        function showTutorial() {
            menu.style.display = 'none';
            tutorialMenu.style.display = 'block';
            document.getElementById('tutorial-content').innerHTML = `
                <h3>Tutorial</h3>
                1. <strong>Start:</strong> Enter your name and click "Start Game".<br>
                2. <strong>Move:</strong> Arrow keys (PC) or joystick (mobile).<br>
                3. <strong>Shoot:</strong> Spacebar (PC) or shoot button (mobile).<br>
                4. <strong>Objective:</strong> Destroy Pac-Men and Bosses, avoid collisions.<br>
                5. <strong>Upgrades:</strong> Collect boxes for power-ups (e.g., more bullets, speed).<br>
                6. <strong>Shop:</strong> Use coins to buy ships with unique abilities.<br>
                7. <strong>Achievements:</strong> Unlock by completing challenges.<br>
                8. <strong>Pause:</strong> ESC key (PC) or pause button (top center).
            `;
        }

        function backToMenuFromTutorial() {
            tutorialMenu.style.display = 'none';
            menu.style.display = 'block';
        }

        function savePrices() {
            prices.premium = parseFloat(document.getElementById('price-premium').value) || prices.premium;
            prices.ship = parseFloat(document.getElementById('price-ship').value) || prices.ship;
            prices.random = parseFloat(document.getElementById('price-random').value) || prices.random;
            prices.speedboost = parseFloat(document.getElementById('price-speedboost').value) || prices.speedboost;
            prices.shieldpack = parseFloat(document.getElementById('price-shieldpack').value) || prices.shieldpack;
            alert('Prices updated!');
        }

        // Load saved settings
        const savedName = localStorage.getItem('playerName');
        if (savedName) document.getElementById('player-name').value = savedName;

    </script>
</body>
</html>
