<!DOCTYPE html>
<html>
<head>
    <title>Space Pac-Invaders</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://www.paypal.com/sdk/js?client-id=AdvuOlMG6Qi_4TxZotXmrupgJTUfoNl8TH5bgrNCKNq2fPfOhZP1Ufr-ZlqZNjUBTUyrPCFRgG7sSe9y&currency=GBP"></script>
    <style>
        canvas {
            border: 2px solid #00FFFF;
            background: #000000;
            max-width: 100%;
            height: auto;
            display: none;
            touch-action: none;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #000033, #000000);
            overflow: hidden;
            touch-action: none;
            font-family: 'Orbitron', Arial, sans-serif;
        }
        #menu, #settings-menu, #game-over-menu, #pause-menu, #achievements-menu, #shop-menu, #debug-menu, #tutorial-menu {
            text-align: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.5s ease;
            max-height: 85vh;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
            background: linear-gradient(135deg, rgba(0, 0, 51, 0.9), rgba(0, 0, 0, 0.8));
            border: 2px solid #00FFFF;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.7), inset 0 0 10px rgba(0, 255, 255, 0.3);
        }
        #settings-menu, #game-over-menu, #pause-menu, #achievements-menu, #shop-menu, #debug-menu, #tutorial-menu {
            display: none;
            animation: slideIn 0.5s ease-out;
        }
        #debug-menu {
            position: fixed;
            top: 70px;
            left: 20px;
            width: 320px;
            background: rgba(0, 0, 0, 0.7);
            z-index: 101;
        }
        #logo {
            font-size: 60px;
            font-weight: bold;
            margin-bottom: 25px;
            color: #00FFFF;
            text-shadow: 0 0 10px #00FFFF, 0 0 20px #00FFFF;
            animation: pulse 1.5s infinite;
        }
        #made-by {
            font-size: 28px;
            margin-bottom: 20px;
            color: #FFFF00;
            text-shadow: 0 0 5px #FFFF00;
        }
        button {
            padding: 12px 25px;
            font-size: 22px;
            background: linear-gradient(45deg, #00FFFF, #00baba);
            color: #000000;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 255, 255, 0.5);
        }
        button:hover {
            background: linear-gradient(45deg, #00baba, #00FFFF);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 255, 255, 0.8);
        }
        #theme-select, #ship-select, #bg-image-input, #bg-music-input, #game-volume, #music-volume, .color-picker, .sound-input, #code-input, #bullet-letter-input, #font-select, #game-mode-select, #pause-ship-select, #pause-bullet-letter-input, #music-select, #challenge-score-input, .price-input {
            padding: 8px;
            font-size: 18px;
            background: #000033;
            color: #FFFF00;
            border: 1px solid #00FFFF;
            border-radius: 5px;
            margin: 8px;
            box-shadow: inset 0 0 5px rgba(0, 255, 255, 0.3);
        }
        #player-name {
            padding: 8px;
            font-size: 18px;
            background: #000033;
            color: #FFFF00;
            border: 1px solid #00FFFF;
            border-radius: 5px;
            margin: 15px;
        }
        label {
            display: block;
            margin: 10px 0;
            color: #FFFF00;
            text-shadow: 0 0 3px #FFFF00;
        }
        #score, #level, #coins {
            font-family: 'Orbitron', Arial, sans-serif;
            position: absolute;
            z-index: 10;
            display: none;
            color: #00FFFF;
            text-shadow: 0 0 5px #00FFFF;
        }
        #score { top: 10px; left: 10px; }
        #level { top: 10px; right: 60px; }
        #coins { top: 30px; left: 10px; }
        #joystick {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 0, 0.2);
            border-radius: 50%;
            touch-action: none;
            display: none;
        }
        #joystick-nub {
            position: absolute;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 0, 0.5);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            top: 50%;
            left: 50%;
        }
        #shoot-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            background: rgba(0, 255, 255, 0.5);
            border-radius: 50%;
            border: none;
            touch-action: none;
            display: none;
        }
        #control-bar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 20;
            display: none;
        }
        #sound-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 50px;
            height: 50px;
            background: rgba(0, 255, 255, 0.8);
            color: #000000;
            border: 2px solid #00FFFF;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s, background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        #debug-toggle-btn {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 50px;
            height: 50px;
            background: rgba(255, 0, 0, 0.8);
            color: #FFFFFF;
            border: 2px solid #FF0000;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s, background 0.3s;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        #sound-btn:hover, #debug-toggle-btn:hover {
            background: rgba(0, 186, 186, 0.8);
            transform: scale(1.1);
        }
        #sound-btn.muted {
            background: rgba(255, 0, 0, 0.8);
        }
        #pause-resume-btn {
            width: 50px;
            height: 50px;
            background: rgba(0, 255, 255, 0.8);
            color: #000000;
            border: 2px solid #00FFFF;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s, background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #pause-resume-btn:hover {
            background: rgba(0, 186, 186, 0.8);
            transform: scale(1.1);
        }
        #messageDisplay {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #FFF;
            padding: 10px;
            border-radius: 5px;
            display: none;
            z-index: 30;
        }
        .shop-item {
            display: inline-block;
            margin: 10px;
            text-align: center;
        }
        .shop-item img {
            width: 50px;
            height: 50px;
            border: 1px solid #00FFFF;
        }
        .shop-item-name {
            color: #FFFF00;
            font-size: 16px;
            margin: 5px 0;
        }
        .paypal-buttons-container {
            margin: 10px;
            display: inline-block;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes slideIn {
            from { transform: translate(-50%, -60%) scale(0.9); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .ship-option {
            display: flex;
            align-items: center;
        }
        .ship-option img {
            width: 50px;
            height: 50px;
            margin-right: 5px;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="menu" style="display: block;">
        <div id="logo">PacInvaders</div>
        <div id="made-by">Made by Philo Sipher</div>
        <input type="text" id="player-name" placeholder="Enter your name" maxlength="10">
        <button id="start-btn" onclick="startGame()">Start Game</button>
        <button id="settings-btn" onclick="showSettings()">Settings</button>
        <button id="leaderboard-btn" onclick="showLeaderboard('main')">Leaderboard</button>
        <button id="rules-btn" onclick="showRules()">Rules</button>
        <button id="achievementsBtn" onclick="showAchievements()">Achievements</button>
        <div style="color: #FFFF00; margin: 10px;">Support the Creator:</div>
        <button id="donateBtn" onclick="window.open('https://www.paypal.me/kingphilosipher', '_blank')">Donate via PayPal</button>
        <button id="shop-btn" onclick="showShop()">Shop</button>
        <button id="tutorial-btn" onclick="showTutorial()">Tutorial</button>
        <br>
        <select id="ship-select" onchange="changeShip()"></select>
        <input type="text" id="bullet-letter-input" maxlength="1" placeholder="Bullet Letter" onchange="updateBulletLetter()">
        <label for="ship-select">Ship Type & Bullet</label>
        <br>
        <select id="theme-select" onchange="changeTheme()">
            <option value="default">Default</option>
            <option value="retro">Retro</option>
            <option value="neon">Neon</option>
            <option value="solar">Solar</option>
            <option value="cosmic">Cosmic</option>
            <option value="galaxy">Galaxy</option>
            <option value="cyber">Cyber</option>
            <option value="dark">Dark</option>
            <option value="steampunk">Steampunk</option>
            <option value="cyberpunk">Cyberpunk</option>
            <option value="arcade">Arcade</option>
            <option value="futuristic">Futuristic</option>
        </select>
        <div id="leaderboard-main"></div>
        <div id="rules-section" style="display: none; color: #FFFF00; font-size: 18px; margin-top: 20px;"></div>
    </div>
    <div id="settings-menu">
        <div id="logo">Settings</div>
        <input type="file" id="bg-image-input" accept="image/png,image/jpeg,image/jpg" onchange="uploadBackgroundImage()" disabled>
        <label for="bg-image-input">Upload Background Image (PNG/JPG) - Premium Only</label>
        <br>
        <input type="file" id="bg-music-input" accept="audio/mpeg,audio/mp3" onchange="uploadBackgroundMusic()" disabled>
        <label for="bg-music-input">Upload Background Music (MP3) - Premium Only</label>
        <br>
        <input type="range" id="game-volume" min="0" max="1" step="0.1" value="0.5">
        <label for="game-volume">Game Sound Volume</label>
        <br>
        <input type="range" id="music-volume" min="0" max="1" step="0.1" value="0.5">
        <label for="music-volume">Music Volume</label>
        <br>
        <select id="music-select" onchange="changeMusic()">
            <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3">Default Theme</option>
            <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3">Retro Theme</option>
            <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3">Cosmic Theme</option>
        </select>
        <label for="music-select">Background Music</label>
        <br>
        <input type="color" id="ship-color" value="#FFFF00"><label for="ship-color">Ship Color</label>
        <div id="premium-options" style="display: none;">
            <input type="checkbox" id="ai-enemies" onchange="toggleAIEnemies()">
            <label for="ai-enemies">Use AI-Generated Enemies (Premium)</label>
            <br>
            <select id="font-select" onchange="changeFont()">
                <option value="Arial">Arial</option>
                <option value="Times New Roman">Times New Roman</option>
                <option value="Courier New">Courier New</option>
                <option value="Comic Sans MS">Comic Sans MS</option>
                <option value="Impact">Impact</option>
            </select>
            <label for="font-select">Text Font (Premium)</label>
        </div>
        <div id="custom-theme" style="display: none;">
            <input type="color" id="player-color" value="#FFFF00"><label for="player-color">Player Color</label>
            <input type="color" id="pacman-color" value="#FFFF00"><label for="pacman-color">Pac-Man Color</label>
            <input type="color" id="ghost-color" value="#FF0000"><label for="ghost-color">Ghost Color</label>
            <input type="color" id="bullet-color" value="#FF00FF"><label for="bullet-color">Bullet Color</label>
            <input type="color" id="bg-color" value="#000033"><label for="bg-color">Background Color</label>
            <input type="color" id="border-color" value="#00FFFF"><label for="border-color">Border Color</label>
            <input type="color" id="button-color" value="#00FFFF"><label for="button-color">Button Color</label>
            <input type="color" id="menu-color" value="#000000"><label for="menu-color">Menu Background Color</label>
            <input type="color" id="text-color" value="#FFFF00"><label for="text-color">Text Color</label>
        </div>
        <div id="custom-sounds">
            <input type="file" id="waka-sound" accept="audio/mpeg,audio/mp3" class="sound-input" onchange="uploadSound('waka')">
            <label for="waka-sound">Waka Sound (MP3)</label>
            <input type="file" id="death-sound" accept="audio/mpeg,audio/mp3" class="sound-input" onchange="uploadSound('death')">
            <label for="death-sound">Death Sound (MP3)</label>
            <input type="file" id="shoot-sound" accept="audio/mpeg,audio/mp3" class="sound-input" onchange="uploadSound('shoot')">
            <label for="shoot-sound">Shoot Sound (MP3)</label>
            <input type="file" id="enemy-hit-sound" accept="audio/mpeg,audio/mp3" class="sound-input" onchange="uploadSound('enemyHit')">
            <label for="enemy-hit-sound">Pac-Man Hit Sound (MP3)</label>
            <input type="file" id="upgrade-sound" accept="audio/mpeg,audio/mp3" class="sound-input" onchange="uploadSound('upgrade')">
            <label for="upgrade-sound">Upgrade Sound (MP3)</label>
        </div>
        <input type="text" id="code-input" placeholder="Enter code">
        <button id="redeem-code-btn" onclick="redeemCode()">Redeem Code</button>
        <div style="color: #FFFF00; margin: 10px;">Unlock Premium Upgrade:</div>
        <div id="paypal-premium-container" class="paypal-buttons-container"></div>
        <button id="save-settings-btn" onclick="saveSettings()">Save Settings</button>
        <button id="back-btn" onclick="backToMenu()">Back</button>
        <button onclick="window.open('https://forms.gle/example-feedback', '_blank')">Leave Feedback</button>
    </div>
    <div id="game-over-menu">
        <div id="logo">Game Over</div>
        <div id="final-score">Score: 0</div>
        <button id="main-menu-btn" onclick="backToMainMenu()">Main Menu</button>
        <button id="restart-btn" onclick="restartGame()">Restart (Spacebar on PC)</button>
        <button id="game-over-settings-btn" onclick="showSettingsFromGameOver()">Settings</button>
        <button id="leaderboard-go-btn" onclick="showLeaderboard('go')">Leaderboard</button>
        <button id="share-btn" onclick="shareScore()">Share Score</button>
        <button id="copy-score-btn" onclick="copyScore()">Copy Score</button>
        <div id="leaderboard-go"></div>
    </div>
    <div id="pause-menu">
        <div id="logo">Paused</div>
        <select id="pause-ship-select" onchange="changeShipFromPause()"></select>
        <input type="text" id="pause-bullet-letter-input" maxlength="1" placeholder="Bullet Letter" onchange="updateBulletLetterFromPause()">
        <label for="pause-ship-select">Ship Type & Bullet</label>
        <br>
        <select id="game-mode-select" onchange="changeGameMode()">
            <option value="classic">Classic</option>
            <option value="endless">Endless</option>
            <option value="survival">Survival</option>
        </select>
        <label for="game-mode-select">Game Mode</label>
        <br>
        <button id="resume-btn" onclick="resumeGame()">Resume</button>
        <button id="pause-settings-btn" onclick="showSettingsFromPause()">Settings</button>
        <button id="main-menu-btn" onclick="backToMainMenuFromPause()">Main Menu</button>
    </div>
    <div id="achievements-menu">
        <div id="logo">Achievements</div>
        <div id="achievements-list" style="color: #FFFF00; font-size: 18px;"></div>
        <button id="back-to-menu-achievements" onclick="backToMenuFromAchievements()">Back</button>
    </div>
    <div id="shop-menu">
        <div id="logo">Shop</div>
        <div id="shop-items">
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMTBIMzBWMzBIMTBWMTBaIiBmaWxsPSIjRkZGRkZGIi8+PHBhdGggZD0iTTIwIDMwVjQwTTYwIDQwSDQwVjMwSDQwWiIgZmlsbD0iIzAwMDAwMCIvPjwvc3ZnPg==" alt="Car">
                <div class="shop-item-name">Car - £1 (Wheels spin)</div>
                <div id="paypal-car-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjQUFBQUFBIi8+PHBhdGggZD0iTTI1IDE1TDE1IDI1TDM1IDI1TDI1IDE1WiIgZmlsbD0iIzAwMDAwMCIvPjwvc3ZnPg==" alt="Plane">
                <div class="shop-item-name">Plane - £1 (Propeller spins)</div>
                <div id="paypal-plane-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZWxsaXBzZSBjeD0iMjUiIGN5PSIyNSIgcng9IjIwIiByeT0iMTAiIGZpbGw9IiNGRkZGRkYiLz48ZWxsaXBzZSBjeD0iMjUiIGN5PSIxNSIgcng9IjE1IiByeT0iOCIgZmlsbD0iI0FBQUFBQSIvPjwvc3ZnPg==" alt="UFO">
                <div class="shop-item-name">UFO - £1 (Lights pulse)</div>
                <div id="paypal-ufo-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjRkZGRkZGIi8+PHBhdGggZD0iTTIwIDQwVjQ1SDMwVjQwSDIwWiIgZmlsbD0iI0ZGNDUwMCIvPjwvc3ZnPg==" alt="Spaceship">
                <div class="shop-item-name">Spaceship - £1 (Flame flickers)</div>
                <div id="paypal-spaceship-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB4PSIxMCIgeT0iMTUiIHdpZHRoPSI0MCIgaGVpZ2h0PSIxNSIgZmlsbD0iIzY2NjYzMyIvPjxwYXRoIGQ9Ik0yMCAxME0zMCAzNSIgZmlsbD0iIzMzMzMzMyIvPjwvc3ZnPg==" alt="Tank">
                <div class="shop-item-name">Tank - £1 (Turret sways)</div>
                <div id="paypal-tank-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjRkZGRkZGIi8+PHBhdGggZD0iTTIwIDEwTDMwIDIwTDE1IDI1TDIwIDEwWiIgZmlsbD0iI0ZGNDUwMCIvPjwvc3ZnPg==" alt="Dragon">
                <div class="shop-item-name">Dragon - £1 (Wings flap)</div>
                <div id="paypal-dragon-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB4PSIxMCIgeT0iMTAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgZmlsbD0iI0FBQUFBQSIvPjxjaXJjbGUgY3g9IjI1IiBjeT0iMTUiIHI9IjEwIiBmaWxsPSIjRkYwMDAwIi8+PC9zdmc+" alt="Cruiser">
                <div class="shop-item-name">Cruiser - £1 (Tough armor)</div>
                <div id="paypal-cruiser-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjNjY2NjY2Ii8+PHJlY3QgeD0iMjAiIHk9IjMwIiB3aWR0aD0iMTAiIGhlaWdodD0iMTAiIGZpbGw9IiMwMDAwMDAiLz48L3N2Zz4=" alt="Bomber">
                <div class="shop-item-name">Bomber - £1 (Drops bombs)</div>
                <div id="paypal-bomber-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgNDAiIGZpbGw9IiM4QjQ1MTMiLz48cGF0aCBkPSJNMTAgMzBMMzAgNDBMMjAgMjVMMTAgMzBaIiBmaWxsPSIjRkZGRkZGIi8+PC9zdmc+" alt="Pirate">
                <div class="shop-item-name">Pirate - £1 (Treasure glow)</div>
                <div id="paypal-pirate-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjMDBGRjAwIi8+PC9zdmc+" alt="Random">
                <div class="shop-item-name">Random AI Ship - £0.50 (Unique design)</div>
                <div id="paypal-random-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzUiIGZpbGw9IiNGRkYwMDAiLz48L3N2Zz4=" alt="Speed Boost">
                <div class="shop-item-name">Speed Boost - £2 (Doubles speed)</div>
                <div id="paypal-speedboost-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIyNSIgY3k9IjI1IiByPSIyMCIgZmlsbD0iIzAwRkYwMCIvPjwvc3ZnPg==" alt="Shield Pack">
                <div class="shop-item-name">Shield Pack - £3 (Doubles shield)</div>
                <div id="paypal-shieldpack-container" class="paypal-buttons-container"></div>
            </div>
        </div>
        <button id="back-btn" onclick="backToMenuFromShop()">Back</button>
    </div>
    <div id="debug-menu">
        <div id="logo">Debug Menu</div>
        <button class="debug-btn" onclick="debugAddScore(1000)">Add 1000 Score</button>
        <button class="debug-btn" onclick="debugAddScore(10000)">Add 10000 Score</button>
        <button class="debug-btn" onclick="debugNextLevel()">Next Level</button>
        <button class="debug-btn" onclick="debugSpawnUpgrade()">Spawn Random Upgrade</button>
        <button class="debug-btn" onclick="debugToggleInvincibility()">Toggle Invincibility</button>
        <button class="debug-btn" onclick="debugResetGame()">Reset Game</button>
        <button class="debug-btn" onclick="debugMaxBullets()">Max Bullets</button>
        <button class="debug-btn" onclick="debugMaxSpeed()">Max Speed</button>
        <button class="debug-btn" onclick="debugInfiniteShield()">Infinite Shield</button>
        <button class="debug-btn" onclick="debugKillAllPacmen()">Kill All Pacmen</button>
        <button class="debug-btn" onclick="debugSpawnGhosts(5)">Spawn 5 Ghosts</button>
        <button class="debug-btn" onclick="debugIncreaseFireRate()">Increase Fire Rate</button>
        <button class="debug-btn" onclick="debugUnlockAllShips()">Unlock All Ships</button>
        <button class="debug-btn" onclick="debugDoubleSize()">Double Player Size</button>
        <button class="debug-btn" onclick="debugHalfSize()">Half Player Size</button>
        <button class="debug-btn" onclick="debugInstantLevel10()">Jump to Level 10</button>
        <button class="debug-btn" onclick="debugSlowEnemies()">Slow Enemies</button>
        <button class="debug-btn" onclick="debugFastEnemies()">Fast Enemies</button>
        <button class="debug-btn" onclick="debugExtraLives(3)">Add 3 Lives</button>
        <button class="debug-btn" onclick="debugUnlockAchievements()">Unlock All Achievements</button>
        <button class="debug-btn" onclick="debugAddCoins(1000)">Add 1000 Coins</button>
        <div style="color: #FFFF00; font-size: 14px; margin: 10px;">
            <strong>Redeem Codes:</strong><br>
            - "philo debug" - Unlock Debug Menu<br>
            - "gekyume" - Unlock Premium Features<br>
            - "easteregg" - Unlock Secret Ship<br>
            - "5ship" - Get 5 Free AI Ships<br>
            - "5fonts" - Unlock Premium Fonts<br>
            - "5themes" - Unlock Custom Themes<br>
            - "5games" - Unlock All Game Modes
        </div>
        <div style="color: #FFFF00; font-size: 14px; margin: 10px;">
            <strong>Edit Prices (£):</strong><br>
            <label>Premium: <input type="number" id="price-premium" class="price-input" step="0.01" min="0"></label><br>
            <label>Ship (e.g., Car): <input type="number" id="price-ship" class="price-input" step="0.01" min="0"></label><br>
            <label>Random AI Ship: <input type="number" id="price-random" class="price-input" step="0.01" min="0"></label><br>
            <label>Speed Boost: <input type="number" id="price-speedboost" class="price-input" step="0.01" min="0"></label><br>
            <label>Shield Pack: <input type="number" id="price-shieldpack" class="price-input" step="0.01" min="0"></label><br>
            <button id="save-prices-btn" onclick="savePrices()">Save Prices</button>
        </div>
        <button id="back-btn" onclick="toggleDebugMenu()">Collapse</button>
    </div>
    <div id="tutorial-menu">
        <div id="logo">Tutorial</div>
        <div id="tutorial-content" style="color: #FFFF00; font-size: 18px;"></div>
        <button id="back-btn" onclick="backToMenuFromTutorial()">Back</button>
    </div>
    <div id="score">Score: 0</div>
    <div id="level">Level: 1</div>
    <div id="coins">Coins: 0</div>
    <div id="control-bar">
        <button id="pause-resume-btn" onclick="pauseGame()">⏸️</button>
    </div>
    <button id="sound-btn" onclick="toggleMute()">🔊</button>
    <button id="debug-toggle-btn" onclick="toggleDebugMenu()">🐞</button>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div id="joystick">
        <div id="joystick-nub"></div>
    </div>
    <button id="shoot-btn"></button>
    <div id="messageDisplay"></div>

    <script>
        // DOM Elements
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('score');
        const levelDisplay = document.getElementById('level');
        const coinsDisplay = document.getElementById('coins');
        const joystick = document.getElementById('joystick');
        const joystickNub = document.getElementById('joystick-nub');
        const shootBtn = document.getElementById('shoot-btn');
        const soundBtn = document.getElementById('sound-btn');
        const debugToggleBtn = document.getElementById('debug-toggle-btn');
        const pauseResumeBtn = document.getElementById('pause-resume-btn');
        const menu = document.getElementById('menu');
        const settingsMenu = document.getElementById('settings-menu');
        const gameOverMenu = document.getElementById('game-over-menu');
        const pauseMenu = document.getElementById('pause-menu');
        const achievementsMenu = document.getElementById('achievements-menu');
        const shopMenu = document.getElementById('shop-menu');
        const debugMenu = document.getElementById('debug-menu');
        const tutorialMenu = document.getElementById('tutorial-menu');
        const finalScore = document.getElementById('final-score');
        const leaderboardMain = document.getElementById('leaderboard-main');
        const leaderboardGO = document.getElementById('leaderboard-go');
        const themeSelect = document.getElementById('theme-select');
        const shipSelect = document.getElementById('ship-select');
        const pauseShipSelect = document.getElementById('pause-ship-select');
        const bulletLetterInput = document.getElementById('bullet-letter-input');
        const pauseBulletLetterInput = document.getElementById('pause-bullet-letter-input');
        const gameModeSelect = document.getElementById('game-mode-select');
        const bgImageInput = document.getElementById('bg-image-input');
        const bgMusicInput = document.getElementById('bg-music-input');
        const gameVolume = document.getElementById('game-volume');
        const musicVolume = document.getElementById('music-volume');
        const musicSelect = document.getElementById('music-select');
        const playerNameInput = document.getElementById('player-name');
        const customThemeDiv = document.getElementById('custom-theme');
        const codeInput = document.getElementById('code-input');
        const aiEnemiesCheckbox = document.getElementById('ai-enemies');
        const fontSelect = document.getElementById('font-select');
        const shipColorPicker = document.getElementById('ship-color');

        // Canvas setup
        canvas.width = Math.min(800, window.innerWidth - 20);
        canvas.height = Math.min(600, window.innerHeight - 20);

        // Player object
        const player = {
            x: canvas.width / 2,
            y: canvas.height - 60,
            size: 40,
            speed: 5,
            dx: 0,
            dy: 0,
            shootCooldown: 0,
            bulletSpeed: 10,
            fireRate: 20,
            bulletCount: 1,
            shipLevel: 0,
            shipType: 'default',
            bulletLetter: 'B',
            frameCount: 0,
            wheelAngle: 0,
            propellerAngle: 0,
            lightAngle: 0,
            flameOffset: 0,
            flapAngle: 0,
            shield: 0,
            lives: 1,
            speedBoost: false,
            shieldPack: false,
            coins: 0,
            shipColor: '#FFFF00',
            bombCooldown: 0,
            radarActive: false
        };

        // Game state
        let bullets = [];
        let pacmen = [];
        let ghosts = [];
        let backgroundStars = [];
        let upgrades = [];
        let explosions = [];
        let bosses = [];
        let score = 0;
        let level = 1;
        let coins = 0;
        let gameOver = false;
        let isPaused = false;
        let moveTouchId = null;
        let isShooting = false;
        let ghostSpawnTimer = 0;
        let audioCtx = null;
        let isMuted = false;
        let backgroundMusic = null;
        let customBgImage = null;
        let gameVolumeLevel = 0.5;
        let musicVolumeLevel = 0.5;
        let leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];
        let customSounds = { waka: null, death: null, shoot: null, enemyHit: null, upgrade: null, bomb: null };
        let isPremium = localStorage.getItem('isPremium') === 'true';
        let ownedShips = JSON.parse(localStorage.getItem('ownedShips')) || ['default', 'scout', 'ranger', 'blaster'];
        let achievements = JSON.parse(localStorage.getItem('achievements')) || {
            pacmanSlayer: { count: 0, unlocked: false, name: 'Pac-Man Slayer', desc: 'Destroy 50 Pac-Men' },
            ghostHunter: { count: 0, unlocked: false, name: 'Ghost Hunter', desc: 'Collect 20 Ghosts' },
            levelMaster: { count: 0, unlocked: false, name: 'Level Master', desc: 'Reach Level 10' },
            coinCollector: { count: 0, unlocked: false, name: 'Coin Collector', desc: 'Earn 1000 Coins' },
            bossBuster: { count: 0, unlocked: false, name: 'Boss Buster', desc: 'Defeat 5 Bosses' }
        };
        let isDebugMode = false;
        let isInvincible = false;
        let useAIEnemies = false;
        let gameMode = 'classic';
        let challengeScore = 0;

        // Pricing
        const defaultPrices = {
            premium: 15.00,
            ship: 1.00,
            random: 0.50,
            speedboost: 2.00,
            shieldpack: 3.00
        };
        let prices = JSON.parse(localStorage.getItem('prices')) || { ...defaultPrices };

        // Themes
        const themes = {
            default: { playerColor: '#FFFF00', pacmanColor: '#FFFF00', ghostColor: '#FF0000', bulletColor: '#FF00FF', bgColor: '#000033', borderColor: '#00FFFF', buttonColor: '#00FFFF', menuColor: '#000000', textColor: '#FFFF00' },
            retro: { playerColor: '#00FF00', pacmanColor: '#FFFF00', ghostColor: '#FF00FF', bulletColor: '#00FFFF', bgColor: '#000000', borderColor: '#00FF00', buttonColor: '#00FF00', menuColor: '#000000', textColor: '#FFFF00' },
            neon: { playerColor: '#FF00FF', pacmanColor: '#00FFFF', ghostColor: '#FF0000', bulletColor: '#FFFF00', bgColor: '#000022', borderColor: '#FF00FF', buttonColor: '#FF00FF', menuColor: '#000022', textColor: '#00FFFF' },
            solar: { playerColor: '#FF4500', pacmanColor: '#FFD700', ghostColor: '#FF8C00', bulletColor: '#FF00FF', bgColor: '#1A0000', borderColor: '#FFA500', buttonColor: '#FFA500', menuColor: '#1A0000', textColor: '#FFD700' },
            cosmic: { playerColor: '#00CED1', pacmanColor: '#FFFFFF', ghostColor: '#9400D3', bulletColor: '#00FFFF', bgColor: '#000011', borderColor: '#00CED1', buttonColor: '#00CED1', menuColor: '#000011', textColor: '#FFFFFF' },
            galaxy: { playerColor: '#8A2BE2', pacmanColor: '#DDA0DD', ghostColor: '#FF1493', bulletColor: '#FF00FF', bgColor: '#0A001A', borderColor: '#8A2BE2', buttonColor: '#8A2BE2', menuColor: '#0A001A', textColor: '#DDA0DD' },
            cyber: { playerColor: '#00FF7F', pacmanColor: '#7FFF00', ghostColor: '#FF00FF', bulletColor: '#FFFF00', bgColor: '#001100', borderColor: '#00FF7F', buttonColor: '#00FF7F', menuColor: '#001100', textColor: '#7FFF00' },
            dark: { playerColor: '#696969', pacmanColor: '#A9A9A9', ghostColor: '#FF4500', bulletColor: '#00FFFF', bgColor: '#1C2526', borderColor: '#696969', buttonColor: '#696969', menuColor: '#1C2526', textColor: '#A9A9A9' },
            steampunk: { playerColor: '#8B4513', pacmanColor: '#DAA520', ghostColor: '#CD5C5C', bulletColor: '#FFD700', bgColor: '#2F1F0F', borderColor: '#8B4513', buttonColor: '#DAA520', menuColor: '#2F1F0F', textColor: '#FFD700' },
            cyberpunk: { playerColor: '#00FFFF', pacmanColor: '#FF00FF', ghostColor: '#9400D3', bulletColor: '#FFFF00', bgColor: '#0D1A26', borderColor: '#00FFFF', buttonColor: '#FF00FF', menuColor: '#0D1A26', textColor: '#FFFF00' },
            arcade: { playerColor: '#FF0000', pacmanColor: '#FFFF00', ghostColor: '#00FF00', bulletColor: '#0000FF', bgColor: '#000000', borderColor: '#FF0000', buttonColor: '#00FF00', menuColor: '#000000', textColor: '#FFFFFF' },
            futuristic: { playerColor: '#00CCFF', pacmanColor: '#FFFFFF', ghostColor: '#FF00CC', bulletColor: '#66FF66', bgColor: '#001933', borderColor: '#00CCFF', buttonColor: '#66FF66', menuColor: '#001933', textColor: '#FFFFFF' }
        };

        let theme = themes.default;
        const baseShips = ['default', 'car', 'plane', 'ufo', 'spaceship', 'tank', 'dragon', 'cruiser', 'bomber', 'pirate', 'scout', 'ranger', 'blaster'];
        const shipIcons = {
            default: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMTVMNDAgMjVMMjUgMzBMMTEgMTlaIiBmaWxsPSIjRkZGRkZGIi8+PGNpcmNsZSBjeD0iMjUiIGN5PSIxOCIgcj0iNSIgZmlsbD0iI0ZGRkZGRiIvPjxyZWN0IHg9IjIwIiB5PSIyOCIgd2lkdGg9IjEwIiBoZWlnaHQ9IjMiIGZpbGw9IiNGRjQ1MDAiLz48L3N2Zz4=',
            car: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMTBIMzBWMzBIMTBWMTBaIiBmaWxsPSIjRkZGRkZGIi8+PHBhdGggZD0iTTIwIDMwVjQwTTYwIDQwSDQwVjMwSDQwWiIgZmlsbD0iIzAwMDAwMCIvPjwvc3ZnPg==',
            plane: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjQUFBQUFBIi8+PHBhdGggZD0iTTI1IDE1TDE1IDI1TDM1IDI1TDI1IDE1WiIgZmlsbD0iIzAwMDAwMCIvPjwvc3ZnPg==',
            ufo: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZWxsaXBzZSBjeD0iMjUiIGN5PSIyNSIgcng9IjIwIiByeT0iMTAiIGZpbGw9IiNGRkZGRkYiLz48ZWxsaXBzZSBjeD0iMjUiIGN5PSIxNSIgcng9IjE1IiByeT0iOCIgZmlsbD0iI0FBQUFBQSIvPjwvc3ZnPg==',
            spaceship: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjRkZGRkZGIi8+PHBhdGggZD0iTTIwIDQwVjQ1SDMwVjQwSDIwWiIgZmlsbD0iI0ZGNDUwMCIvPjwvc3ZnPg==',
            tank: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB4PSIxMCIgeT0iMTUiIHdpZHRoPSI0MCIgaGVpZ2h0PSIxNSIgZmlsbD0iIzY2NjYzMyIvPjxwYXRoIGQ9Ik0yMCAxME0zMCAzNSIgZmlsbD0iIzMzMzMzMyIvPjwvc3ZnPg==',
            dragon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjRkZGRkZGIi8+PHBhdGggZD0iTTIwIDEwTDMwIDIwTDE1IDI1TDIwIDEwWiIgZmlsbD0iI0ZGNDUwMCIvPjwvc3ZnPg==',
            cruiser: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB4PSIxMCIgeT0iMTAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgZmlsbD0iI0FBQUFBQSIvPjxjaXJjbGUgY3g9IjI1IiBjeT0iMTUiIHI9IjEwIiBmaWxsPSIjRkYwMDAwIi8+PC9zdmc+',
            bomber: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjNjY2NjY2Ii8+PHJlY3QgeD0iMjAiIHk9IjMwIiB3aWR0aD0iMTAiIGhlaWdodD0iMTAiIGZpbGw9IiMwMDAwMDAiLz48L3N2Zz4=',
            pirate: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgNDAiIGZpbGw9IiM4QjQ1MTMiLz48cGF0aCBkPSJNMTAgMzBMMzAgNDBMMjAgMjVMMTAgMzBaIiBmaWxsPSIjRkZGRkZGIi8+PC9zdmc+',
            scout: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjMDBGRjAwIi8+PC9zdmc+',
            ranger: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTUgMjVMMzUgMzVMMjUgNDBMMTUgMjVaIiBmaWxsPSIjRkYwMEZGIi8+PHJlY3QgeD0iMjAiIHk9IjM1IiB3aWR0aD0iMTAiIGhlaWdodD0iNSIgZmlsbD0iI0ZGMDBGRiIvPjwvc3ZnPg==',
            blaster: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIyNSIgY3k9IjI1IiByPSIyMCIgZmlsbD0iI0ZGRkZGRiIvPjxjaXJjbGUgY3g9IjI1IiBjeT0iMTUiIHI9IjEwIiBmaWxsPSIjMDAwMDAwIi8+PC9zdmc+'
        };
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const achievementRequirements = {
            pacmanSlayer: 50,
            ghostHunter: 20,
            levelMaster: 10,
            coinCollector: 1000,
            bossBuster: 5
        };

        // Audio initialization
        function initAudioContext() {
            try {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('AudioContext initialized');
                }
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume().then(() => console.log('AudioContext resumed'));
                }
            } catch (err) {
                console.error('AudioContext initialization failed:', err);
                audioCtx = null; // Fallback to no audio
                showMessage('Audio unavailable; continuing without sound.');
            }
        }

        // Utility functions
        function showMessage(message) {
            const messageDiv = document.getElementById('messageDisplay');
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            console.log('Message displayed:', message);
            setTimeout(() => messageDiv.style.display = 'none', 3000);
        }

        function generateUniqueShipName() {
            const prefixes = ['Aero', 'Cosmo', 'Galactic', 'Nebula', 'Stellar', 'Quantum', 'Orbit', 'Nova', 'Astro', 'Lunar'];
            const suffixes = ['Blaster', 'Cruiser', 'Fighter', 'Voyager', 'Phantom', 'Raptor', 'Drift', 'Pulse', 'Scout', 'Xeno'];
            const randomNum = Math.floor(Math.random() * 1000);
            return `${prefixes[Math.floor(Math.random() * prefixes.length)]}${suffixes[Math.floor(Math.random() * suffixes.length)]}${randomNum}`;
        }

        function updateShipSelect(selectElement) {
            selectElement.innerHTML = '';
            ownedShips.forEach(ship => {
                const option = document.createElement('option');
                option.value = ship;
                option.innerHTML = `<span class="ship-option"><img src="${shipIcons[ship] || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjRkZGRkZGIi8+PC9zdmc+'}"> ${ship}</span>`;
                if (ship === player.shipType) option.selected = true;
                selectElement.appendChild(option);
            });
            if (isPremium) {
                baseShips.forEach(ship => {
                    if (!ownedShips.includes(ship)) {
                        const option = document.createElement('option');
                        option.value = ship;
                        option.innerHTML = `<span class="ship-option"><img src="${shipIcons[ship]}"> ${ship}</span>`;
                        selectElement.appendChild(option);
                    }
                });
            }
        }

        // Settings management
        function loadSettings() {
            console.log('Loading settings...');
            try {
                const savedImage = localStorage.getItem('customBgImage') || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAQSURBVHgBAW/5DwEBAQAGAAAA/gD3YdJDAgAAAABJRU5ErkJggg==';
                const savedMusic = localStorage.getItem('customBgMusic') || musicSelect.value;
                const savedTheme = localStorage.getItem('theme');
                const savedShip = localStorage.getItem('shipType');
                const savedBulletLetter = localStorage.getItem('bulletLetter');
                const savedGameVolume = localStorage.getItem('gameVolume');
                const savedMusicVolume = localStorage.getItem('musicVolume');
                const savedCustomTheme = JSON.parse(localStorage.getItem('customTheme'));
                const savedSounds = JSON.parse(localStorage.getItem('customSounds')) || {};
                const savedAIEnemies = localStorage.getItem('useAIEnemies') === 'true';
                const savedFont = localStorage.getItem('font');
                const savedSpeedBoost = localStorage.getItem('speedBoost') === 'true';
                const savedShieldPack = localStorage.getItem('shieldPack') === 'true';
                const savedCoins = parseInt(localStorage.getItem('playerCoins')) || 0;
                const savedShipColor = localStorage.getItem('shipColor') || '#FFFF00';

                if (isPremium) {
                    bgImageInput.disabled = false;
                    bgMusicInput.disabled = false;
                    document.getElementById('premium-options').style.display = 'block';
                    player.fireRate = 15;
                    player.lives = 3;
                    if (savedSpeedBoost) player.speedBoost = true;
                    if (savedShieldPack) player.shieldPack = true;
                }

                customBgImage = new Image();
                customBgImage.src = savedImage;
                customBgImage.onload = () => {
                    console.log('Background image loaded');
                    drawBackground();
                    document.body.style.backgroundImage = `url(${customBgImage.src})`;
                    document.body.style.backgroundSize = 'cover';
                };
                customBgImage.onerror = () => {
                    console.error('Background image load failed');
                    customBgImage = null;
                };

                backgroundMusic = new Audio(savedMusic);
                backgroundMusic.loop = true;
                backgroundMusic.volume = isMuted ? 0 : musicVolumeLevel;
                backgroundMusic.addEventListener('canplay', () => {
                    console.log('Background music ready');
                    if (!isMuted) backgroundMusic.play().catch(err => console.error('Music play failed:', err));
                });
                backgroundMusic.onerror = () => {
                    console.error('Background music load failed');
                    backgroundMusic = null;
                };

                if (savedTheme) {
                    themeSelect.value = savedTheme;
                    if (savedTheme === 'custom' && savedCustomTheme) {
                        themes.custom = savedCustomTheme;
                        document.getElementById('player-color').value = savedCustomTheme.playerColor;
                        document.getElementById('pacman-color').value = savedCustomTheme.pacmanColor;
                        document.getElementById('ghost-color').value = savedCustomTheme.ghostColor;
                        document.getElementById('bullet-color').value = savedCustomTheme.bulletColor;
                        document.getElementById('bg-color').value = savedCustomTheme.bgColor;
                        document.getElementById('border-color').value = savedCustomTheme.borderColor;
                        document.getElementById('button-color').value = savedCustomTheme.buttonColor;
                        document.getElementById('menu-color').value = savedCustomTheme.menuColor;
                        document.getElementById('text-color').value = savedCustomTheme.textColor;
                    }
                }
                if (savedShip && ownedShips.includes(savedShip)) player.shipType = savedShip;
                if (savedBulletLetter) {
                    player.bulletLetter = savedBulletLetter;
                    bulletLetterInput.value = savedBulletLetter;
                    pauseBulletLetterInput.value = savedBulletLetter;
                }
                if (savedGameVolume) {
                    gameVolumeLevel = parseFloat(savedGameVolume);
                    gameVolume.value = gameVolumeLevel;
                }
                if (savedMusicVolume) {
                    musicVolumeLevel = parseFloat(savedMusicVolume);
                    musicVolume.value = musicVolumeLevel;
                    if (backgroundMusic) backgroundMusic.volume = isMuted ? 0 : musicVolumeLevel;
                }
                for (let sound in savedSounds) {
                    if (savedSounds[sound]) customSounds[sound] = new Audio(savedSounds[sound]);
                }
                if (isPremium && savedAIEnemies) {
                    useAIEnemies = true;
                    aiEnemiesCheckbox.checked = true;
                }
                if (isPremium && savedFont) {
                    fontSelect.value = savedFont;
                    changeFont();
                }
                player.coins = savedCoins;
                player.shipColor = savedShipColor;
                shipColorPicker.value = savedShipColor;
                coinsDisplay.textContent = `Coins: ${player.coins}`;
                applyTheme();
                updateLeaderboardDisplay();
                updateShipSelect(shipSelect);
                updateShipSelect(pauseShipSelect);
                checkDailyReward();
                updatePriceInputs();
                console.log('Settings loaded successfully');
            } catch (err) {
                console.error('Settings load failed:', err);
                showMessage('Error loading settings. Using defaults.');
            }
        }

        function updatePriceInputs() {
            document.getElementById('price-premium').value = prices.premium.toFixed(2);
            document.getElementById('price-ship').value = prices.ship.toFixed(2);
            document.getElementById('price-random').value = prices.random.toFixed(2);
            document.getElementById('price-speedboost').value = prices.speedboost.toFixed(2);
            document.getElementById('price-shieldpack').value = prices.shieldpack.toFixed(2);
        }

        function savePrices() {
            prices.premium = parseFloat(document.getElementById('price-premium').value) || defaultPrices.premium;
            prices.ship = parseFloat(document.getElementById('price-ship').value) || defaultPrices.ship;
            prices.random = parseFloat(document.getElementById('price-random').value) || defaultPrices.random;
            prices.speedboost = parseFloat(document.getElementById('price-speedboost').value) || defaultPrices.speedboost;
            prices.shieldpack = parseFloat(document.getElementById('price-shieldpack').value) || defaultPrices.shieldpack;
            localStorage.setItem('prices', JSON.stringify(prices));
            initPayPalButtons();
            showMessage('Prices saved successfully!');
        }

        function applyTheme() {
            console.log('Applying theme:', themeSelect.value);
            theme = themes[themeSelect.value];
            canvas.style.borderColor = theme.borderColor;
            const buttons = document.querySelectorAll('button:not(#sound-btn):not(#shoot-btn):not(#pause-resume-btn):not(#debug-toggle-btn)');
            buttons.forEach(btn => btn.style.background = `linear-gradient(45deg, ${theme.buttonColor}, #00baba)`);
            shootBtn.style.background = `rgba(${parseInt(theme.buttonColor.slice(1,3), 16)}, ${parseInt(theme.buttonColor.slice(3,5), 16)}, ${parseInt(theme.buttonColor.slice(5,7), 16)}, 0.5)`;
            menu.style.background = `linear-gradient(135deg, rgba(${parseInt(theme.menuColor.slice(1,3), 16)}, ${parseInt(theme.menuColor.slice(3,5), 16)}, ${parseInt(theme.menuColor.slice(5,7), 16)}, 0.9), rgba(0, 0, 0, 0.8))`;
            settingsMenu.style.background = menu.style.background;
            gameOverMenu.style.background = `rgba(${parseInt(theme.menuColor.slice(1,3), 16)}, ${parseInt(theme.menuColor.slice(3,5), 16)}, ${parseInt(theme.menuColor.slice(5,7), 16)}, 0.8)`;
            pauseMenu.style.background = gameOverMenu.style.background;
            achievementsMenu.style.background = gameOverMenu.style.background;
            shopMenu.style.background = gameOverMenu.style.background;
            debugMenu.style.background = `rgba(${parseInt(theme.menuColor.slice(1,3), 16)}, ${parseInt(theme.menuColor.slice(3,5), 16)}, ${parseInt(theme.menuColor.slice(5,7), 16)}, 0.5)`;
            tutorialMenu.style.background = gameOverMenu.style.background;
            document.querySelectorAll('#menu, #settings-menu, #game-over-menu, #pause-menu, #achievements-menu, #shop-menu, #debug-menu, #tutorial-menu, #score, #level, #coins, #final-score, #leaderboard, label, #made-by, .shop-item-name').forEach(el => {
                el.style.color = theme.textColor;
                el.style.fontFamily = fontSelect.value || 'Orbitron';
            });
            customThemeDiv.style.display = themeSelect.value === 'custom' ? 'block' : 'none';
        }

        // Event handlers
        function changeTheme() {
            applyTheme();
        }

        function changeShip() {
            if (ownedShips.includes(shipSelect.value) || isPremium) {
                player.shipType = shipSelect.value;
                localStorage.setItem('shipType', player.shipType);
                pauseShipSelect.value = player.shipType;
            } else {
                showMessage('You must own this ship or be a premium user to use it!');
                shipSelect.value = player.shipType;
            }
        }

        function changeShipFromPause() {
            if (ownedShips.includes(pauseShipSelect.value) || isPremium) {
                player.shipType = pauseShipSelect.value;
                localStorage.setItem('shipType', player.shipType);
                shipSelect.value = player.shipType;
            } else {
                showMessage('You must own this ship or be a premium user to use it!');
                pauseShipSelect.value = player.shipType;
            }
        }

        function updateBulletLetter() {
            player.bulletLetter = bulletLetterInput.value.toUpperCase() ||             'B';
            localStorage.setItem('bulletLetter', player.bulletLetter);
            pauseBulletLetterInput.value = player.bulletLetter;
        }

        function updateBulletLetterFromPause() {
            player.bulletLetter = pauseBulletLetterInput.value.toUpperCase() || 'B';
            localStorage.setItem('bulletLetter', player.bulletLetter);
            bulletLetterInput.value = player.bulletLetter;
        }

        function changeGameMode() {
            gameMode = gameModeSelect.value;
            init();
            showMessage(`Game mode changed to ${gameMode}!`);
        }

        function changeMusic() {
            console.log('Changing music to:', musicSelect.value);
            if (backgroundMusic) {
                backgroundMusic.pause();
            }
            backgroundMusic = new Audio(musicSelect.value);
            backgroundMusic.loop = true;
            backgroundMusic.volume = isMuted ? 0 : musicVolumeLevel;
            backgroundMusic.addEventListener('canplay', () => {
                if (!isMuted) backgroundMusic.play().catch(err => console.error('Music play failed:', err));
            });
            localStorage.setItem('customBgMusic', musicSelect.value);
        }

        function redeemCode() {
            console.log('Redeeming code:', codeInput.value);
            const code = codeInput.value.trim().toLowerCase();
            switch (code) {
                case 'philo debug':
                    showDebugMenu();
                    codeInput.value = '';
                    break;
                case 'gekyume':
                    isPremium = true;
                    localStorage.setItem('isPremium', 'true');
                    bgImageInput.disabled = false;
                    bgMusicInput.disabled = false;
                    document.getElementById('premium-options').style.display = 'block';
                    player.fireRate = 15;
                    player.lives = 3;
                    showMessage('Premium features unlocked! Enjoy faster fire rate, extra lives, and more customization.');
                    updateShipSelect(shipSelect);
                    updateShipSelect(pauseShipSelect);
                    codeInput.value = '';
                    break;
                case 'easteregg':
                    if (!ownedShips.includes('secretShip')) {
                        ownedShips.push('secretShip');
                        localStorage.setItem('ownedShips', JSON.stringify(ownedShips));
                        updateShipSelect(shipSelect);
                        updateShipSelect(pauseShipSelect);
                        showMessage('Secret Ship unlocked! Check your ship selection.');
                    }
                    codeInput.value = '';
                    break;
                case '5ship':
                    for (let i = 0; i < 5; i++) {
                        const newShip = generateUniqueShipName();
                        if (!ownedShips.includes(newShip)) {
                            ownedShips.push(newShip);
                        }
                    }
                    localStorage.setItem('ownedShips', JSON.stringify(ownedShips));
                    updateShipSelect(shipSelect);
                    updateShipSelect(pauseShipSelect);
                    showMessage('5 unique AI-generated ships unlocked!');
                    codeInput.value = '';
                    break;
                case '5fonts':
                    isPremium = true;
                    localStorage.setItem('isPremium', 'true');
                    fontSelect.disabled = false;
                    document.getElementById('premium-options').style.display = 'block';
                    showMessage('Premium fonts unlocked! Customize your text in settings.');
                    codeInput.value = '';
                    break;
                case '5themes':
                    isPremium = true;
                    localStorage.setItem('isPremium', 'true');
                    customThemeDiv.style.display = 'block';
                    themeSelect.options[0].text = 'Custom';
                    showMessage('Custom themes unlocked! Create your own theme in settings.');
                    codeInput.value = '';
                    break;
                case '5games':
                    gameModeSelect.disabled = false;
                    showMessage('All game modes unlocked! Choose your mode in the pause menu.');
                    codeInput.value = '';
                    break;
                default:
                    showMessage('Invalid code! Please try a valid redemption code.');
            }
        }

        function toggleMute() {
            isMuted = !isMuted;
            if (isMuted) {
                if (backgroundMusic) backgroundMusic.volume = 0;
                for (let sound in customSounds) {
                    if (customSounds[sound]) customSounds[sound].volume = 0;
                }
                soundBtn.textContent = '🔇';
                soundBtn.classList.add('muted');
            } else {
                if (backgroundMusic) backgroundMusic.volume = musicVolumeLevel;
                for (let sound in customSounds) {
                    if (customSounds[sound]) customSounds[sound].volume = gameVolumeLevel;
                }
                soundBtn.textContent = '🔊';
                soundBtn.classList.remove('muted');
            }
            console.log('Mute toggled:', isMuted);
        }

        function uploadBackgroundImage() {
            if (!isPremium) {
                showMessage('Premium required to upload background images!');
                return;
            }
            const file = bgImageInput.files[0];
            if (!file) {
                showMessage('No file selected!');
                return;
            }
            const extension = file.name.split('.').pop().toLowerCase();
            if (['png', 'jpg', 'jpeg'].includes(extension)) {
                const url = URL.createObjectURL(file);
                customBgImage = new Image();
                customBgImage.src = url;
                customBgImage.onload = () => {
                    console.log('Uploaded background image loaded');
                    drawBackground();
                    document.body.style.backgroundImage = `url(${customBgImage.src})`;
                    document.body.style.backgroundSize = 'cover';
                    localStorage.setItem('customBgImage', url);
                    showMessage('Background image uploaded successfully!');
                };
                customBgImage.onerror = () => {
                    console.error('Uploaded background image failed to load');
                    customBgImage = null;
                    showMessage('Failed to load uploaded image. Using default.');
                };
            } else {
                showMessage('Please upload a valid PNG or JPG image.');
            }
        }

        function uploadBackgroundMusic() {
            if (!isPremium) {
                showMessage('Premium required to upload background music!');
                return;
            }
            const file = bgMusicInput.files[0];
            if (!file) {
                showMessage('No file selected!');
                return;
            }
            const extension = file.name.split('.').pop().toLowerCase();
            if (extension === 'mp3') {
                const url = URL.createObjectURL(file);
                if (backgroundMusic) backgroundMusic.pause();
                backgroundMusic = new Audio(url);
                backgroundMusic.loop = true;
                backgroundMusic.volume = isMuted ? 0 : musicVolumeLevel;
                backgroundMusic.addEventListener('canplay', () => {
                    if (!isMuted) backgroundMusic.play().catch(err => console.error('Uploaded music play failed:', err));
                });
                localStorage.setItem('customBgMusic', url);
                showMessage('Background music uploaded successfully!');
            } else {
                showMessage('Please upload a valid MP3 file.');
            }
        }

        function uploadSound(type) {
            const file = document.getElementById(`${type}-sound`).files[0];
            if (!file) {
                showMessage('No file selected!');
                return;
            }
            const extension = file.name.split('.').pop().toLowerCase();
            if (extension === 'mp3') {
                const url = URL.createObjectURL(file);
                customSounds[type] = new Audio(url);
                customSounds[type].volume = isMuted ? 0 : gameVolumeLevel;
                showMessage(`${type} sound uploaded successfully!`);
            } else {
                showMessage('Please upload a valid MP3 file.');
            }
        }

        function saveSettings() {
            console.log('Saving settings...');
            try {
                if (customBgImage && customBgImage.src) localStorage.setItem('customBgImage', customBgImage.src);
                if (backgroundMusic && backgroundMusic.src) localStorage.setItem('customBgMusic', backgroundMusic.src);
                localStorage.setItem('theme', themeSelect.value);
                localStorage.setItem('shipType', player.shipType);
                localStorage.setItem('bulletLetter', player.bulletLetter);
                localStorage.setItem('gameVolume', gameVolume.value);
                localStorage.setItem('musicVolume', musicVolume.value);
                localStorage.setItem('achievements', JSON.stringify(achievements));
                localStorage.setItem('ownedShips', JSON.stringify(ownedShips));
                localStorage.setItem('isPremium', isPremium);
                localStorage.setItem('useAIEnemies', useAIEnemies);
                localStorage.setItem('font', fontSelect.value);
                localStorage.setItem('speedBoost', player.speedBoost);
                localStorage.setItem('shieldPack', player.shieldPack);
                localStorage.setItem('playerCoins', player.coins);
                localStorage.setItem('shipColor', player.shipColor);
                gameVolumeLevel = parseFloat(gameVolume.value);
                musicVolumeLevel = parseFloat(musicVolume.value);
                player.shipColor = shipColorPicker.value;
                if (backgroundMusic) backgroundMusic.volume = isMuted ? 0 : musicVolumeLevel;
                if (themeSelect.value === 'custom') {
                    themes.custom = {
                        playerColor: document.getElementById('player-color').value,
                        pacmanColor: document.getElementById('pacman-color').value,
                        ghostColor: document.getElementById('ghost-color').value,
                        bulletColor: document.getElementById('bullet-color').value,
                        bgColor: document.getElementById('bg-color').value,
                        borderColor: document.getElementById('border-color').value,
                        buttonColor: document.getElementById('button-color').value,
                        menuColor: document.getElementById('menu-color').value,
                        textColor: document.getElementById('text-color').value
                    };
                    localStorage.setItem('customTheme', JSON.stringify(themes.custom));
                }
                const savedSounds = {};
                for (let sound in customSounds) {
                    if (customSounds[sound] && customSounds[sound].src) savedSounds[sound] = customSounds[sound].src;
                }
                localStorage.setItem('customSounds', JSON.stringify(savedSounds));
                applyTheme();
                showMessage('Settings saved!');
            } catch (err) {
                console.error('Error saving settings:', err);
                showMessage('Failed to save settings!');
            }
        }

        function updateLeaderboardDisplay() {
            leaderboard.sort((a, b) => b.score - a.score);
            leaderboard = leaderboard.slice(0, 5);
            leaderboardMain.innerHTML = '<strong>Local Leaderboard:</strong><br>' + leaderboard.map((entry, i) => `${i + 1}. ${entry.name}: ${entry.score}`).join('<br>');
            leaderboardGO.innerHTML = leaderboardMain.innerHTML;
        }

        function showLeaderboard(source) {
            const leaderboardDiv = source === 'main' ? leaderboardMain : leaderboardGO;
            leaderboardDiv.style.display = leaderboardDiv.style.display === 'block' ? 'none' : 'block';
            syncLeaderboard();
        }

        function showRules() {
            const rulesSection = document.getElementById('rules-section');
            leaderboardMain.style.display = 'none';
            if (rulesSection.style.display === 'block') {
                rulesSection.style.display = 'none';
            } else {
                rulesSection.style.display = 'block';
                rulesSection.innerHTML = `
                    <strong>Rules of Space Pac-Invaders:</strong><br>
                    1. <strong>Controls:</strong> Move with arrow keys (PC) or joystick (mobile). Shoot with spacebar (PC) or shoot button (mobile).<br>
                    2. <strong>Objective:</strong> Destroy Pac-Men (50 points, 10 coins) and collect ghosts (50 points, 5 coins).<br>
                    3. <strong>Lives:</strong> Avoid enemies. Non-premium: 1 life, premium: 3 lives.<br>
                    4. <strong>Levels:</strong> Clear enemies to level up. Boss every 5 levels.<br>
                    5. <strong>Modes:</strong> Classic, Endless, Survival.<br>`;
            }
        }

        function showAchievements() {
            menu.style.transform = 'translate(-50%, -50%) scale(0.9)';
            menu.style.opacity = '0';
            setTimeout(() => {
                menu.style.display = 'none';
                menu.style.transform = 'translate(-50%, -50%) scale(1)';
                menu.style.opacity = '1';
                achievementsMenu.style.display = 'block';
                achievementsMenu.style.opacity = '0';
                achievementsMenu.style.transform = 'translate(-50%, -60%) scale(0.9)';
                setTimeout(() => {
                    achievementsMenu.style.opacity = '1';
                    achievementsMenu.style.transform = 'translate(-50%, -50%) scale(1)';
                    updateAchievementsList();
                }, 10);
            }, 500);
        }

        function updateAchievementsList() {
            const achievementsList = document.getElementById('achievements-list');
            achievementsList.innerHTML = '';
            for (let achievement in achievements) {
                const { name, desc, count, unlocked } = achievements[achievement];
                const required = achievementRequirements[achievement];
                const status = unlocked ? 'Unlocked' : `Progress: ${count}/${required}`;
                const trophy = unlocked ? '🏆' : '';
                achievementsList.innerHTML += `<div>${name} - ${desc}: ${status} ${trophy}</div>`;
            }
        }

        function backToMenuFromAchievements() {
            achievementsMenu.style.transform = 'translate(-50%, -50%) scale(0.9)';
            achievementsMenu.style.opacity = '0';
            setTimeout(() => {
                achievementsMenu.style.display = 'none';
                achievementsMenu.style.transform = 'translate(-50%, -50%) scale(1)';
                achievementsMenu.style.opacity = '1';
                menu.style.display = 'block';
                menu.style.opacity = '0';
                menu.style.transform = 'translate(-50%, -60%) scale(0.9)';
                setTimeout(() => menu.style.opacity = '1', 10);
            }, 500);
        }

        function showShop() {
            menu.style.transform = 'translate(-50%, -50%) scale(0.9)';
            menu.style.opacity = '0';
            setTimeout(() => {
                menu.style.display = 'none';
                menu.style.transform = 'translate(-50%, -50%) scale(1)';
                menu.style.opacity = '1';
                shopMenu.style.display = 'block';
                shopMenu.style.opacity = '0';
                shopMenu.style.transform = 'translate(-50%, -60%) scale(0.9)';
                setTimeout(() => shopMenu.style.opacity = '1', 10);
            }, 500);
        }

        function backToMenuFromShop() {
            shopMenu.style.transform = 'translate(-50%, -50%) scale(0.9)';
            shopMenu.style.opacity = '0';
            setTimeout(() => {
                shopMenu.style.display = 'none';
                shopMenu.style.transform = 'translate(-50%, -50%) scale(1)';
                shopMenu.style.opacity = '1';
                menu.style.display = 'block';
                menu.style.opacity = '0';
                menu.style.transform = 'translate(-50%, -60%) scale(0.9)';
                setTimeout(() => menu.style.opacity = '1', 10);
            }, 500);
        }

        function showDebugMenu() {
            isDebugMode = true;
            debugToggleBtn.style.display = 'flex';
            debugMenu.style.display = 'block';
            debugMenu.style.opacity = '0';
            setTimeout(() => debugMenu.style.opacity = '1', 10);
        }

        function toggleDebugMenu() {
            if (debugMenu.style.display === 'block') {
                debugMenu.style.opacity = '0';
                setTimeout(() => debugMenu.style.display = 'none', 500);
            } else {
                debugMenu.style.display = 'block';
                debugMenu.style.opacity = '0';
                setTimeout(() => debugMenu.style.opacity = '1', 10);
            }
        }

        function showTutorial() {
            menu.style.transform = 'translate(-50%, -50%) scale(0.9)';
            menu.style.opacity = '0';
            setTimeout(() => {
                menu.style.display = 'none';
                menu.style.transform = 'translate(-50%, -50%) scale(1)';
                menu.style.opacity = '1';
                tutorialMenu.style.display = 'block';
                tutorialMenu.style.opacity = '0';
                setTimeout(() => {
                    tutorialMenu.style.opacity = '1';
                    document.getElementById('tutorial-content').innerHTML = `
                        <strong>Tutorial:</strong><br>
                        1. Move with arrow keys or joystick.<br>
                        2. Shoot Pac-Men for points.<br>
                        3. Avoid crashing into enemies!`;
                }, 10);
            }, 500);
        }

        function backToMenuFromTutorial() {
            tutorialMenu.style.transform = 'translate(-50%, -50%) scale(0.9)';
            tutorialMenu.style.opacity = '0';
            setTimeout(() => {
                tutorialMenu.style.display = 'none';
                tutorialMenu.style.transform = 'translate(-50%, -50%) scale(1)';
                tutorialMenu.style.opacity = '1';
                menu.style.display = 'block';
                menu.style.opacity = '0';
                setTimeout(() => menu.style.opacity = '1', 10);
            }, 500);
        }

        function toggleAIEnemies() {
            if (!isPremium) {
                showMessage('Premium required for AI enemies!');
                aiEnemiesCheckbox.checked = false;
                return;
            }
            useAIEnemies = aiEnemiesCheckbox.checked;
            localStorage.setItem('useAIEnemies', useAIEnemies);
            initLevel();
            showMessage(`AI Enemies ${useAIEnemies ? 'enabled' : 'disabled'}!`);
        }

        function changeFont() {
            if (!isPremium) {
                showMessage('Premium required to change font!');
                fontSelect.value = 'Orbitron';
                return;
            }
            localStorage.setItem('font', fontSelect.value);
            applyTheme();
        }

        function checkDailyReward() {
            const lastLogin = localStorage.getItem('lastLogin');
            const today = new Date().toDateString();
            if (!lastLogin || lastLogin !== today) {
                player.coins += 100;
                localStorage.setItem('playerCoins', player.coins);
                localStorage.setItem('lastLogin', today);
                coinsDisplay.textContent = `Coins: ${player.coins}`;
                showMessage('Daily reward: 100 coins!');
            }
        }

        // Sound effects
        function playSound(type) {
            if (isMuted || !audioCtx) return;
            try {
                if (customSounds[type]) {
                    customSounds[type].currentTime = 0;
                    customSounds[type].volume = gameVolumeLevel;
                    customSounds[type].play().catch(err => console.error(`Sound ${type} play failed:`, err));
                } else {
                    const osc = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();
                    osc.connect(gainNode);
                    gainNode.connect(audioCtx.destination);
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(880, audioCtx.currentTime);
                    gainNode.gain.setValueAtTime(gameVolumeLevel * 0.2, audioCtx.currentTime);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.1);
                }
            } catch (err) {
                console.error(`Error playing sound ${type}:`, err);
            }
        }

        // Game initialization
        function initBackground() {
            console.log('Initializing background...');
            backgroundStars = [];
            for (let i = 0; i < 100; i++) { // Reduced to 100 stars to lessen load
                backgroundStars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 3 + 1,
                    speed: Math.random() * 0.5 + 0.5,
                    color: '#FFFFFF'
                });
            }
        }

        function initLevel() {
            console.log('Initializing level:', level);
            pacmen = [];
            ghosts = [];
            upgrades = [];
            bosses = [];
            let pacmanCount = gameMode === 'endless' ? 5 : Math.min(level * 2, 10); // Cap at 10 to reduce load
            for (let i = 0; i < pacmanCount; i++) {
                pacmen.push({
                    x: Math.random() * (canvas.width - 40),
                    y: -40,
                    size: 40,
                    speed: 1 + level * 0.2,
                    mouthAngle: 0,
                    mouthSpeed: 0.05,
                    spinAngle: 0,
                    health: 1,
                    isAI: useAIEnemies && Math.random() < 0.5,
                    targetX: player.x,
                    targetY: player.y
                });
            }
        }

        function spawnGhost() {
            if (Math.random() < 0.02) {
                ghosts.push({
                    x: Math.random() * (canvas.width - 20),
                    y: -20,
                    size: 20,
                    speed: 2,
                    type: Math.floor(Math.random() * 4)
                });
            }
        }

        function init() {
            console.log('Initializing game...');
            score = 0;
            level = 1;
            gameOver = false;
            isPaused = false;
            player.x = canvas.width / 2;
            player.y = canvas.height - 60;
            player.dx = 0;
            player.dy = 0;
            player.shootCooldown = 0;
            player.speed = player.speedBoost ? 10 : 5;
            player.bulletSpeed = 10;
            player.fireRate = isPremium ? 15 : 20;
            player.bulletCount = 1;
            player.shipLevel = 0;
            player.frameCount = 0;
            player.shield = player.shieldPack ? 200 : 0;
            player.lives = isPremium ? 3 : 1;
            isShooting = false;
            bullets = [];
            pacmen = [];
            ghosts = [];
            upgrades = [];
            bosses = [];
            explosions = [];
            gameOverMenu.style.display = 'none';
            pauseMenu.style.display = 'none';
            achievementsMenu.style.display = 'none';
            shopMenu.style.display = 'none';
            debugMenu.style.display = 'none';
            tutorialMenu.style.display = 'none';
            leaderboardMain.style.display = 'none';
            leaderboardGO.style.display = 'none';
            document.getElementById('control-bar').style.display = 'flex';
            if (isDebugMode) debugToggleBtn.style.display = 'flex';
            initLevel();
            initBackground();
            applyTheme();
            scoreDisplay.textContent = `Score: ${score}`;
            levelDisplay.textContent = `Level: ${level}`;
            coinsDisplay.textContent = `Coins: ${player.coins}`;
        }

        function startGame() {
            if (!playerNameInput.value.trim()) {
                showMessage('Please enter your name!');
                return;
            }
            console.log('Starting game...');
            menu.style.transform = 'translate(-50%, -50%) scale(0.9)';
            menu.style.opacity = '0';
            setTimeout(() => {
                menu.style.display = 'none';
                menu.style.transform = 'translate(-50%, -50%) scale(1)';
                menu.style.opacity = '1';
                canvas.style.display = 'block';
                scoreDisplay.style.display = 'block';
                levelDisplay.style.display = 'block';
                coinsDisplay.style.display = 'block';
                document.getElementById('control-bar').style.display = 'flex';
                if (isMobile) {
                    joystick.style.display = 'block';
                    shootBtn.style.display = 'block';
                }
                initAudioContext();
                init();
                setTimeout(() => {
                    try {
                        gameLoop();
                    } catch (err) {
                        console.error('Game loop failed to start:', err);
                        crashRecovery('Game failed to start');
                    }
                }, 500); // Delay to allow resources to load
            }, 500);
        }

        function restartGame() {
            gameOverMenu.style.transform = 'translate(-50%, -50%) scale(0.9)';
            gameOverMenu.style.opacity = '0';
            setTimeout(() => {
                gameOverMenu.style.display = 'none';
                gameOverMenu.style.transform = 'translate(-50%, -50%) scale(1)';
                gameOverMenu.style.opacity = '1';
                init();
                gameLoop();
            }, 300);
        }

        function showSettings() {
            menu.style.transform = 'translate(-50%, -50%) scale(0.9)';
            menu.style.opacity = '0';
            setTimeout(() => {
                menu.style.display = 'none';
                menu.style.transform = 'translate(-50%, -50%) scale(1)';
                menu.style.opacity = '1';
                settingsMenu.style.display = 'block';
                settingsMenu.style.opacity = '0';
                setTimeout(() => settingsMenu.style.opacity = '1', 10);
            }, 500);
        }

        function showSettingsFromGameOver() {
            gameOverMenu.style.transform = 'translate(-50%, -50%) scale(0.9)';
            gameOverMenu.style.opacity = '0';
            setTimeout(() => {
                gameOverMenu.style.display = 'none';
                gameOverMenu.style.transform = 'translate(-50%, -50%) scale(1)';
                gameOverMenu.style.opacity = '1';
                settingsMenu.style.display = 'block';
                settingsMenu.style.opacity = '0';
                setTimeout(() => settingsMenu.style.opacity = '1', 10);
            }, 300);
        }

        function showSettingsFromPause() {
            pauseMenu.style.transform = 'translate(-50%, -50%) scale(0.9)';
            pauseMenu.style.opacity = '0';
            setTimeout(() => {
                pauseMenu.style.display = 'none';
                pauseMenu.style.transform = 'translate(-50%, -50%) scale(1)';
                pauseMenu.style.opacity = '1';
                settingsMenu.style.display = 'block';
                settingsMenu.style.opacity = '0';
                setTimeout(() => settingsMenu.style.opacity = '1', 10);
            }, 300);
        }

        function backToMenu() {
            settingsMenu.style.transform = 'translate(-50%, -50%) scale(0.9)';
            settingsMenu.style.opacity = '0';
            setTimeout(() => {
                settingsMenu.style.display = 'none';
                settingsMenu.style.transform = 'translate(-50%, -50%) scale(1)';
                settingsMenu.style.opacity = '1';
                menu.style.display = 'block';
                menu.style.opacity = '0';
                setTimeout(() => menu.style.opacity = '1', 10);
            }, 500);
        }

        function backToMainMenu() {
            gameOverMenu.style.transform = 'translate(-50%, -50%) scale(0.9)';
            gameOverMenu.style.opacity = '0';
            setTimeout(() => {
                gameOverMenu.style.display = 'none';
                gameOverMenu.style.transform = 'translate(-50%, -50%) scale(1)';
                gameOverMenu.style.opacity = '1';
                menu.style.display = 'block';
                menu.style.opacity = '0';
                canvas.style.display = 'none';
                scoreDisplay.style.display = 'none';
                levelDisplay.style.display = 'none';
                coinsDisplay.style.display = 'none';
                joystick.style.display = 'none';
                shootBtn.style.display = 'none';
                document.getElementById('control-bar').style.display = 'none';
                leaderboard.push({ name: playerNameInput.value.trim(), score: score });
                localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
                updateLeaderboardDisplay();
                setTimeout(() => menu.style.opacity = '1', 10);
            }, 300);
        }

        function backToMainMenuFromPause() {
            pauseMenu.style.transform = 'translate(-50%, -50%) scale(0.9)';
            pauseMenu.style.opacity = '0';
            setTimeout(() => {
                pauseMenu.style.display = 'none';
                pauseMenu.style.transform = 'translate(-50%, -50%) scale(1)';
                pauseMenu.style.opacity = '1';
                menu.style.display = 'block';
                menu.style.opacity = '0';
                canvas.style.display = 'none';
                scoreDisplay.style.display = 'none';
                levelDisplay.style.display = 'none';
                coinsDisplay.style.display = 'none';
                joystick.style.display = 'none';
                shootBtn.style.display = 'none';
                document.getElementById('control-bar').style.display = 'none';
                leaderboard.push({ name: playerNameInput.value.trim(), score: score });
                localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
                updateLeaderboardDisplay();
                setTimeout(() => menu.style.opacity = '1', 10);
            }, 300);
        }

        function pauseGame() {
            if (!gameOver) {
                if (isPaused) {
                    resumeGame();
                } else {
                    isPaused = true;
                    pauseMenu.style.display = 'block';
                    pauseMenu.style.opacity = '0';
                    setTimeout(() => pauseMenu.style.opacity = '1', 10);
                    pauseResumeBtn.textContent = '▶️';
                }
            }
        }

        function resumeGame() {
            pauseMenu.style.transform = 'translate(-50%, -50%) scale(0.9)';
            pauseMenu.style.opacity = '0';
            setTimeout(() => {
                pauseMenu.style.display = 'none';
                pauseMenu.style.transform = 'translate(-50%, -50%) scale(1)';
                pauseMenu.style.opacity = '1';
                isPaused = false;
                pauseResumeBtn.textContent = '⏸️';
                gameLoop();
            }, 300);
        }

        // Crash recovery
        function crashRecovery(message) {
            gameOver = true;
            showMessage(message);
            console.error('Crash recovery triggered:', message);
            setTimeout(() => backToMainMenu(), 2000);
        }

        // Drawing functions
        function drawBackground() {
            try {
                ctx.fillStyle = theme.bgColor;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                if (customBgImage && customBgImage.complete) {
                    ctx.drawImage(customBgImage, 0, 0, canvas.width, canvas.height);
                }
                backgroundStars.forEach(star => {
                    ctx.fillStyle = star.color;
                    ctx.beginPath();
                    ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                    ctx.fill();
                    star.y += star.speed;
                    if (star.y > canvas.height) {
                        star.y = -star.size;
                        star.x = Math.random() * canvas.width;
                    }
                });
            } catch (err) {
                console.error('Error drawing background:', err);
            }
        }

        function drawPlayer() {
            try {
                ctx.save();
                ctx.translate(player.x, player.y);
                ctx.fillStyle = player.shipColor;
                ctx.beginPath();
                ctx.moveTo(0, -player.size / 2);
                ctx.lineTo(player.size / 2, player.size / 2);
                ctx.lineTo(-player.size / 2, player.size / 2);
                ctx.closePath();
                ctx.fill();
                ctx.restore();
            } catch (err) {
                console.error('Error drawing player:', err);
            }
        }

        function drawPacmen() {
            pacmen.forEach(pacman => {
                try {
                    ctx.save();
                    ctx.translate(pacman.x + pacman.size / 2, pacman.y + pacman.size / 2);
                    ctx.fillStyle = theme.pacmanColor;
                    ctx.beginPath();
                    ctx.arc(0, 0, pacman.size / 2, 0.2, Math.PI * 1.8);
                    ctx.lineTo(0, 0);
                    ctx.fill();
                    ctx.restore();
                } catch (err) {
                    console.error('Error drawing pacman:', err);
                }
            });
        }

        function drawBullets() {
            bullets.forEach(bullet => {
                try {
                    ctx.fillStyle = theme.bulletColor;
                    ctx.fillRect(bullet.x - 2, bullet.y - 5, 4, 10);
                } catch (err) {
                    console.error('Error drawing bullet:', err);
                }
            });
        }

        // Game mechanics
        function shoot() {
            if (player.shootCooldown <= 0) {
                bullets.push({ x: player.x, y: player.y - player.size / 2, speed: player.bulletSpeed });
                player.shootCooldown = player.fireRate;
                playSound('shoot');
            }
        }

        function update() {
            if (gameOver || isPaused) return;
            try {
                player.x += player.dx;
                player.y += player.dy;
                player.x = Math.max(player.size / 2, Math.min(canvas.width - player.size / 2, player.x));
                player.y = Math.max(player.size / 2, Math.min(canvas.height - player.size / 2, player.y));

                if (player.shootCooldown > 0) player.shootCooldown--;
                if (isShooting) shoot();

                bullets.forEach((bullet, bIndex) => {
                    bullet.y -= bullet.speed;
                    if (bullet.y < 0) bullets.splice(bIndex, 1);
                    pacmen.forEach((pacman, pIndex) => {
                        if (bullet.x > pacman.x && bullet.x < pacman.x + pacman.size &&
                            bullet.y > pacman.y && bullet.y < pacman.y + pacman.size) {
                            pacmen.splice(pIndex, 1);
                            bullets.splice(bIndex, 1);
                            score += 50;
                            player.coins += 10;
                            scoreDisplay.textContent = `Score: ${score}`;
                            coinsDisplay.textContent = `Coins: ${player.coins}`;
                        }
                    });
                });

                pacmen.forEach((pacman, index) => {
                    pacman.y += pacman.speed;
                    if (pacman.y > canvas.height) pacmen.splice(index, 1);
                    if (!isInvincible && Math.abs(pacman.x - player.x) < (pacman.size + player.size) / 2 &&
                        Math.abs(pacman.y - player.y) < (pacman.size + player.size) / 2) {
                        player.lives--;
                        pacmen.splice(index, 1);
                        if (player.lives <= 0) {
                            gameOver = true;
                            finalScore.textContent = `Score: ${score}`;
                            gameOverMenu.style.display = 'block';
                            gameOverMenu.style.opacity = '0';
                            setTimeout(() => gameOverMenu.style.opacity = '1', 10);
                        } else {
                            showMessage(`Lives remaining: ${player.lives}`);
                        }
                    }
                });

                if (pacmen.length === 0) {
                    level++;
                    initLevel();
                    levelDisplay.textContent = `Level: ${level}`;
                }
            } catch (err) {
                console.error('Error in update:', err);
                crashRecovery('Game crashed during update');
            }
        }

        function gameLoop() {
            if (gameOver || isPaused) return;
            try {
                console.log('Game loop iteration');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawBackground();
                drawPlayer();
                drawPacmen();
                drawBullets();
                update();
                requestAnimationFrame(gameLoop);
            } catch (err) {
                console.error('Game loop crashed:', err);
                crashRecovery('Game crashed during loop');
            }
        }

        // Event listeners
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') player.dx = -player.speed;
            if (e.key === 'ArrowRight') player.dx = player.speed;
            if (e.key === 'ArrowUp') player.dy = -player.speed;
            if (e.key === 'ArrowDown') player.dy = player.speed;
            if (e.key === ' ') isShooting = true;
            if (e.key === 'Escape' && !gameOver) pauseGame();
        });

        document.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') player.dx = 0;
            if (e.key === 'ArrowUp' || e.key === 'ArrowDown') player.dy = 0;
            if (e.key === ' ') isShooting = false;
        });

        // Debug functions (simplified)
        function debugAddScore(amount) { score += amount; scoreDisplay.textContent = `Score: ${score}`; }
        function debugNextLevel() { level++; initLevel(); levelDisplay.textContent = `Level: ${level}`; }
        function debugResetGame() { init(); }

        // PayPal integration (simplified)
        function initPayPalButtons() {
            if (typeof paypal === 'undefined') {
                console.error('PayPal SDK not loaded');
                return;
            }
            paypal.Buttons({
                createOrder: (data, actions) => actions.order.create({
                    purchase_units: [{ amount: { value: prices.premium.toFixed(2), currency_code: 'GBP' } }]
                }),
                onApprove: (data, actions) => actions.order.capture().then(details => {
                    isPremium = true;
                    localStorage.setItem('isPremium', 'true');
                    showMessage(`Thanks, ${details.payer.name.given_name}! Premium unlocked.`);
                }),
                onError: (err) => console.error('PayPal error:', err)
            }).render('#paypal-premium-container');
        }

        // Initialize game
        console.log('Initializing game on page load');
        loadSettings();
        initPayPalButtons();
    </script>
</body>
</html>
