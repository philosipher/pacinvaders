<!DOCTYPE html>
<html>
<head>
    <title>Space Pac-Invaders</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://www.paypal.com/sdk/js?client-id=AdvuOlMG6Qi_4TxZotXmrupgJTUfoNl8TH5bgrNCKNq2fPfOhZP1Ufr-ZlqZNjUBTUyrPCFRgG7sSe9y&currency=GBP"></script>
    <style>
        canvas {
            border: 1px solid #00FFFF;
            background: #000000;
            max-width: 100%;
            height: auto;
            display: none;
            touch-action: none;
        }
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: #000000;
            overflow: hidden;
            touch-action: none;
            font-family: Arial, sans-serif;
        }
        #menu, #settings-menu, #game-over-menu, #pause-menu, #achievements-menu, #shop-menu, #debug-menu, #tutorial-menu {
            text-align: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: opacity 0.5s ease;
            max-height: 80vh;
            overflow-y: auto;
            padding: 10px;
            box-sizing: border-box;
            opacity: 1;
        }
        #settings-menu, #game-over-menu, #pause-menu, #achievements-menu, #shop-menu, #debug-menu, #tutorial-menu {
            display: none;
        }
        #game-over-menu, #pause-menu, #achievements-menu, #shop-menu, #debug-menu, #tutorial-menu {
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            animation: popIn 0.3s ease-out;
        }
        #debug-menu {
            position: fixed;
            top: 60px;
            left: 10px;
            width: 300px;
            max-height: calc(100vh - 70px);
            overflow-y: auto;
            z-index: 101;
            background: rgba(0, 0, 0, 0.5);
        }
        #logo {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px #00FFFF;
            animation: bounce 2s infinite;
        }
        #made-by {
            font-size: 24px;
            margin-bottom: 20px;
        }
        #start-btn, #settings-btn, #back-btn, #save-settings-btn, #main-menu-btn, #restart-btn, #game-over-settings-btn, #leaderboard-btn, #leaderboard-go-btn, #rules-btn, #resume-btn, #pause-settings-btn, #share-btn, #redeem-code-btn, #donateBtn, #achievementsBtn, #back-to-menu-achievements, #shop-btn, .shop-item-btn, .debug-btn, #debug-toggle-btn, #tutorial-btn, #copy-score-btn, #challenge-friend-btn, #save-prices-btn {
            padding: 10px 20px;
            font-size: 20px;
            background: #00FFFF;
            color: #000000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            transition: background 0.3s, transform 0.2s;
        }
        #start-btn:hover, #settings-btn:hover, #back-btn:hover, #save-settings-btn:hover, #main-menu-btn:hover, #restart-btn:hover, #game-over-settings-btn:hover, #leaderboard-btn:hover, #leaderboard-go-btn:hover, #rules-btn:hover, #resume-btn:hover, #pause-settings-btn:hover, #share-btn:hover, #redeem-code-btn:hover, #donateBtn:hover, #achievementsBtn:hover, #back-to-menu-achievements:hover, #shop-btn:hover, .shop-item-btn:hover, .debug-btn:hover, #debug-toggle-btn:hover, #tutorial-btn:hover, #copy-score-btn:hover, #challenge-friend-btn:hover, #save-prices-btn:hover {
            background: #00baba;
            transform: scale(1.1);
        }
        #theme-select, #ship-select, #bg-image-input, #bg-music-input, #game-volume, #music-volume, .color-picker, .sound-input, #code-input, #bullet-letter-input, #font-select, #game-mode-select, #pause-ship-select, #pause-bullet-letter-input, #music-select, #challenge-score-input, .price-input {
            padding: 5px;
            font-size: 16px;
            background: #000000;
            color: #FFFF00;
            border: 1px solid #00FFFF;
            border-radius: 5px;
            margin: 5px;
        }
        #player-name {
            padding: 5px;
            font-size: 16px;
            background: #000000;
            color: #FFFF00;
            border: 1px solid #00FFFF;
            border-radius: 5px;
            margin: 10px;
        }
        label {
            display: block;
            margin: 5px 0;
        }
        #score, #level, #coins {
            font-family: inherit;
            position: absolute;
            z-index: 10;
            display: none;
        }
        #score { top: 10px; left: 10px; }
        #level { top: 10px; right: 60px; }
        #coins { top: 30px; left: 10px; }
        #leaderboard {
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 16px;
            max-height: 50vh;
            overflow-y: auto;
            position: absolute;
            z-index: 10;
        }
        #joystick {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 0, 0.2);
            border-radius: 50%;
            touch-action: none;
            display: none;
        }
        #joystick-nub {
            position: absolute;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 0, 0.5);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            top: 50%;
            left: 50%;
        }
        #shoot-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            background: rgba(0, 255, 255, 0.5);
            border-radius: 50%;
            border: none;
            touch-action: none;
            display: none;
        }
        #control-bar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 20;
            display: none;
        }
        #sound-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 50px;
            height: 50px;
            background: rgba(0, 255, 255, 0.8);
            color: #000000;
            border: 2px solid #00FFFF;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s, background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        #debug-toggle-btn {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 50px;
            height: 50px;
            background: rgba(255, 0, 0, 0.8);
            color: #FFFFFF;
            border: 2px solid #FF0000;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s, background 0.3s;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        #sound-btn:hover, #debug-toggle-btn:hover {
            background: rgba(0, 186, 186, 0.8);
            transform: scale(1.1);
        }
        #sound-btn.muted {
            background: rgba(255, 0, 0, 0.8);
        }
        #pause-resume-btn {
            width: 50px;
            height: 50px;
            background: rgba(0, 255, 255, 0.8);
            color: #000000;
            border: 2px solid #00FFFF;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s, background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #pause-resume-btn:hover {
            background: rgba(0, 186, 186, 0.8);
            transform: scale(1.1);
        }
        #messageDisplay {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #FFF;
            padding: 10px;
            border-radius: 5px;
            display: none;
            z-index: 30;
        }
        .shop-item {
            display: inline-block;
            margin: 10px;
            text-align: center;
        }
        .shop-item img {
            width: 50px;
            height: 50px;
            border: 1px solid #00FFFF;
        }
        .shop-item-name {
            color: #FFFF00;
            font-size: 16px;
            margin: 5px 0;
        }
        .paypal-buttons-container {
            margin: 10px;
            display: inline-block;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-15px); }
            60% { transform: translateY(-7px); }
        }
        @keyframes popIn {
            from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .ship-option {
            display: flex;
            align-items: center;
        }
        .ship-option img {
            width: 50px;
            height: 50px;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div id="menu" style="display: block;">
        <div id="logo">PacInvaders</div>
        <div id="made-by">Made by Philo Sipher</div>
        <input type="text" id="player-name" placeholder="Enter your name" maxlength="10">
        <button id="start-btn" onclick="startGame()">Start Game</button>
        <button id="settings-btn" onclick="showSettings()">Settings</button>
        <button id="leaderboard-btn" onclick="showLeaderboard('main')">Leaderboard</button>
        <button id="rules-btn" onclick="showRules()">Rules</button>
        <button id="achievementsBtn" onclick="showAchievements()">Achievements</button>
        <button id="donateBtn" onclick="window.open('https://www.paypal.me/kingphilosipher', '_blank')">Donate via PayPal</button>
        <button id="shop-btn" onclick="showShop()">Shop</button>
        <button id="tutorial-btn" onclick="showTutorial()">Tutorial</button>
        <br>
        <select id="ship-select" onchange="changeShip()"></select>
        <input type="text" id="bullet-letter-input" maxlength="1" placeholder="Bullet Letter" onchange="updateBulletLetter()">
        <label for="ship-select">Ship Type & Bullet</label>
        <br>
        <select id="theme-select" onchange="changeTheme()">
            <option value="default">Default</option>
            <option value="retro">Retro</option>
            <option value="neon">Neon</option>
            <option value="solar">Solar</option>
            <option value="cosmic">Cosmic</option>
            <option value="galaxy">Galaxy</option>
            <option value="cyber">Cyber</option>
            <option value="dark">Dark</option>
            <option value="steampunk">Steampunk</option>
            <option value="cyberpunk">Cyberpunk</option>
            <option value="arcade">Arcade</option>
            <option value="futuristic">Futuristic</option>
        </select>
        <div id="leaderboard-main"></div>
        <div id="rules-section" style="display: none; color: #FFFF00; font-size: 18px; margin-top: 20px;"></div>
    </div>
    <div id="settings-menu">
        <div id="logo">Settings</div>
        <input type="file" id="bg-image-input" accept="image/png,image/jpeg,image/jpg" onchange="uploadBackgroundImage()" disabled>
        <label for="bg-image-input">Upload Background Image (PNG/JPG) - Premium Only</label>
        <br>
        <input type="file" id="bg-music-input" accept="audio/mpeg,audio/mp3" onchange="uploadBackgroundMusic()" disabled>
        <label for="bg-music-input">Upload Background Music (MP3) - Premium Only</label>
        <br>
        <input type="range" id="game-volume" min="0" max="1" step="0.1" value="0.5">
        <label for="game-volume">Game Sound Volume</label>
        <br>
        <input type="range" id="music-volume" min="0" max="1" step="0.1" value="0.5">
        <label for="music-volume">Music Volume</label>
        <br>
        <select id="music-select" onchange="changeMusic()">
            <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3">Default Theme</option>
            <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3">Retro Theme</option>
            <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3">Cosmic Theme</option>
        </select>
        <label for="music-select">Background Music</label>
        <br>
        <input type="color" id="ship-color" value="#FFFF00"><label for="ship-color">Ship Color</label>
        <div id="premium-options" style="display: none;">
            <input type="checkbox" id="ai-enemies" onchange="toggleAIEnemies()">
            <label for="ai-enemies">Use AI-Generated Enemies (Premium)</label>
            <br>
            <select id="font-select" onchange="changeFont()">
                <option value="Arial">Arial</option>
                <option value="Times New Roman">Times New Roman</option>
                <option value="Courier New">Courier New</option>
                <option value="Comic Sans MS">Comic Sans MS</option>
                <option value="Impact">Impact</option>
            </select>
            <label for="font-select">Text Font (Premium)</label>
        </div>
        <div id="custom-theme" style="display: none;">
            <input type="color" id="player-color" value="#FFFF00"><label for="player-color">Player Color</label>
            <input type="color" id="pacman-color" value="#FFFF00"><label for="pacman-color">Pac-Man Color</label>
            <input type="color" id="ghost-color" value="#FF0000"><label for="ghost-color">Ghost Color</label>
            <input type="color" id="bullet-color" value="#FF00FF"><label for="bullet-color">Bullet Color</label>
            <input type="color" id="bg-color" value="#000033"><label for="bg-color">Background Color</label>
            <input type="color" id="border-color" value="#00FFFF"><label for="border-color">Border Color</label>
            <input type="color" id="button-color" value="#00FFFF"><label for="button-color">Button Color</label>
            <input type="color" id="menu-color" value="#000000"><label for="menu-color">Menu Background Color</label>
            <input type="color" id="text-color" value="#FFFF00"><label for="text-color">Text Color</label>
        </div>
        <div id="custom-sounds">
            <input type="file" id="waka-sound" accept="audio/mpeg,audio/mp3" class="sound-input" onchange="uploadSound('waka')">
            <label for="waka-sound">Waka Sound (MP3)</label>
            <input type="file" id="death-sound" accept="audio/mpeg,audio/mp3" class="sound-input" onchange="uploadSound('death')">
            <label for="death-sound">Death Sound (MP3)</label>
            <input type="file" id="shoot-sound" accept="audio/mpeg,audio/mp3" class="sound-input" onchange="uploadSound('shoot')">
            <label for="shoot-sound">Shoot Sound (MP3)</label>
            <input type="file" id="enemy-hit-sound" accept="audio/mpeg,audio/mp3" class="sound-input" onchange="uploadSound('enemyHit')">
            <label for="enemy-hit-sound">Pac-Man Hit Sound (MP3)</label>
            <input type="file" id="upgrade-sound" accept="audio/mpeg,audio/mp3" class="sound-input" onchange="uploadSound('upgrade')">
            <label for="upgrade-sound">Upgrade Sound (MP3)</label>
        </div>
        <input type="text" id="code-input" placeholder="Enter code">
        <button id="redeem-code-btn" onclick="redeemCode()">Redeem Code</button>
        <div id="paypal-premium-container" class="paypal-buttons-container"></div>
        <button id="save-settings-btn" onclick="saveSettings()">Save Settings</button>
        <button id="back-btn" onclick="backToMenu()">Back</button>
        <button onclick="window.open('https://forms.gle/example-feedback', '_blank')">Leave Feedback</button>
    </div>
    <div id="game-over-menu">
        <div id="logo">Game Over</div>
        <div id="final-score">Score: 0</div>
        <button id="main-menu-btn" onclick="backToMainMenu()">Main Menu</button>
        <button id="restart-btn" onclick="restartGame()">Restart (Spacebar on PC)</button>
        <button id="game-over-settings-btn" onclick="showSettingsFromGameOver()">Settings</button>
        <button id="leaderboard-go-btn" onclick="showLeaderboard('go')">Leaderboard</button>
        <button id="share-btn" onclick="shareScore()">Share Score</button>
        <button id="copy-score-btn" onclick="copyScore()">Copy Score</button>
        <div id="leaderboard-go"></div>
    </div>
    <div id="pause-menu">
        <div id="logo">Paused</div>
        <select id="pause-ship-select" onchange="changeShipFromPause()"></select>
        <input type="text" id="pause-bullet-letter-input" maxlength="1" placeholder="Bullet Letter" onchange="updateBulletLetterFromPause()">
        <label for="pause-ship-select">Ship Type & Bullet</label>
        <br>
        <select id="game-mode-select" onchange="changeGameMode()">
            <option value="classic">Classic</option>
            <option value="endless">Endless</option>
            <option value="survival">Survival</option>
        </select>
        <label for="game-mode-select">Game Mode</label>
        <br>
        <button id="resume-btn" onclick="resumeGame()">Resume</button>
        <button id="pause-settings-btn" onclick="showSettingsFromPause()">Settings</button>
        <button id="main-menu-btn" onclick="backToMainMenuFromPause()">Main Menu</button>
    </div>
    <div id="achievements-menu">
        <div id="logo">Achievements</div>
        <div id="achievements-list" style="color: #FFFF00; font-size: 18px;"></div>
        <button id="back-to-menu-achievements" onclick="backToMenuFromAchievements()">Back</button>
    </div>
    <div id="shop-menu">
        <div id="logo">Shop</div>
        <div id="shop-items">
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMTBIMzBWMzBIMTBWMTBaIiBmaWxsPSIjRkZGRkZGIi8+PHBhdGggZD0iTTIwIDMwVjQwTTYwIDQwSDQwVjMwSDQwWiIgZmlsbD0iIzAwMDAwMCIvPjwvc3ZnPg==" alt="Car">
                <div class="shop-item-name">Car - £1 (Wheels spin)</div>
                <div id="paypal-car-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjQUFBQUFBIi8+PHBhdGggZD0iTTI1IDE1TDE1IDI1TDM1IDI1TDI1IDE1WiIgZmlsbD0iIzAwMDAwMCIvPjwvc3ZnPg==" alt="Plane">
                <div class="shop-item-name">Plane - £1 (Propeller spins)</div>
                <div id="paypal-plane-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZWxsaXBzZSBjeD0iMjUiIGN5PSIyNSIgcng9IjIwIiByeT0iMTAiIGZpbGw9IiNGRkZGRkYiLz48ZWxsaXBzZSBjeD0iMjUiIGN5PSIxNSIgcng9IjE1IiByeT0iOCIgZmlsbD0iI0FBQUFBQSIvPjwvc3ZnPg==" alt="UFO">
                <div class="shop-item-name">UFO - £1 (Lights pulse)</div>
                <div id="paypal-ufo-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjRkZGRkZGIi8+PHBhdGggZD0iTTIwIDQwVjQ1SDMwVjQwSDIwWiIgZmlsbD0iI0ZGNDUwMCIvPjwvc3ZnPg==" alt="Spaceship">
                <div class="shop-item-name">Spaceship - £1 (Flame flickers)</div>
                <div id="paypal-spaceship-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB4PSIxMCIgeT0iMTUiIHdpZHRoPSI0MCIgaGVpZ2h0PSIxNSIgZmlsbD0iIzY2NjYzMyIvPjxwYXRoIGQ9Ik0yMCAxME0zMCAzNSIgZmlsbD0iIzMzMzMzMyIvPjwvc3ZnPg==" alt="Tank">
                <div class="shop-item-name">Tank - £1 (Turret sways)</div>
                <div id="paypal-tank-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjRkZGRkZGIi8+PHBhdGggZD0iTTIwIDEwTDMwIDIwTDE1IDI1TDIwIDEwWiIgZmlsbD0iI0ZGNDUwMCIvPjwvc3ZnPg==" alt="Dragon">
                <div class="shop-item-name">Dragon - £1 (Wings flap)</div>
                <div id="paypal-dragon-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB4PSIxMCIgeT0iMTAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgZmlsbD0iI0FBQUFBQSIvPjxjaXJjbGUgY3g9IjI1IiBjeT0iMTUiIHI9IjEwIiBmaWxsPSIjRkYwMDAwIi8+PC9zdmc+" alt="Cruiser">
                <div class="shop-item-name">Cruiser - £1 (Tough armor)</div>
                <div id="paypal-cruiser-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjNjY2NjY2Ii8+PHJlY3QgeD0iMjAiIHk9IjMwIiB3aWR0aD0iMTAiIGhlaWdodD0iMTAiIGZpbGw9IiMwMDAwMDAiLz48L3N2Zz4=" alt="Bomber">
                <div class="shop-item-name">Bomber - £1 (Drops bombs)</div>
                <div id="paypal-bomber-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgNDAiIGZpbGw9IiM4QjQ1MTMiLz48cGF0aCBkPSJNMTAgMzBMMzAgNDBMMjAgMjVMMTAgMzBaIiBmaWxsPSIjRkZGRkZGIi8+PC9zdmc+" alt="Pirate">
                <div class="shop-item-name">Pirate - £1 (Treasure glow)</div>
                <div id="paypal-pirate-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjMDBGRjAwIi8+PC9zdmc+" alt="Random">
                <div class="shop-item-name">Random AI Ship - £0.50 (Unique design)</div>
                <div id="paypal-random-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzUiIGZpbGw9IiNGRkYwMDAiLz48L3N2Zz4=" alt="Speed Boost">
                <div class="shop-item-name">Speed Boost - £2 (Doubles speed)</div>
                <div id="paypal-speedboost-container" class="paypal-buttons-container"></div>
            </div>
            <div class="shop-item">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIyNSIgY3k9IjI1IiByPSIyMCIgZmlsbD0iIzAwRkYwMCIvPjwvc3ZnPg==" alt="Shield Pack">
                <div class="shop-item-name">Shield Pack - £3 (Doubles shield)</div>
                <div id="paypal-shieldpack-container" class="paypal-buttons-container"></div>
            </div>
        </div>
        <button id="back-btn" onclick="backToMenuFromShop()">Back</button>
    </div>
    <div id="debug-menu">
        <div id="logo">Debug Menu</div>
        <button class="debug-btn" onclick="debugAddScore(1000)">Add 1000 Score</button>
        <button class="debug-btn" onclick="debugAddScore(10000)">Add 10000 Score</button>
        <button class="debug-btn" onclick="debugNextLevel()">Next Level</button>
        <button class="debug-btn" onclick="debugSpawnUpgrade()">Spawn Random Upgrade</button>
        <button class="debug-btn" onclick="debugToggleInvincibility()">Toggle Invincibility</button>
        <button class="debug-btn" onclick="debugResetGame()">Reset Game</button>
        <button class="debug-btn" onclick="debugMaxBullets()">Max Bullets</button>
        <button class="debug-btn" onclick="debugMaxSpeed()">Max Speed</button>
        <button class="debug-btn" onclick="debugInfiniteShield()">Infinite Shield</button>
        <button class="debug-btn" onclick="debugKillAllPacmen()">Kill All Pacmen</button>
        <button class="debug-btn" onclick="debugSpawnGhosts(5)">Spawn 5 Ghosts</button>
        <button class="debug-btn" onclick="debugIncreaseFireRate()">Increase Fire Rate</button>
        <button class="debug-btn" onclick="debugUnlockAllShips()">Unlock All Ships</button>
        <button class="debug-btn" onclick="debugDoubleSize()">Double Player Size</button>
        <button class="debug-btn" onclick="debugHalfSize()">Half Player Size</button>
        <button class="debug-btn" onclick="debugInstantLevel10()">Jump to Level 10</button>
        <button class="debug-btn" onclick="debugSlowEnemies()">Slow Enemies</button>
        <button class="debug-btn" onclick="debugFastEnemies()">Fast Enemies</button>
        <button class="debug-btn" onclick="debugExtraLives(3)">Add 3 Lives</button>
        <button class="debug-btn" onclick="debugUnlockAchievements()">Unlock All Achievements</button>
        <button class="debug-btn" onclick="debugAddCoins(1000)">Add 1000 Coins</button>
        <div style="color: #FFFF00; font-size: 14px; margin: 10px;">
            <strong>Redeem Codes:</strong><br>
            - "philo debug" - Unlock Debug Menu<br>
            - "gekyume" - Unlock Premium Features<br>
            - "easteregg" - Unlock Secret Ship<br>
            - "5ship" - Get 5 Free AI Ships<br>
            - "5fonts" - Unlock Premium Fonts<br>
            - "5themes" - Unlock Custom Themes<br>
            - "5games" - Unlock All Game Modes
        </div>
        <div style="color: #FFFF00; font-size: 14px; margin: 10px;">
            <strong>Edit Prices (£):</strong><br>
            <label>Premium: <input type="number" id="price-premium" class="price-input" step="0.01" min="0"></label><br>
            <label>Ship (e.g., Car): <input type="number" id="price-ship" class="price-input" step="0.01" min="0"></label><br>
            <label>Random AI Ship: <input type="number" id="price-random" class="price-input" step="0.01" min="0"></label><br>
            <label>Speed Boost: <input type="number" id="price-speedboost" class="price-input" step="0.01" min="0"></label><br>
            <label>Shield Pack: <input type="number" id="price-shieldpack" class="price-input" step="0.01" min="0"></label><br>
            <button id="save-prices-btn" onclick="savePrices()">Save Prices</button>
        </div>
        <button id="back-btn" onclick="toggleDebugMenu()">Collapse</button>
    </div>
    <div id="tutorial-menu">
        <div id="logo">Tutorial</div>
        <div id="tutorial-content" style="color: #FFFF00; font-size: 18px;"></div>
        <button id="back-btn" onclick="backToMenuFromTutorial()">Back</button>
    </div>
    <div id="score">Score: 0</div>
    <div id="level">Level: 1</div>
    <div id="coins">Coins: 0</div>
    <div id="control-bar">
        <button id="pause-resume-btn" onclick="pauseGame()">⏸️</button>
    </div>
    <button id="sound-btn" onclick="toggleMute()">🔊</button>
    <button id="debug-toggle-btn" onclick="toggleDebugMenu()">🐞</button>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div id="joystick">
        <div id="joystick-nub"></div>
    </div>
    <button id="shoot-btn"></button>
    <div id="messageDisplay"></div>

    <script>
        // DOM Elements
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('score');
        const levelDisplay = document.getElementById('level');
        const coinsDisplay = document.getElementById('coins');
        const joystick = document.getElementById('joystick');
        const joystickNub = document.getElementById('joystick-nub');
        const shootBtn = document.getElementById('shoot-btn');
        const soundBtn = document.getElementById('sound-btn');
        const debugToggleBtn = document.getElementById('debug-toggle-btn');
        const pauseResumeBtn = document.getElementById('pause-resume-btn');
        const menu = document.getElementById('menu');
        const settingsMenu = document.getElementById('settings-menu');
        const gameOverMenu = document.getElementById('game-over-menu');
        const pauseMenu = document.getElementById('pause-menu');
        const achievementsMenu = document.getElementById('achievements-menu');
        const shopMenu = document.getElementById('shop-menu');
        const debugMenu = document.getElementById('debug-menu');
        const tutorialMenu = document.getElementById('tutorial-menu');
        const finalScore = document.getElementById('final-score');
        const leaderboardMain = document.getElementById('leaderboard-main');
        const leaderboardGO = document.getElementById('leaderboard-go');
        const themeSelect = document.getElementById('theme-select');
        const shipSelect = document.getElementById('ship-select');
        const pauseShipSelect = document.getElementById('pause-ship-select');
        const bulletLetterInput = document.getElementById('bullet-letter-input');
        const pauseBulletLetterInput = document.getElementById('pause-bullet-letter-input');
        const gameModeSelect = document.getElementById('game-mode-select');
        const bgImageInput = document.getElementById('bg-image-input');
        const bgMusicInput = document.getElementById('bg-music-input');
        const gameVolume = document.getElementById('game-volume');
        const musicVolume = document.getElementById('music-volume');
        const musicSelect = document.getElementById('music-select');
        const playerNameInput = document.getElementById('player-name');
        const customThemeDiv = document.getElementById('custom-theme');
        const codeInput = document.getElementById('code-input');
        const aiEnemiesCheckbox = document.getElementById('ai-enemies');
        const fontSelect = document.getElementById('font-select');
        const shipColorPicker = document.getElementById('ship-color');

        // Canvas setup
        canvas.width = Math.min(800, window.innerWidth - 20);
        canvas.height = Math.min(600, window.innerHeight - 20);

        // Player object
        const player = {
            x: canvas.width / 2,
            y: canvas.height - 60,
            size: 40,
            speed: 5,
            dx: 0,
            dy: 0,
            shootCooldown: 0,
            bulletSpeed: 10,
            fireRate: 20,
            bulletCount: 1,
            shipLevel: 0,
            shipType: 'default',
            bulletLetter: 'B',
            frameCount: 0,
            wheelAngle: 0,
            propellerAngle: 0,
            lightAngle: 0,
            flameOffset: 0,
            flapAngle: 0,
            shield: 0,
            lives: 1,
            speedBoost: false,
            shieldPack: false,
            coins: 0,
            shipColor: '#FFFF00',
            bombCooldown: 0,
            radarActive: false
        };

        // Game state
        let bullets = [];
        let pacmen = [];
        let ghosts = [];
        let backgroundStars = [];
        let upgrades = [];
        let explosions = [];
        let bosses = [];
        let score = 0;
        let level = 1;
        let coins = 0;
        let gameOver = false;
        let isPaused = false;
        let moveTouchId = null;
        let isShooting = false;
        let ghostSpawnTimer = 0;
        let audioCtx = null;
        let isMuted = false;
        let backgroundMusic = null;
        let customBgImage = null;
        let gameVolumeLevel = 0.5;
        let musicVolumeLevel = 0.5;
        let leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];
        let customSounds = { waka: null, death: null, shoot: null, enemyHit: null, upgrade: null, bomb: null };
        let isPremium = localStorage.getItem('isPremium') === 'true';
        let ownedShips = JSON.parse(localStorage.getItem('ownedShips')) || ['default', 'scout', 'ranger', 'blaster'];
        let achievements = JSON.parse(localStorage.getItem('achievements')) || {
            pacmanSlayer: { count: 0, unlocked: false, name: 'Pac-Man Slayer', desc: 'Destroy 50 Pac-Men' },
            ghostHunter: { count: 0, unlocked: false, name: 'Ghost Hunter', desc: 'Collect 20 Ghosts' },
            levelMaster: { count: 0, unlocked: false, name: 'Level Master', desc: 'Reach Level 10' },
            coinCollector: { count: 0, unlocked: false, name: 'Coin Collector', desc: 'Earn 1000 Coins' },
            bossBuster: { count: 0, unlocked: false, name: 'Boss Buster', desc: 'Defeat 5 Bosses' }
        };
        let isDebugMode = false;
        let isInvincible = false;
        let useAIEnemies = false;
        let gameMode = 'classic';
        let challengeScore = 0;

        // Pricing
        const defaultPrices = {
            premium: 15.00,
            ship: 1.00,
            random: 0.50,
            speedboost: 2.00,
            shieldpack: 3.00
        };
        let prices = JSON.parse(localStorage.getItem('prices')) || { ...defaultPrices };

        // Themes
        const themes = {
            default: { playerColor: '#FFFF00', pacmanColor: '#FFFF00', ghostColor: '#FF0000', bulletColor: '#FF00FF', bgColor: '#000033', borderColor: '#00FFFF', buttonColor: '#00FFFF', menuColor: '#000000', textColor: '#FFFF00' },
            retro: { playerColor: '#00FF00', pacmanColor: '#FFFF00', ghostColor: '#FF00FF', bulletColor: '#00FFFF', bgColor: '#000000', borderColor: '#00FF00', buttonColor: '#00FF00', menuColor: '#000000', textColor: '#FFFF00' },
            neon: { playerColor: '#FF00FF', pacmanColor: '#00FFFF', ghostColor: '#FF0000', bulletColor: '#FFFF00', bgColor: '#000022', borderColor: '#FF00FF', buttonColor: '#FF00FF', menuColor: '#000022', textColor: '#00FFFF' },
            solar: { playerColor: '#FF4500', pacmanColor: '#FFD700', ghostColor: '#FF8C00', bulletColor: '#FF00FF', bgColor: '#1A0000', borderColor: '#FFA500', buttonColor: '#FFA500', menuColor: '#1A0000', textColor: '#FFD700' },
            cosmic: { playerColor: '#00CED1', pacmanColor: '#FFFFFF', ghostColor: '#9400D3', bulletColor: '#00FFFF', bgColor: '#000011', borderColor: '#00CED1', buttonColor: '#00CED1', menuColor: '#000011', textColor: '#FFFFFF' },
            galaxy: { playerColor: '#8A2BE2', pacmanColor: '#DDA0DD', ghostColor: '#FF1493', bulletColor: '#FF00FF', bgColor: '#0A001A', borderColor: '#8A2BE2', buttonColor: '#8A2BE2', menuColor: '#0A001A', textColor: '#DDA0DD' },
            cyber: { playerColor: '#00FF7F', pacmanColor: '#7FFF00', ghostColor: '#FF00FF', bulletColor: '#FFFF00', bgColor: '#001100', borderColor: '#00FF7F', buttonColor: '#00FF7F', menuColor: '#001100', textColor: '#7FFF00' },
            dark: { playerColor: '#696969', pacmanColor: '#A9A9A9', ghostColor: '#FF4500', bulletColor: '#00FFFF', bgColor: '#1C2526', borderColor: '#696969', buttonColor: '#696969', menuColor: '#1C2526', textColor: '#A9A9A9' },
            steampunk: { playerColor: '#8B4513', pacmanColor: '#DAA520', ghostColor: '#CD5C5C', bulletColor: '#FFD700', bgColor: '#2F1F0F', borderColor: '#8B4513', buttonColor: '#DAA520', menuColor: '#2F1F0F', textColor: '#FFD700' },
            cyberpunk: { playerColor: '#00FFFF', pacmanColor: '#FF00FF', ghostColor: '#9400D3', bulletColor: '#FFFF00', bgColor: '#0D1A26', borderColor: '#00FFFF', buttonColor: '#FF00FF', menuColor: '#0D1A26', textColor: '#FFFF00' },
            arcade: { playerColor: '#FF0000', pacmanColor: '#FFFF00', ghostColor: '#00FF00', bulletColor: '#0000FF', bgColor: '#000000', borderColor: '#FF0000', buttonColor: '#00FF00', menuColor: '#000000', textColor: '#FFFFFF' },
            futuristic: { playerColor: '#00CCFF', pacmanColor: '#FFFFFF', ghostColor: '#FF00CC', bulletColor: '#66FF66', bgColor: '#001933', borderColor: '#00CCFF', buttonColor: '#66FF66', menuColor: '#001933', textColor: '#FFFFFF' }
        };

        let theme = themes.default;
        const baseShips = ['default', 'car', 'plane', 'ufo', 'spaceship', 'tank', 'dragon', 'cruiser', 'bomber', 'pirate', 'scout', 'ranger', 'blaster'];
        const shipIcons = {
            default: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMTVMNDAgMjVMMjUgMzBMMTEgMTlaIiBmaWxsPSIjRkZGRkZGIi8+PGNpcmNsZSBjeD0iMjUiIGN5PSIxOCIgcj0iNSIgZmlsbD0iI0ZGRkZGRiIvPjxyZWN0IHg9IjIwIiB5PSIyOCIgd2lkdGg9IjEwIiBoZWlnaHQ9IjMiIGZpbGw9IiNGRjQ1MDAiLz48L3N2Zz4=',
            car: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMTBIMzBWMzBIMTBWMTBaIiBmaWxsPSIjRkZGRkZGIi8+PHBhdGggZD0iTTIwIDMwVjQwTTYwIDQwSDQwVjMwSDQwWiIgZmlsbD0iIzAwMDAwMCIvPjwvc3ZnPg==',
            plane: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjQUFBQUFBIi8+PHBhdGggZD0iTTI1IDE1TDE1IDI1TDM1IDI1TDI1IDE1WiIgZmlsbD0iIzAwMDAwMCIvPjwvc3ZnPg==',
            ufo: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZWxsaXBzZSBjeD0iMjUiIGN5PSIyNSIgcng9IjIwIiByeT0iMTAiIGZpbGw9IiNGRkZGRkYiLz48ZWxsaXBzZSBjeD0iMjUiIGN5PSIxNSIgcng9IjE1IiByeT0iOCIgZmlsbD0iI0FBQUFBQSIvPjwvc3ZnPg==',
            spaceship: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjRkZGRkZGIi8+PHBhdGggZD0iTTIwIDQwVjQ1SDMwVjQwSDIwWiIgZmlsbD0iI0ZGNDUwMCIvPjwvc3ZnPg==',
            tank: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB4PSIxMCIgeT0iMTUiIHdpZHRoPSI0MCIgaGVpZ2h0PSIxNSIgZmlsbD0iIzY2NjYzMyIvPjxwYXRoIGQ9Ik0yMCAxME0zMCAzNSIgZmlsbD0iIzMzMzMzMyIvPjwvc3ZnPg==',
            dragon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjRkZGRkZGIi8+PHBhdGggZD0iTTIwIDEwTDMwIDIwTDE1IDI1TDIwIDEwWiIgZmlsbD0iI0ZGNDUwMCIvPjwvc3ZnPg==',
            cruiser: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB4PSIxMCIgeT0iMTAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgZmlsbD0iI0FBQUFBQSIvPjxjaXJjbGUgY3g9IjI1IiBjeT0iMTUiIHI9IjEwIiBmaWxsPSIjRkYwMDAwIi8+PC9zdmc+',
            bomber: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjNjY2NjY2Ii8+PHJlY3QgeD0iMjAiIHk9IjMwIiB3aWR0aD0iMTAiIGhlaWdodD0iMTAiIGZpbGw9IiMwMDAwMDAiLz48L3N2Zz4=',
            pirate: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgNDAiIGZpbGw9IiM4QjQ1MTMiLz48cGF0aCBkPSJNMTAgMzBMMzAgNDBMMjAgMjVMMTAgMzBaIiBmaWxsPSIjRkZGRkZGIi8+PC9zdmc+',
            scout: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjMDBGRjAwIi8+PC9zdmc+',
            ranger: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTUgMjVMMzUgMzVMMjUgNDBMMTUgMjVaIiBmaWxsPSIjRkYwMEZGIi8+PHJlY3QgeD0iMjAiIHk9IjM1IiB3aWR0aD0iMTAiIGhlaWdodD0iNSIgZmlsbD0iI0ZGMDBGRiIvPjwvc3ZnPg==',
            blaster: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIyNSIgY3k9IjI1IiByPSIyMCIgZmlsbD0iI0ZGRkZGRiIvPjxjaXJjbGUgY3g9IjI1IiBjeT0iMTUiIHI9IjEwIiBmaWxsPSIjMDAwMDAwIi8+PC9zdmc+'
        };
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const achievementRequirements = {
            pacmanSlayer: 50,
            ghostHunter: 20,
            levelMaster: 10,
            coinCollector: 1000,
            bossBuster: 5
        };

        // Audio initialization
        function initAudioContext() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }
        document.addEventListener('touchstart', initAudioContext, { once: true });
        document.addEventListener('click', initAudioContext, { once: true });

        // Utility functions
        function showMessage(message) {
            const messageDiv = document.getElementById('messageDisplay');
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            setTimeout(() => messageDiv.style.display = 'none', 3000);
        }

        function generateUniqueShipName() {
            const prefixes = ['Aero', 'Cosmo', 'Galactic', 'Nebula', 'Stellar', 'Quantum', 'Orbit', 'Nova', 'Astro', 'Lunar'];
            const suffixes = ['Blaster', 'Cruiser', 'Fighter', 'Voyager', 'Phantom', 'Raptor', 'Drift', 'Pulse', 'Scout', 'Xeno'];
            const randomNum = Math.floor(Math.random() * 1000);
            return `${prefixes[Math.floor(Math.random() * prefixes.length)]}${suffixes[Math.floor(Math.random() * suffixes.length)]}${randomNum}`;
        }

        function updateShipSelect(selectElement) {
            selectElement.innerHTML = '';
            ownedShips.forEach(ship => {
                const option = document.createElement('option');
                option.value = ship;
                option.innerHTML = `<span class="ship-option"><img src="${shipIcons[ship] || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMjVMNDAgMzVMMjUgNDBMMTAgMjVaIiBmaWxsPSIjRkZGRkZGIi8+PC9zdmc+'}"> ${ship}</span>`;
                if (ship === player.shipType) option.selected = true;
                selectElement.appendChild(option);
            });
            if (isPremium) {
                baseShips.forEach(ship => {
                    if (!ownedShips.includes(ship)) {
                        const option = document.createElement('option');
                        option.value = ship;
                        option.innerHTML = `<span class="ship-option"><img src="${shipIcons[ship]}"> ${ship}</span>`;
                        selectElement.appendChild(option);
                    }
                });
            }
        }

        // Settings management
        function loadSettings() {
            const savedImage = localStorage.getItem('customBgImage');
            const savedMusic = localStorage.getItem('customBgMusic');
            const savedTheme = localStorage.getItem('theme');
            const savedShip = localStorage.getItem('shipType');
            const savedBulletLetter = localStorage.getItem('bulletLetter');
            const savedGameVolume = localStorage.getItem('gameVolume');
            const savedMusicVolume = localStorage.getItem('musicVolume');
            const savedCustomTheme = JSON.parse(localStorage.getItem('customTheme'));
            const savedSounds = JSON.parse(localStorage.getItem('customSounds')) || {};
            const savedAIEnemies = localStorage.getItem('useAIEnemies') === 'true';
            const savedFont = localStorage.getItem('font');
            const savedSpeedBoost = localStorage.getItem('speedBoost') === 'true';
            const savedShieldPack = localStorage.getItem('shieldPack') === 'true';
            const savedCoins = parseInt(localStorage.getItem('playerCoins')) || 0;
            const savedShipColor = localStorage.getItem('shipColor') || '#FFFF00';

            if (isPremium) {
                bgImageInput.disabled = false;
                bgMusicInput.disabled = false;
                document.getElementById('premium-options').style.display = 'block';
                player.fireRate = 15;
                player.lives = 3;
                if (savedSpeedBoost) player.speedBoost = true;
                if (savedShieldPack) player.shieldPack = true;
            }

            customBgImage = new Image();
            customBgImage.src = savedImage && isPremium ? savedImage : 'assets/background.jpg';
            customBgImage.onload = () => {
                drawBackground();
                document.body.style.backgroundImage = `url(${customBgImage.src})`;
                document.body.style.backgroundSize = 'cover';
                showMessage('Background image loaded!');
            };
            customBgImage.onerror = () => {
                console.error('Error loading background image');
                showMessage('Failed to load background image.');
                customBgImage.src = 'assets/background.jpg';
            };

            backgroundMusic = new Audio(savedMusic && isPremium ? savedMusic : musicSelect.value);
            backgroundMusic.loop = true;
            backgroundMusic.volume = 0;
            backgroundMusic.play().then(() => {
                backgroundMusic.volume = isMuted ? 0 : musicVolumeLevel;
            }).catch(err => {
                console.error('Error playing background music:', err);
                showMessage('Failed to play background music.');
            });

            if (savedTheme) {
                themeSelect.value = savedTheme;
                if (savedTheme === 'custom' && savedCustomTheme) {
                    themes.custom = savedCustomTheme;
                    document.getElementById('player-color').value = savedCustomTheme.playerColor;
                    document.getElementById('pacman-color').value = savedCustomTheme.pacmanColor;
                    document.getElementById('ghost-color').value = savedCustomTheme.ghostColor;
                    document.getElementById('bullet-color').value = savedCustomTheme.bulletColor;
                    document.getElementById('bg-color').value = savedCustomTheme.bgColor;
                    document.getElementById('border-color').value = savedCustomTheme.borderColor;
                    document.getElementById('button-color').value = savedCustomTheme.buttonColor;
                    document.getElementById('menu-color').value = savedCustomTheme.menuColor;
                    document.getElementById('text-color').value = savedCustomTheme.textColor;
                }
            }
            if (savedShip && ownedShips.includes(savedShip)) player.shipType = savedShip;
            if (savedBulletLetter) {
                player.bulletLetter = savedBulletLetter;
                bulletLetterInput.value = savedBulletLetter;
                pauseBulletLetterInput.value = savedBulletLetter;
            }
            if (savedGameVolume) {
                gameVolumeLevel = parseFloat(savedGameVolume);
                gameVolume.value = gameVolumeLevel;
            }
            if (savedMusicVolume) {
                musicVolumeLevel = parseFloat(savedMusicVolume);
                musicVolume.value = musicVolumeLevel;
                if (backgroundMusic) backgroundMusic.volume = isMuted ? 0 : musicVolumeLevel;
            }
            for (let sound in savedSounds) {
                if (savedSounds[sound]) customSounds[sound] = new Audio(savedSounds[sound]);
            }
            if (isPremium && savedAIEnemies) {
                useAIEnemies = true;
                aiEnemiesCheckbox.checked = true;
            }
            if (isPremium && savedFont) {
                fontSelect.value = savedFont;
                changeFont();
            }
            player.coins = savedCoins;
            player.shipColor = savedShipColor;
            shipColorPicker.value = savedShipColor;
            coinsDisplay.textContent = `Coins: ${player.coins}`;
            applyTheme();
            updateLeaderboardDisplay();
            updateShipSelect(shipSelect);
            updateShipSelect(pauseShipSelect);
            checkDailyReward();
            updatePriceInputs();
        }

        function updatePriceInputs() {
            document.getElementById('price-premium').value = prices.premium.toFixed(2);
            document.getElementById('price-ship').value = prices.ship.toFixed(2);
            document.getElementById('price-random').value = prices.random.toFixed(2);
            document.getElementById('price-speedboost').value = prices.speedboost.toFixed(2);
            document.getElementById('price-shieldpack').value = prices.shieldpack.toFixed(2);
        }

        function savePrices() {
            prices.premium = parseFloat(document.getElementById('price-premium').value) || defaultPrices.premium;
            prices.ship = parseFloat(document.getElementById('price-ship').value) || defaultPrices.ship;
            prices.random = parseFloat(document.getElementById('price-random').value) || defaultPrices.random;
            prices.speedboost = parseFloat(document.getElementById('price-speedboost').value) || defaultPrices.speedboost;
            prices.shieldpack = parseFloat(document.getElementById('price-shieldpack').value) || defaultPrices.shieldpack;
            localStorage.setItem('prices', JSON.stringify(prices));
            initPayPalButtons();
            showMessage('Prices saved successfully!');
        }

        function applyTheme() {
            theme = themes[themeSelect.value];
            canvas.style.borderColor = theme.borderColor;
            const buttons = document.querySelectorAll('button:not(#sound-btn):not(#shoot-btn):not(#pause-resume-btn):not(#debug-toggle-btn)');
            buttons.forEach(btn => btn.style.background = theme.buttonColor);
            shootBtn.style.background = `rgba(${parseInt(theme.buttonColor.slice(1,3), 16)}, ${parseInt(theme.buttonColor.slice(3,5), 16)}, ${parseInt(theme.buttonColor.slice(5,7), 16)}, 0.5)`;
            menu.style.background = theme.menuColor;
            settingsMenu.style.background = theme.menuColor;
            gameOverMenu.style.background = `rgba(${parseInt(theme.menuColor.slice(1,3), 16)}, ${parseInt(theme.menuColor.slice(3,5), 16)}, ${parseInt(theme.menuColor.slice(5,7), 16)}, 0.8)`;
            pauseMenu.style.background = `rgba(${parseInt(theme.menuColor.slice(1,3), 16)}, ${parseInt(theme.menuColor.slice(3,5), 16)}, ${parseInt(theme.menuColor.slice(5,7), 16)}, 0.8)`;
            achievementsMenu.style.background = `rgba(${parseInt(theme.menuColor.slice(1,3), 16)}, ${parseInt(theme.menuColor.slice(3,5), 16)}, ${parseInt(theme.menuColor.slice(5,7), 16)}, 0.8)`;
            shopMenu.style.background = `rgba(${parseInt(theme.menuColor.slice(1,3), 16)}, ${parseInt(theme.menuColor.slice(3,5), 16)}, ${parseInt(theme.menuColor.slice(5,7), 16)}, 0.8)`;
            debugMenu.style.background = `rgba(${parseInt(theme.menuColor.slice(1,3), 16)}, ${parseInt(theme.menuColor.slice(3,5), 16)}, ${parseInt(theme.menuColor.slice(5,7), 16)}, 0.5)`;
            tutorialMenu.style.background = `rgba(${parseInt(theme.menuColor.slice(1,3), 16)}, ${parseInt(theme.menuColor.slice(3,5), 16)}, ${parseInt(theme.menuColor.slice(5,7), 16)}, 0.8)`;
            document.querySelectorAll('#menu, #settings-menu, #game-over-menu, #pause-menu, #achievements-menu, #shop-menu, #debug-menu, #tutorial-menu, #score, #level, #coins, #final-score, #leaderboard, label, #made-by, .shop-item-name').forEach(el => {
                el.style.color = theme.textColor;
                el.style.fontFamily = fontSelect.value || 'Arial';
            });
            customThemeDiv.style.display = themeSelect.value === 'custom' ? 'block' : 'none';
        }

        // Event handlers
        function changeTheme() {
            applyTheme();
        }

        function changeShip() {
            if (ownedShips.includes(shipSelect.value) || isPremium) {
                player.shipType = shipSelect.value;
                localStorage.setItem('shipType', player.shipType);
                pauseShipSelect.value = player.shipType;
            } else {
                showMessage('You must own this ship or be a premium user to use it!');
                shipSelect.value = player.shipType;
            }
        }

        function changeShipFromPause() {
            if (ownedShips.includes(pauseShipSelect.value) || isPremium) {
                player.shipType = pauseShipSelect.value;
                localStorage.setItem('shipType', player.shipType);
                shipSelect.value = player.shipType;
            } else {
                showMessage('You must own this ship or be a premium user to use it!');
                pauseShipSelect.value = player.shipType;
            }
        }

        function updateBulletLetter() {
            player.bulletLetter = bulletLetterInput.value.toUpperCase() || 'B';
            localStorage.setItem('bulletLetter', player.bulletLetter);
            pauseBulletLetterInput.value = player.bulletLetter;
        }

        function updateBulletLetterFromPause() {
            player.bulletLetter = pauseBulletLetterInput.value.toUpperCase() || 'B';
            localStorage.setItem('bulletLetter', player.bulletLetter);
            bulletLetterInput.value = player.bulletLetter;
        }

        function changeGameMode() {
            gameMode = gameModeSelect.value;
            init();
            showMessage(`Game mode changed to ${gameMode}!`);
        }

        function changeMusic() {
            backgroundMusic.src = musicSelect.value;
            backgroundMusic.loop = true;
            backgroundMusic.volume = isMuted ? 0 : musicVolumeLevel;
            if (!isMuted) backgroundMusic.play().catch(() => showMessage('Failed to play music.'));
            localStorage.setItem('customBgMusic', musicSelect.value);
        }

        function redeemCode() {
            const code = codeInput.value.trim().toLowerCase();
            switch (code) {
                case 'philo debug':
                    showDebugMenu();
                    codeInput.value = '';
                    break;
                case 'gekyume':
                    isPremium = true;
                    localStorage.setItem('isPremium', 'true');
                    bgImageInput.disabled = false;
                    bgMusicInput.disabled = false;
                    document.getElementById('premium-options').style.display = 'block';
                    player.fireRate = 15;
                    player.lives = 3;
                    showMessage('Premium features unlocked! Enjoy faster fire rate, extra lives, and more customization.');
                    updateShipSelect(shipSelect);
                    updateShipSelect(pauseShipSelect);
                    codeInput.value = '';
                    break;
                case 'easteregg':
                    if (!ownedShips.includes('secretShip')) {
                        ownedShips.push('secretShip');
                        localStorage.setItem('ownedShips', JSON.stringify(ownedShips));
                        updateShipSelect(shipSelect);
                        updateShipSelect(pauseShipSelect);
                        showMessage('Secret Ship unlocked! Check your ship selection.');
                    }
                    codeInput.value = '';
                    break;
                case '5ship':
                    for (let i = 0; i < 5; i++) {
                        const newShip = generateUniqueShipName();
                        if (!ownedShips.includes(newShip)) {
                            ownedShips.push(newShip);
                        }
                    }
                    localStorage.setItem('ownedShips', JSON.stringify(ownedShips));
                    updateShipSelect(shipSelect);
                    updateShipSelect(pauseShipSelect);
                    showMessage('5 unique AI-generated ships unlocked!');
                    codeInput.value = '';
                    break;
                case '5fonts':
                    isPremium = true;
                    localStorage.setItem('isPremium', 'true');
                    fontSelect.disabled = false;
                    document.getElementById('premium-options').style.display = 'block';
                    showMessage('Premium fonts unlocked! Customize your text in settings.');
                    codeInput.value = '';
                    break;
                case '5themes':
                    isPremium = true;
                    localStorage.setItem('isPremium', 'true');
                    customThemeDiv.style.display = 'block';
                    themeSelect.options[0].text = 'Custom';
                    showMessage('Custom themes unlocked! Create your own theme in settings.');
                    codeInput.value = '';
                    break;
                case '5games':
                    gameModeSelect.disabled = false;
                    showMessage('All game modes unlocked! Choose your mode in the pause menu.');
                    codeInput.value = '';
                    break;
                default:
                    showMessage('Invalid code! Please try a valid redemption code.');
            }
        }

        function toggleMute() {
            isMuted = !isMuted;
            if (isMuted) {
                backgroundMusic.volume = 0;
                for (let sound in customSounds) {
                    if (customSounds[sound]) customSounds[sound].volume = 0;
                }
                soundBtn.textContent = '🔇';
                soundBtn.classList.add('muted');
            } else {
                backgroundMusic.volume = musicVolumeLevel;
                for (let sound in customSounds) {
                    if (customSounds[sound]) customSounds[sound].volume = gameVolumeLevel;
                }
                soundBtn.textContent = '🔊';
                soundBtn.classList.remove('muted');
            }
        }

        function uploadBackgroundImage() {
            if (!isPremium) {
                showMessage('Premium required to upload background images!');
                return;
            }
            const file = bgImageInput.files[0];
            if (!file) {
                showMessage('No file selected!');
                return;
            }
            const extension = file.name.split('.').pop().toLowerCase();
            if (['png', 'jpg', 'jpeg'].includes(extension)) {
                const url = URL.createObjectURL(file);
                customBgImage = new Image();
                customBgImage.src = url;
                customBgImage.onload = () => {
                    drawBackground();
                    document.body.style.backgroundImage = `url(${customBgImage.src})`;
                    document.body.style.backgroundSize = 'cover';
                    localStorage.setItem('customBgImage', url);
                    showMessage('Background image uploaded successfully!');
                };
                customBgImage.onerror = () => {
                    showMessage('Failed to load uploaded image. Please try again.');
                    customBgImage = null;
                };
            } else {
                showMessage('Please upload a valid PNG or JPG image.');
            }
        }

        function uploadBackgroundMusic() {
            if (!isPremium) {
                showMessage('Premium required to upload background music!');
                return;
            }
            const file = bgMusicInput.files[0];
            if (!file) {
                showMessage('No file selected!');
                return;
            }
            const extension = file.name.split('.').pop().toLowerCase();
            if (extension === 'mp3') {
                const url = URL.createObjectURL(file);
                backgroundMusic.src = url;
                backgroundMusic.loop = true;
                backgroundMusic.volume = isMuted ? 0 : musicVolumeLevel;
                localStorage.setItem('customBgMusic', url);
                if (!isMuted) backgroundMusic.play().catch(() => showMessage('Failed to play uploaded music.'));
                showMessage('Background music uploaded successfully!');
            } else {
                showMessage('Please upload a valid MP3 file.');
            }
        }

        function uploadSound(type) {
            const file = document.getElementById(`${type}-sound`).files[0];
            if (!file) {
                showMessage('No file selected!');
                return;
            }
            const extension = file.name.split('.').pop().toLowerCase();
            if (extension === 'mp3') {
                const url = URL.createObjectURL(file);
                customSounds[type] = new Audio(url);
                customSounds[type].volume = isMuted ? 0 : gameVolumeLevel;
                showMessage(`${type} sound uploaded successfully!`);
            } else {
                showMessage('Please upload a valid MP3 file.');
            }
        }

        function saveSettings() {
            if (customBgImage) localStorage.setItem('customBgImage', customBgImage.src);
            if (backgroundMusic) localStorage.setItem('customBgMusic', backgroundMusic.src);
            localStorage.setItem('theme', themeSelect.value);
            localStorage.setItem('shipType', player.shipType);
            localStorage.setItem('bulletLetter', player.bulletLetter);
            localStorage.setItem('gameVolume', gameVolume.value);
            localStorage.setItem('musicVolume', musicVolume.value);
            localStorage.setItem('achievements', JSON.stringify(achievements));
            localStorage.setItem('ownedShips', JSON.stringify(ownedShips));
            localStorage.setItem('isPremium', isPremium);
            localStorage.setItem('useAIEnemies', useAIEnemies);
            localStorage.setItem('font', fontSelect.value);
            localStorage.setItem('speedBoost', player.speedBoost);
            localStorage.setItem('shieldPack', player.shieldPack);
            localStorage.setItem('playerCoins', player.coins);
            localStorage.setItem('shipColor', player.shipColor);
            gameVolumeLevel = parseFloat(gameVolume.value);
            musicVolumeLevel = parseFloat(musicVolume.value);
            player.shipColor = shipColorPicker.value;
            if (backgroundMusic) backgroundMusic.volume = isMuted ? 0 : musicVolumeLevel;
            if (themeSelect.value === 'custom') {
                themes.custom = {
                    playerColor: document.getElementById('player-color').value,
                    pacmanColor: document.getElementById('pacman-color').value,
                    ghostColor: document.getElementById('ghost-color').value,
                    bulletColor: document.getElementById('bullet-color').value,
                    bgColor: document.getElementById('bg-color').value,
                    borderColor: document.getElementById('border-color').value,
                    buttonColor: document.getElementById('button-color').value,
                    menuColor: document.getElementById('menu-color').value,
                    textColor: document.getElementById('text-color').value
                };
                localStorage.setItem('customTheme', JSON.stringify(themes.custom));
            }
            const savedSounds = {};
            for (let sound in customSounds) {
                if (customSounds[sound]) savedSounds[sound] = customSounds[sound].src;
            }
            localStorage.setItem('customSounds', JSON.stringify(savedSounds));
            applyTheme();
            showMessage('Settings saved!');
        }

        function updateLeaderboardDisplay() {
            leaderboard.sort((a, b) => b.score - a.score);
            leaderboard = leaderboard.slice(0, 5);
            leaderboardMain.innerHTML = '<strong>Local Leaderboard:</strong><br>' + leaderboard.map((entry, i) => `${i + 1}. ${entry.name}: ${entry.score}`).join('<br>');
            leaderboardGO.innerHTML = leaderboardMain.innerHTML;
        }

        function showLeaderboard(source) {
            const leaderboardDiv = source === 'main' ? leaderboardMain : leaderboardGO;
            leaderboardDiv.style.display = leaderboardDiv.style.display === 'block' ? 'none' : 'block';
            syncLeaderboard();
        }

        function showRules() {
            const rulesSection = document.getElementById('rules-section');
            leaderboardMain.style.display = 'none';
            if (rulesSection.style.display === 'block') {
                rulesSection.style.display = 'none';
            } else {
                rulesSection.style.display = 'block';
                rulesSection.innerHTML = `
                    <strong>Rules of Space Pac-Invaders:</strong><br>
                    1. <strong>Controls:</strong> Move your ship with arrow keys (PC) or joystick (mobile). Shoot with spacebar (PC) or shoot button (mobile). Special abilities: 'B' for bombs (Bomber ship), 'R' for radar (Scout ship).<br>
                    2. <strong>Objective:</strong> Destroy Pac-Men (50 points, 10 coins each) and collect ghosts (50 points, 5 coins each) to earn points and coins.<br>
                    3. <strong>Lives:</strong> Avoid Pac-Men and bosses (2x damage). Non-premium starts with 1 life, premium with 3. Shields protect temporarily.<br>
                    4. <strong>Levels & Bosses:</strong> Clear Pac-Men to advance levels in Classic mode. Every 5 levels, face a boss (500 points, 100 coins, more health).<br>
                    5. <strong>Game Modes:</strong> Classic (level-based), Endless (infinite enemies), Survival (fast enemies, limited lives). Switch modes in pause menu.<br>
                    6. <strong>Upgrades:</strong> Collect power-ups (gun, ship, shield, speed, multi-shot) for temporary boosts (e.g., 10-second speed increase).<br>
                    7. <strong>Ships:</strong> Choose ships with unique abilities (e.g., Bomber drops bombs, Scout has radar). Non-premium starts with Scout, Ranger, Blaster.<br>
                    8. <strong>Coins:</strong> Earn coins from Pac-Men, ghosts, levels (50 coins), and daily login (100 coins). Spend in shop or save for upgrades.<br>
                    9. <strong>Shop:</strong> Buy ships (£1), random AI ships (£0.50), Speed Boost (£2), Shield Pack (£3) with real money via PayPal.<br>
                    10. <strong>Scoring:</strong> Track scores locally. Share or copy scores from game-over menu. Challenge friends by beating their scores.<br>
                    11. <strong>Achievements:</strong> Unlock rewards (e.g., Pac-Man Slayer: 50 kills, Boss Buster: 5 bosses) visible in Achievements menu.<br>
                    12. <strong>Customization:</strong> Change ship color, bullet letter, theme, music, and sounds (premium only for some options) in Settings.<br>
                    13. <strong>Premium:</strong> Unlock faster fire rate, extra lives, AI enemies, custom fonts/themes via shop purchase or special codes.<br>
                    14. <strong>Pause/Mute:</strong> Pause with top-center button, mute with top-right button during gameplay.<br>
                    15. <strong>Tips:</strong> Use shields strategically, master ship abilities, and aim for daily rewards to boost progress!`;
            }
        }

        function showAchievements() {
            menu.style.opacity = '0';
            setTimeout(() => {
                menu.style.display = 'none';
                menu.style.opacity = '1';
                achievementsMenu.style.display = 'block';
                achievementsMenu.style.opacity = '0';
                setTimeout(() => {
                    achievementsMenu.style.opacity = '1';
                    updateAchievementsList();
                }, 10);
            }, 500);
        }

        function updateAchievementsList() {
            const achievementsList = document.getElementById('achievements-list');
            achievementsList.innerHTML = '';
            for (let achievement in achievements) {
                const { name, desc, count, unlocked } = achievements[achievement];
                const required = achievementRequirements[achievement];
                const status = unlocked ? 'Unlocked' : `Progress: ${count}/${required}`;
                const trophy = unlocked ? '🏆' : '';
                achievementsList.innerHTML += `<div>${name} - ${desc}: ${status} ${trophy}</div>`;
            }
        }

        function backToMenuFromAchievements() {
            achievementsMenu.style.opacity = '0';
            setTimeout(() => {
                achievementsMenu.style.display = 'none';
                achievementsMenu.style.opacity = '1';
                menu.style.display = 'block';
                menu.style.opacity = '0';
                setTimeout(() => menu.style.opacity = '1', 10);
            }, 500);
        }

        function showShop() {
            menu.style.opacity = '0';
            setTimeout(() => {
                menu.style.display = 'none';
                menu.style.opacity = '1';
                shopMenu.style.display = 'block';
                shopMenu.style.opacity = '0';
                setTimeout(() => shopMenu.style.opacity = '1', 10);
            }, 500);
        }

        function backToMenuFromShop() {
            shopMenu.style.opacity = '0';
            setTimeout(() => {
                shopMenu.style.display = 'none';
                shopMenu.style.opacity = '1';
                menu.style.display = 'block';
                menu.style.opacity = '0';
                setTimeout(() => menu.style.opacity = '1', 10);
            }, 500);
        }

        function showDebugMenu() {
            isDebugMode = true;
            debugToggleBtn.style.display = 'flex';
            debugMenu.style.display = 'block';
            debugMenu.style.opacity = '0';
            debugMenu.style.top = '60px';
            debugMenu.style.background = 'rgba(0, 0, 0, 0.5)';
            debugMenu.style.maxHeight = 'calc(100vh - 70px)';
            setTimeout(() => debugMenu.style.opacity = '1', 10);
            updatePriceInputs();
        }

        function toggleDebugMenu() {
            if (debugMenu.style.display === 'block') {
                debugMenu.style.opacity = '0';
                setTimeout(() => debugMenu.style.display = 'none', 500);
            } else {
                debugMenu.style.display = 'block';
                debugMenu.style.opacity = '0';
                debugMenu.style.top = '60px';
                debugMenu.style.background = 'rgba(0, 0, 0, 0.5)';
                debugMenu.style.maxHeight = 'calc(100vh - 70px)';
                setTimeout(() => debugMenu.style.opacity = '1', 10);
                updatePriceInputs();
            }
        }

        function showTutorial() {
            menu.style.opacity = '0';
            setTimeout(() => {
                menu.style.display = 'none';
                menu.style.opacity = '1';
                tutorialMenu.style.display = 'block';
                tutorialMenu.style.opacity = '0';
                setTimeout(() => {
                    tutorialMenu.style.opacity = '1';
                    document.getElementById('tutorial-content').innerHTML = `
                        <strong>Tutorial:</strong><br>
                        1. <strong>Controls:</strong> Use arrow keys (PC) or joystick (mobile) to move your ship. Press spacebar (PC) or shoot button (mobile) to fire.<br>
                        2. <strong>Objective:</strong> Shoot Pac-Men to earn points (50 each) and coins (10 each). Collect ghosts for bonus points (50) and coins (5).<br>
                        3. <strong>Upgrades:</strong> Grab power-ups like speed boosts (yellow) or multi-shot (purple) for temporary advantages.<br>
                        4. <strong>Bosses:</strong> Every 5 levels, face a boss with more health and unique attacks. Defeat for 500 points and 100 coins.<br>
                        5. <strong>Ships:</strong> Each ship has a unique ability (e.g., Bomber drops bombs, Scout has radar). Choose wisely!<br>
                        6. <strong>Coins:</strong> Use coins in the shop to buy items, or spend real money for premium options.<br>
                        7. <strong>Tip:</strong> Stay alive by avoiding Pac-Men, and use shields to survive longer!`;
                }, 10);
            }, 500);
        }

        function backToMenuFromTutorial() {
            tutorialMenu.style.opacity = '0';
            setTimeout(() => {
                tutorialMenu.style.display = 'none';
                tutorialMenu.style.opacity = '1';
                menu.style.display = 'block';
                menu.style.opacity = '0';
                setTimeout(() => menu.style.opacity = '1', 10);
            }, 500);
        }

        function toggleAIEnemies() {
            if (!isPremium) {
                showMessage('Premium required to use AI-generated enemies!');
                aiEnemiesCheckbox.checked = false;
                return;
            }
            useAIEnemies = aiEnemiesCheckbox.checked;
            localStorage.setItem('useAIEnemies', useAIEnemies);
            initLevel();
            showMessage(`AI Enemies ${useAIEnemies ? 'enabled' : 'disabled'}!`);
        }

        function changeFont() {
            if (!isPremium) {
                showMessage('Premium required to change font!');
                fontSelect.value = 'Arial';
                return;
            }
            localStorage.setItem('font', fontSelect.value);
            applyTheme();
        }

        function checkDailyReward() {
            const lastLogin = localStorage.getItem('lastLogin');
            const today = new Date().toDateString();
            if (!lastLogin || lastLogin !== today) {
                player.coins += 100;
                localStorage.setItem('playerCoins', player.coins);
                localStorage.setItem('lastLogin', today);
                coinsDisplay.textContent = `Coins: ${player.coins}`;
                showMessage('Daily reward granted: 100 coins!');
            }
        }

        // Sound effects
        function playSound(type) {
            if (isMuted || !audioCtx) return;
            if (customSounds[type]) {
                customSounds[type].currentTime = 0;
                customSounds[type].volume = gameVolumeLevel;
                customSounds[type].play().catch(() => {});
            } else {
                const osc = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                osc.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                switch(type) {
                    case 'waka':
                        osc.type = 'square';
                        osc.frequency.setValueAtTime(523.25, audioCtx.currentTime);
                        osc.frequency.setValueAtTime(659.25, audioCtx.currentTime + 0.1);
                        gainNode.gain.setValueAtTime(gameVolumeLevel * 0.2, audioCtx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                        osc.start();
                        osc.stop(audioCtx.currentTime + 0.2);
                        break;
                    case 'death':
                        osc.type = 'square';
                        osc.frequency.setValueAtTime(784, audioCtx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(523, audioCtx.currentTime + 0.3);
                        gainNode.gain.setValueAtTime(gameVolumeLevel * 0.3, audioCtx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                        osc.start();
                        osc.stop(audioCtx.currentTime + 0.3);
                        break;
                    case 'shoot':
                        osc.type = 'square';
                        osc.frequency.setValueAtTime(880, audioCtx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(440, audioCtx.currentTime + 0.1);
                        gainNode.gain.setValueAtTime(gameVolumeLevel * 0.2, audioCtx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                        osc.start();
                        osc.stop(audioCtx.currentTime + 0.1);
                        break;
                    case 'enemyHit':
                        osc.type = 'square';
                        osc.frequency.setValueAtTime(220, audioCtx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(110, audioCtx.currentTime + 0.15);
                        gainNode.gain.setValueAtTime(gameVolumeLevel * 0.25, audioCtx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                        osc.start();
                        osc.stop(audioCtx.currentTime + 0.15);
                        break;
                    case 'upgrade':
                        osc.type = 'triangle';
                        osc.frequency.setValueAtTime(440, audioCtx.currentTime);
                        osc.frequency.setValueAtTime(880, audioCtx.currentTime + 0.2);
                        gainNode.gain.setValueAtTime(gameVolumeLevel * 0.3, audioCtx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                        osc.start();
                        osc.stop(audioCtx.currentTime + 0.3);
                        break;
                    case 'bomb':
                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(110, audioCtx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(55, audioCtx.currentTime + 0.5);
                        gainNode.gain.setValueAtTime(gameVolumeLevel * 0.4, audioCtx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                        osc.start();
                        osc.stop(audioCtx.currentTime + 0.5);
                        break;
                }
            }
        }

        // Game initialization
        function initBackground() {
            backgroundStars = [];
            for (let i = 0; i < 300; i++) {
                backgroundStars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 5 + 1,
                    speed: Math.random() * 0.5 + 0.5,
                    color: Math.random() < 0.8 ? '#FFFFFF' : theme.playerColor
                });
            }
        }

        function initLevel() {
            pacmen = [];
            ghosts = [];
            upgrades = [];
            bosses = [];
            let pacmanCount = gameMode === 'endless' ? 10 : level * 3;
            for (let i = 0; i < pacmanCount; i++) {
                pacmen.push({
                    x: Math.random() * (canvas.width - 40),
                    y: -40,
                    size: 40,
                    speed: gameMode === 'survival' ? 2 + level * 0.5 : 1 + level * 0.5,
                    mouthAngle: 0,
                    mouthSpeed: 0.05,
                    spinAngle: 0,
                    health: 1,
                    isAI: useAIEnemies && Math.random() < 0.5,
                    targetX: player.x,
                    targetY: player.y
                });
            }
            if (level % 5 === 0) {
                bosses.push({
                    x: canvas.width / 2 - 50,
                    y: -100,
                    size: 100,
                    speed: 1 + level * 0.2,
                    health: 10 + level * 2,
                    angle: 0,
                    spinSpeed: 0.02
                });
            }
            if (Math.random() < (isPremium ? 0.75 : 0.5)) {
                upgrades.push({
                    x: Math.random() * (canvas.width - 20),
                    y: -20,
                    size: 20,
                    speed: 2,
                    type: ['gun', 'ship', 'shield', 'speed', 'multi'][Math.floor(Math.random() * 5)],
                    color: ['#FF0000', '#0000FF', '#00FF00', '#FFFF00', '#FF00FF'][Math.floor(Math.random() * 5)]
                });
            }
        }

        function spawnGhost() {
            if (Math.random() < 0.02) {
                ghosts.push({
                    x: Math.random() * (canvas.width - 20),
                    y: -20,
                    size: 20,
                    speed: 2,
                    type: Math.floor(Math.random() * 4)
                });
            }
        }

        function init() {
            score = 0;
            level = 1;
            gameOver = false;
            isPaused = false;
            player.x = canvas.width / 2;
            player.y = canvas.height - 60;
            player.dx = 0;
            player.dy = 0;
            player.shootCooldown = 0;
            player.speed = player.speedBoost ? 10 : 5;
            player.bulletSpeed = 10;
            player.fireRate = isPremium ? 15 : 20;
            player.bulletCount = 1;
            player.shipLevel = 0;
            player.frameCount = 0;
            player.wheelAngle = 0;
            player.propellerAngle = 0;
            player.lightAngle = 0;
            player.flameOffset = 0;
            player.flapAngle = 0;
            player.shield = player.shieldPack ? 200 : 0;
            player.lives = isPremium ? 3 : 1;
            player.bombCooldown = 0;
            player.radarActive = false;
            isShooting = false;
            bullets = [];
            pacmen = [];
            ghosts = [];
            upgrades = [];
            bosses = [];
            explosions = [];
            ghostSpawnTimer = 0;
            gameOverMenu.style.display = 'none';
            pauseMenu.style.display = 'none';
            achievementsMenu.style.display = 'none';
            shopMenu.style.display = 'none';
            debugMenu.style.display = 'none';
            tutorialMenu.style.display = 'none';
            leaderboardMain.style.display = 'none';
            leaderboardGO.style.display = 'none';
            document.getElementById('control-bar').style.display = 'flex';
            if (isDebugMode) debugToggleBtn.style.display = 'flex';
            initLevel();
            initBackground();
            applyTheme();
            scoreDisplay.textContent = `Score: ${score}`;
            levelDisplay.textContent = `Level: ${level}`;
            coinsDisplay.textContent = `Coins: ${player.coins}`;
        }

        function startGame() {
            if (!playerNameInput.value.trim()) {
                showMessage('Please enter your name!');
                return;
            }
            initAudioContext();
            menu.style.opacity = '0';
            setTimeout(() => {
                menu.style.display = 'none';
                menu.style.opacity = '1';
                canvas.style.display = 'block';
                scoreDisplay.style.display = 'block';
                levelDisplay.style.display = 'block';
                coinsDisplay.style.display = 'block';
                document.getElementById('control-bar').style.display = 'flex';
                if (isMobile) {
                    joystick.style.display = 'block';
                    shootBtn.style.display = 'block';
                }
                init();
                gameLoop();
            }, 500);
        }

        function restartGame() {
            gameOverMenu.style.opacity = '0';
            setTimeout(() => {
                gameOverMenu.style.display = 'none';
                gameOverMenu.style.opacity = '1';
                document.getElementById('control-bar').style.display = 'flex';
                if (isMobile) {
                    joystick.style.display = 'block';
                    shootBtn.style.display = 'block';
                }
                init();
                gameLoop();
            }, 300);
        }

        function showSettings() {
            menu.style.opacity = '0';
            setTimeout(() => {
                menu.style.display = 'none';
                menu.style.opacity = '1';
                settingsMenu.style.display = 'block';
                settingsMenu.style.opacity = '0';
                setTimeout(() => settingsMenu.style.opacity = '1', 10);
            }, 500);
        }

        function showSettingsFromGameOver() {
            gameOverMenu.style.opacity = '0';
            setTimeout(() => {
                gameOverMenu.style.display = 'none';
                gameOverMenu.style.opacity = '1';
                settingsMenu.style.display = 'block';
                settingsMenu.style.opacity = '0';
                setTimeout(() => settingsMenu.style.opacity = '1', 10);
            }, 300);
        }

        function showSettingsFromPause() {
            pauseMenu.style.opacity = '0';
            setTimeout(() => {
                pauseMenu.style.display = 'none';
                pauseMenu.style.opacity = '1';
                settingsMenu.style.display = 'block';
                settingsMenu.style.opacity = '0';
                setTimeout(() => settingsMenu.style.opacity = '1', 10);
            }, 300);
        }

        function backToMenu() {
            settingsMenu.style.opacity = '0';
            setTimeout(() => {
                settingsMenu.style.display = 'none';
                settingsMenu.style.opacity = '1';
                menu.style.display = 'block';
                menu.style.opacity = '0';
                setTimeout(() => menu.style.opacity = '1', 10);
            }, 500);
        }

        function backToMainMenu() {
            gameOverMenu.style.opacity = '0';
            setTimeout(() => {
                gameOverMenu.style.display = 'none';
                gameOverMenu.style.opacity = '1';
                menu.style.display = 'block';
                menu.style.opacity = '0';
                setTimeout(() => {
                    menu.style.opacity = '1';
                    canvas.style.display = 'none';
                    scoreDisplay.style.display = 'none';
                    levelDisplay.style.display = 'none';
                    coinsDisplay.style.display = 'none';
                    joystick.style.display = 'none';
                    shootBtn.style.display = 'none';
                    document.getElementById('control-bar').style.display = 'none';
                    leaderboard.push({ name: playerNameInput.value.trim(), score: score });
                    localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
                    updateLeaderboardDisplay();
                }, 10);
            }, 300);
        }

        function backToMainMenuFromPause() {
            pauseMenu.style.opacity = '0';
            setTimeout(() => {
                pauseMenu.style.display = 'none';
                pauseMenu.style.opacity = '1';
                menu.style.display = 'block';
                menu.style.opacity = '0';
                setTimeout(() => {
                    menu.style.opacity = '1';
                    canvas.style.display = 'none';
                    scoreDisplay.style.display = 'none';
                    levelDisplay.style.display = 'none';
                    coinsDisplay.style.display = 'none';
                    joystick.style.display = 'none';
                    shootBtn.style.display = 'none';
                    document.getElementById('control-bar').style.display = 'none';
                    leaderboard.push({ name: playerNameInput.value.trim(), score: score });
                    localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
                    updateLeaderboardDisplay();
                }, 10);
            }, 300);
        }

        function pauseGame() {
            if (!gameOver) {
                if (isPaused) {
                    resumeGame();
                } else {
                    isPaused = true;
                    pauseMenu.style.display = 'block';
                    pauseMenu.style.opacity = '0';
                    setTimeout(() => pauseMenu.style.opacity = '1', 10);
                    pauseResumeBtn.textContent = '▶️';
                    pauseResumeBtn.classList.add('paused');
                }
            }
        }

        function resumeGame() {
            pauseMenu.style.opacity = '0';
            setTimeout(() => {
                pauseMenu.style.display = 'none';
                pauseMenu.style.opacity = '1';
                isPaused = false;
                document.getElementById('control-bar').style.display = 'flex';
                if (isMobile) {
                    joystick.style.display = 'block';
                    shootBtn.style.display = 'block';
                }
                pauseResumeBtn.textContent = '⏸️';
                pauseResumeBtn.classList.remove('paused');
                gameLoop();
            }, 300);
        }

        // Drawing functions
        function drawBackground() {
            if (customBgImage && customBgImage.complete) {
                ctx.drawImage(customBgImage, 0, 0, canvas.width, canvas.height);
            } else {
                ctx.fillStyle = theme.bgColor;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            backgroundStars.forEach(star => {
                ctx.fillStyle = star.color;
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                ctx.fill();
                star.y += star.speed;
                if (star.y > canvas.height) {
                    star.y = -star.size;
                    star.x = Math.random() * canvas.width;
                }
            });
        }

        function drawPlayer() {
            ctx.save();
            ctx.translate(player.x, player.y);
            ctx.fillStyle = player.shipColor;

            switch (player.shipType) {
                case 'default':
                    ctx.beginPath();
                    ctx.moveTo(0, -player.size / 2);
                    ctx.lineTo(player.size / 2, player.size / 2);
                    ctx.lineTo(player.size / 3, player.size / 3);
                    ctx.lineTo(0, 0);
                    ctx.lineTo(-player.size / 3, player.size / 3);
                    ctx.lineTo(-player.size / 2, player.size / 2);
                    ctx.closePath();
                    ctx.fill();
                    ctx.fillStyle = '#FFFFFF';
                    ctx.beginPath();
                    ctx.arc(0, -player.size / 4, player.size / 8, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = `rgba(255, 69, 0, ${Math.sin(player.frameCount * 0.2) * 0.5 + 0.5})`;
                    ctx.fillRect(-player.size / 4, player.size / 2, player.size / 2, 5 + Math.sin(player.frameCount * 0.1) * 3);
                    break;

                case 'car':
                    ctx.fillRect(-player.size / 2, -player.size / 3, player.size, player.size / 2);
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(-player.size / 3, -player.size / 4, player.size / 1.5, player.size / 8);
                    ctx.fillStyle = '#FFFF00';
                    ctx.beginPath();
                    ctx.arc(-player.size / 2.5, -player.size / 6, 3, 0, Math.PI * 2);
                    ctx.arc(player.size / 2.5, -player.size / 6, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#000000';
                    for (let i = -1; i <= 1; i += 2) {
                        ctx.save();
                        ctx.translate(i * player.size / 3, player.size / 6);
                        ctx.rotate(player.wheelAngle);
                        ctx.beginPath();
                        ctx.arc(0, 0, player.size / 8, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.restore();
                    }
                    break;

                case 'plane':
                    ctx.beginPath();
                    ctx.moveTo(0, -player.size / 2);
                    ctx.lineTo(player.size / 2, player.size / 4);
                    ctx.lineTo(player.size / 3, player.size / 2);
                    ctx.lineTo(-player.size / 3, player.size / 2);
                    ctx.lineTo(-player.size / 2, player.size / 4);
                    ctx.closePath();
                    ctx.fill();
                    ctx.fillStyle = '#AAAAAA';
                    ctx.fillRect(-player.size / 6, -player.size / 2, player.size / 3, player.size / 2);
                    ctx.fillStyle = '#000000';
                    ctx.save();
                    ctx.translate(0, -player.size / 2);
                    ctx.rotate(player.propellerAngle);
                    ctx.fillRect(-player.size / 8, -player.size / 16, player.size / 4, player.size / 8);
                    ctx.restore();
                    break;

                case 'ufo':
                    ctx.beginPath();
                    ctx.ellipse(0, 0, player.size / 2, player.size / 4, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#AAAAAA';
                    ctx.beginPath();
                    ctx.ellipse(0, -player.size / 8, player.size / 3, player.size / 6, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = `rgba(0, 255, 255, ${Math.sin(player.frameCount * 0.2) * 0.5 + 0.5})`;
                    for (let i = -1; i <= 1; i += 2) {
                        ctx.beginPath();
                        ctx.arc(i * player.size / 3, player.size / 4, player.size / 12, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    break;

                case 'spaceship':
                    ctx.beginPath();
                    ctx.moveTo(0, -player.size / 2);
                    ctx.lineTo(player.size / 2, player.size / 3);
                    ctx.lineTo(player.size / 3, player.size / 2);
                    ctx.lineTo(-player.size / 3, player.size / 2);
                    ctx.lineTo(-player.size / 2, player.size / 3);
                    ctx.closePath();
                    ctx.fill();
                    ctx.fillStyle = '#FFFFFF';
                    ctx.beginPath();
                    ctx.arc(0, -player.size / 4, player.size / 10, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = `rgba(255, 165, 0, ${Math.sin(player.frameCount * 0.2) * 0.5 + 0.5})`;
                    ctx.fillRect(-player.size / 4, player.size / 2, player.size / 2, 10);
                    break;

                case 'tank':
                    ctx.fillRect(-player.size / 2, -player.size / 4, player.size, player.size / 2);
                    ctx.fillStyle = '#666633';
                    ctx.save();
                    ctx.rotate(Math.sin(player.frameCount * 0.05) * 0.1);
                    ctx.fillRect(-player.size / 8, -player.size / 2, player.size / 4, player.size / 2);
                    ctx.restore();
                    ctx.fillStyle = '#333333';
                    for (let i = -2; i <= 2; i++) {
                        ctx.fillRect(-player.size / 2 + i * player.size / 5, player.size / 4, player.size / 5, player.size / 8);
                    }
                    break;

                case 'dragon':
                    ctx.beginPath();
                    ctx.moveTo(0, -player.size / 2);
                    ctx.lineTo(player.size / 2, 0);
                    ctx.lineTo(player.size / 3, player.size / 2);
                    ctx.lineTo(-player.size / 3, player.size / 2);
                    ctx.lineTo(-player.size / 2, 0);
                    ctx.closePath();
                    ctx.fill();
                    ctx.fillStyle = '#FF4500';
                    ctx.beginPath();
                    ctx.moveTo(0, -player.size / 2);
                    ctx.lineTo(10 + Math.sin(player.frameCount * 0.1) * 5, -player.size / 2 - 15);
                    ctx.lineTo(-10 - Math.sin(player.frameCount * 0.1) * 5, -player.size / 2 - 15);
                    ctx.fill();
                    break;

                case 'cruiser':
                    ctx.fillRect(-player.size / 2, -player.size / 2, player.size, player.size);
                    ctx.fillStyle = '#AAAAAA';
                    ctx.beginPath();
                    ctx.arc(0, -player.size / 2, player.size / 4, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#FF0000';
                    ctx.fillRect(-player.size / 4, 0, player.size / 8, player.size / 4);
                    ctx.fillRect(player.size / 4 - player.size / 8, 0, player.size / 8, player.size / 4);
                    break;

                case 'bomber':
                    ctx.beginPath();
                    ctx.moveTo(0, -player.size / 2);
                    ctx.lineTo(player.size / 2, player.size / 4);
                    ctx.lineTo(player.size / 3, player.size / 2);
                    ctx.lineTo(-player.size / 3, player.size / 2);
                    ctx.lineTo(-player.size / 2, player.size / 4);
                    ctx.closePath();
                    ctx.fill();
                    ctx.fillStyle = '#666666';
                    ctx.fillRect(-player.size / 4, 0, player.size / 2, player.size / 4);
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(-player.size / 6, player.size / 2, player.size / 3, player.size / 8);
                    break;

                case 'pirate':
                    ctx.fillStyle = '#8B4513';
                    ctx.beginPath();
                    ctx.moveTo(-player.size / 2, player.size / 2);
                    ctx.lineTo(player.size / 2, player.size / 2);
                    ctx.lineTo(player.size / 3, -player.size / 4);
                    ctx.lineTo(-player.size / 3, -player.size / 4);
                    ctx.closePath();
                    ctx.fill();
                    ctx.fillStyle = '#FFFFFF';
                    ctx.beginPath();
                    ctx.moveTo(0, -player.size / 2);
                    ctx.lineTo(player.size / 4, -player.size / 8 + Math.sin(player.frameCount * 0.05) * 5);
                    ctx.lineTo(-player.size / 4, -player.size / 8 + Math.sin(player.frameCount * 0.05) * 5);
                    ctx.fill();
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(-player.size / 3, 0, player.size / 8, player.size / 8);
                    ctx.fillRect(player.size / 3 - player.size / 8, 0, player.size / 8, player.size / 8);
                    ctx.fillStyle = '#FFD700';
                    for (let i = 0; i < 3; i++) {
                        ctx.beginPath();
                        ctx.arc((Math.random() - 0.5) * player.size / 2, (Math.random() - 0.5) * player.size / 2, 2 + Math.sin(player.frameCount * 0.2 + i) * 2, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    break;

                case 'scout':
                    ctx.beginPath();
                    ctx.moveTo(0, -player.size / 2);
                    ctx.lineTo(player.size / 2, player.size / 2);
                    ctx.lineTo(-player.size / 2, player.size / 2);
                    ctx.closePath();
                    ctx.fill();
                    ctx.fillStyle = '#00FF00';
                    ctx.beginPath();
                    ctx.arc(0, -player.size / 4, player.size / 8, 0, Math.PI * 2);
                    ctx.fill();
                    if (player.radarActive) {
                        ctx.strokeStyle = '#00FF00';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.arc(0, 0, player.size * 2, 0, Math.PI * 2);
                        ctx.stroke();
                    }
                    break;

                case 'ranger':
                    ctx.beginPath();
                    ctx.moveTo(0, -player.size / 2);
                    ctx.lineTo(player.size / 3, player.size / 2);
                    ctx.lineTo(-player.size / 3, player.size / 2);
                    ctx.closePath();
                    ctx.fill();
                    ctx.fillStyle = '#FF00FF';
                    ctx.fillRect(-player.size / 4, player.size / 2, player.size / 2, 5);
                    break;

                case 'blaster':
                    ctx.beginPath();
                    ctx.arc(0, 0, player.size / 2, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#FFFFFF';
                    ctx.beginPath();
                    ctx.arc(0, -player.size / 4, player.size / 4, 0, Math.PI * 2);
                    ctx.fill();
                    break;

                case 'secretShip':
                    ctx.beginPath();
                    ctx.moveTo(0, -player.size / 2);
                    ctx.lineTo(player.size / 2, player.size / 2);
                    ctx.lineTo(-player.size / 2, player.size / 2);
                    ctx.closePath();
                    ctx.fill();
                    ctx.fillStyle = `rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, 0.8)`;
                    ctx.beginPath();
                    ctx.arc(0, 0, player.size / 3, 0, Math.PI * 2);
                    ctx.fill();
                    break;

                default:
                    ctx.beginPath();
                    ctx.moveTo(0, -player.size / 2);
                    ctx.lineTo(player.size / 2, player.size / 2);
                    ctx.lineTo(-player.size / 2, player.size / 2);
                    ctx.closePath();
                    ctx.fill();
                    ctx.fillStyle = `rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, 0.8)`;
                    ctx.beginPath();
                    ctx.arc(0, 0, player.size / 3, 0, Math.PI * 2);
                    ctx.fill();
                    break;
            }

            if (player.shipLevel >= 1 && player.shipType !== 'dragon') {
                ctx.fillStyle = '#00FFFF';
                ctx.fillRect(-player.size / 2 - 5, 0, 5, player.size / 2);
                ctx.fillRect(player.size / 2, 0, 5, player.size / 2);
            }
            if (player.shipLevel >= 2 && player.shipType !== 'dragon') {
                ctx.fillStyle = '#FF00FF';
                ctx.beginPath();
                ctx.moveTo(0, -player.size / 2 - 10);
                ctx.lineTo(5, -player.size / 2);
                ctx.lineTo(-5, -player.size / 2);
                ctx.fill();
            }
            if (player.shield > 0) {
                ctx.strokeStyle = '#00FF00';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(0, 0, player.size / 1.5, 0, Math.PI * 2);
                ctx.stroke();
            }

            ctx.restore();
        }

        function drawPacmen() {
            pacmen.forEach(pacman => {
                ctx.save();
                ctx.translate(pacman.x + pacman.size / 2, pacman.y + pacman.size / 2);
                ctx.rotate(pacman.spinAngle);
                ctx.fillStyle = theme.pacmanColor;

                if (pacman.isAI) {
                    const shape = Math.floor(Math.random() * 3);
                    if (shape === 0) { // Square AI
                        ctx.fillRect(-pacman.size / 2, -pacman.size / 2, pacman.size, pacman.size);
                        ctx.fillStyle = '#000000';
                        ctx.beginPath();
                        ctx.arc(0, -pacman.size / 4, pacman.size / 8, 0, Math.PI * 2);
                        ctx.fill();
                    } else if (shape === 1) { // Triangle AI
                        ctx.beginPath();
                        ctx.moveTo(0, -pacman.size / 2);
                        ctx.lineTo(pacman.size / 2, pacman.size / 2);
                        ctx.lineTo(-pacman.size / 2, pacman.size / 2);
                        ctx.closePath();
                        ctx.fill();
                        ctx.fillStyle = '#000000';
                        ctx.beginPath();
                        ctx.arc(0, -pacman.size / 4, pacman.size / 8, 0, Math.PI * 2);
                        ctx.fill();
                    } else { // Hexagon AI
                        ctx.beginPath();
                        for (let i = 0; i < 6; i++) {
                            ctx.lineTo(
                                pacman.size / 2 * Math.cos((2 * Math.PI * i) / 6),
                                pacman.size / 2 * Math.sin((2 * Math.PI * i) / 6)
                            );
                        }
                        ctx.closePath();
                        ctx.fill();
                        ctx.fillStyle = '#000000';
                        ctx.beginPath();
                        ctx.arc(0, -pacman.size / 4, pacman.size / 8, 0, Math.PI * 2);
                        ctx.fill();
                    }
                } else {
                    ctx.beginPath();
                    ctx.arc(0, 0, pacman.size / 2, pacman.mouthAngle, Math.PI * 2 - pacman.mouthAngle);
                    ctx.lineTo(0, 0);
                    ctx.fill();
                    ctx.fillStyle = '#000000';
                    ctx.beginPath();
                    ctx.arc(pacman.size / 5, -pacman.size / 4, pacman.size / 10, 0, Math.PI * 2);
                    ctx.fill();
                }

                ctx.restore();
                pacman.mouthAngle += pacman.mouthSpeed;
                if (!pacman.isAI && (pacman.mouthAngle > 0.4 || pacman.mouthAngle < 0)) pacman.mouthSpeed = -pacman.mouthSpeed;
                pacman.spinAngle += 0.02;
            });
        }

        function drawGhosts() {
            const ghostColors = ['#FF0000', '#FFB8FF', '#00FFFF', '#FFB852'];
            ghosts.forEach(ghost => {
                ctx.fillStyle = ghostColors[ghost.type];
                ctx.beginPath();
                ctx.arc(ghost.x + 10, ghost.y + 8, 10, Math.PI, 0, false);
                ctx.lineTo(ghost.x + 20, ghost.y + 20);
                ctx.lineTo(ghost.x + 16, ghost.y + 16);
                ctx.lineTo(ghost.x + 12, ghost.y + 20);
                ctx.lineTo(ghost.x + 8, ghost.y + 16);
                ctx.lineTo(ghost.x + 4, ghost.y + 20);
                ctx.lineTo(ghost.x, ghost.y + 8);
                ctx.closePath();
                ctx.fill();
                ctx.fillStyle = '#FFFFFF';
                ctx.beginPath();
                ctx.arc(ghost.x + 6, ghost.y + 6, 3, 0, Math.PI * 2);
                ctx.arc(ghost.x + 14, ghost.y + 6, 3, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#000000';
                ctx.beginPath();
                ctx.arc(ghost.x + 6, ghost.y + 6, 1, 0, Math.PI * 2);
                ctx.arc(ghost.x + 14, ghost.y + 6, 1, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        function drawBullets() {
            bullets.forEach(bullet => {
                ctx.shadowBlur = 10;
                ctx.shadowColor = theme.bulletColor;
                ctx.fillStyle = theme.bulletColor;
                if (player.shipType === 'pirate') {
                    ctx.font = '20px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('L', bullet.x, bullet.y);
                } else {
                    ctx.font = '20px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(player.bulletLetter, bullet.x, bullet.y);
                }
                ctx.shadowBlur = 0;
            });
        }

        function drawUpgrades() {
            upgrades.forEach(upgrade => {
                ctx.fillStyle = upgrade.color;
                ctx.beginPath();
                ctx.arc(upgrade.x + upgrade.size / 2, upgrade.y + upgrade.size / 2, upgrade.size / 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#FFFFFF';
                ctx.font = '12px Arial';
                ctx.fillText(upgrade.type[0].toUpperCase(), upgrade.x + upgrade.size / 2 - 3, upgrade.y + upgrade.size / 2 + 4);
            });
        }

        function drawBosses() {
            bosses.forEach(boss => {
                ctx.save();
                ctx.translate(boss.x + boss.size / 2, boss.y + boss.size / 2);
                ctx.rotate(boss.angle);
                ctx.fillStyle = '#FF4500';
                ctx.beginPath();
                ctx.arc(0, 0, boss.size / 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#000000';
                ctx.beginPath();
                ctx.arc(boss.size / 4, -boss.size / 4, boss.size / 8, 0, Math.PI * 2);
                ctx.arc(-boss.size / 4, -boss.size / 4, boss.size / 8, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
                boss.angle += boss.spinSpeed;
            });
        }

        function drawExplosions() {
            explosions.forEach((explosion, index) => {
                ctx.fillStyle = `rgba(255, 165, 0, ${explosion.opacity * 0.5})`;
                ctx.beginPath();
                ctx.arc(explosion.x, explosion.y, explosion.size, 0, Math.PI * 2);
                ctx.fill();
                explosion.size += 0.5;
                explosion.opacity -= 0.03;
                if (explosion.opacity <= 0) explosions.splice(index, 1);
            });
        }

        // Game mechanics
        function shoot() {
            if (player.shootCooldown <= 0) {
                if (player.bulletCount === 1) {
                    bullets.push({ x: player.x, y: player.y - player.size / 2 - 5, speed: player.bulletSpeed });
                } else if (player.bulletCount === 2) {
                    bullets.push({ x: player.x - 10, y: player.y - player.size / 2 - 5, speed: player.bulletSpeed });
                    bullets.push({ x: player.x + 10, y: player.y - player.size / 2 - 5, speed: player.bulletSpeed });
                } else {
                    bullets.push({ x: player.x - 15, y: player.y - player.size / 2 - 5, speed: player.bulletSpeed });
                    bullets.push({ x: player.x, y: player.y - player.size / 2 - 5, speed: player.bulletSpeed });
                    bullets.push({ x: player.x + 15, y: player.y - player.size / 2 - 5, speed: player.bulletSpeed });
                }
                player.shootCooldown = player.fireRate;
                playSound('shoot');
            }
        }

        function dropBomb() {
            if (player.bombCooldown <= 0 && player.shipType === 'bomber') {
                explosions.push({ x: player.x, y: player.y + player.size, size: 20, opacity: 1 });
                pacmen.forEach((pacman, index) => {
                    if (Math.abs(pacman.x - player.x) < 50 && Math.abs(pacman.y - (player.y + player.size)) < 50) {
                        pacman.health = 0;
                        pacmen.splice(index, 1);
                        score += 50;
                        player.coins += 10;
                        achievements.pacmanSlayer.count++;
                        if (achievements.pacmanSlayer.count >= achievementRequirements.pacmanSlayer && !achievements.pacmanSlayer.unlocked) {
                            achievements.pacmanSlayer.unlocked = true;
                            showMessage('Achievement Unlocked: Pac-Man Slayer!');
                        }
                        scoreDisplay.textContent = `Score: ${score}`;
                        coinsDisplay.textContent = `Coins: ${player.coins}`;
                        playSound('enemyHit');
                    }
                });
                player.bombCooldown = 60;
                playSound('bomb');
            }
        }

        function activateRadar() {
            if (player.shipType === 'scout' && !player.radarActive) {
                player.radarActive = true;
                setTimeout(() => player.radarActive = false, 5000);
            }
        }

        function update() {
            if (gameOver || isPaused) return;

            player.x += player.dx;
            player.y += player.dy;
            player.x = Math.max(player.size / 2, Math.min(canvas.width - player.size / 2, player.x));
            player.y = Math.max(player.size / 2, Math.min(canvas.height - player.size / 2, player.y));

            player.wheelAngle += 0.1;
            player.propellerAngle += 0.2;
            player.lightAngle += 0.05;
            player.flameOffset = Math.sin(player.frameCount * 0.1) * 5;
            player.flapAngle = Math.sin(player.frameCount * 0.1) * 0.2;
            if (player.bombCooldown > 0) player.bombCooldown--;

            if (player.shootCooldown > 0) player.shootCooldown--;
            if (isShooting) {
                shoot();
                if (player.shipType === 'bomber' && Math.random() < 0.05) dropBomb();
                if (player.shipType === 'scout' && Math.random() < 0.02) activateRadar();
            }

            spawnGhost();

            bullets.forEach((bullet, bIndex) => {
                bullet.y -= bullet.speed;
                if (bullet.y < 0) bullets.splice(bIndex, 1);
                pacmen.forEach((pacman, eIndex) => {
                    const bulletWidth = 10;
                    const bulletHeight = 20;
                    if (bullet.x > pacman.x - bulletWidth && bullet.x < pacman.x + pacman.size + bulletWidth &&
                        bullet.y > pacman.y - bulletHeight && bullet.y < pacman.y + pacman.size + bulletHeight) {
                        pacman.health--;
                        bullets.splice(bIndex, 1);
                        if (pacman.health <= 0) {
                            explosions.push({ x: pacman.x + pacman.size / 2, y: pacman.y + pacman.size / 2, size: 10, opacity: 1 });
                            pacmen.splice(eIndex, 1);
                            score += 50;
                            player.coins += 10;
                            achievements.pacmanSlayer.count++;
                            achievements.coinCollector.count += 10;
                            if (achievements.pacmanSlayer.count >= achievementRequirements.pacmanSlayer && !achievements.pacmanSlayer.unlocked) {
                                achievements.pacmanSlayer.unlocked = true;
                                showMessage('Achievement Unlocked: Pac-Man Slayer!');
                            }
                            if (achievements.coinCollector.count >= achievementRequirements.coinCollector && !achievements.coinCollector.unlocked) {
                                achievements.coinCollector.unlocked = true;
                                showMessage('Achievement Unlocked: Coin Collector!');
                            }
                            scoreDisplay.textContent = `Score: ${score}`;
                            coinsDisplay.textContent = `Coins: ${player.coins}`;
                            playSound('enemyHit');
                            if (gameMode === 'endless') {
                                pacmen.push({
                                    x: Math.random() * (canvas.width - 40),
                                    y: -40,
                                    size: 40,
                                    speed: 1 + level * 0.5,
                                    mouthAngle: 0,
                                    mouthSpeed: 0.05,
                                    spinAngle: 0,
                                    health: 1,
                                    isAI: useAIEnemies && Math.random() < 0.5,
                                    targetX: player.x,
                                    targetY: player.y
                                });
                            }
                        }
                    }
                });
                bosses.forEach((boss, bIndex) => {
                    if (bullet.x > boss.x && bullet.x < boss.x + boss.size &&
                        bullet.y > boss.y && bullet.y < boss.y + boss.size) {
                        boss.health--;
                        bullets.splice(bIndex, 1);
                        if (boss.health <= 0) {
                            explosions.push({ x: boss.x + boss.size / 2, y: boss.y + boss.size / 2, size: 50, opacity: 1 });
                            bosses.splice(bIndex, 1);
                            score += 500;
                            player.coins += 100;
                            achievements.bossBuster.count++;
                            if (achievements.bossBuster.count >= achievementRequirements.bossBuster && !achievements.bossBuster.unlocked) {
                                achievements.bossBuster.unlocked = true;
                                showMessage('Achievement Unlocked: Boss Buster!');
                            }
                            scoreDisplay.textContent = `Score: ${score}`;
                            coinsDisplay.textContent = `Coins: ${player.coins}`;
                            playSound('enemyHit');
                        }
                    }
                });
            });

            pacmen.forEach(pacman => {
                if (pacman.isAI) {
                    const dx = pacman.targetX - pacman.x;
                    const dy = pacman.targetY - pacman.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance > 5) {
                        pacman.x += (dx / distance) * pacman.speed;
                        pacman.y += (dy / distance) * pacman.speed;
                    }
                    pacman.targetX = player.x;
                    pacman.targetY = player.y;
                } else {
                    pacman.y += pacman.speed;
                }
                if (pacman.y > canvas.height) {
                    if (gameMode === 'endless') {
                        pacman.y = -pacman.size;
                        pacman.x = Math.random() * (canvas.width - pacman.size);
                    } else {
                        pacman.y = -pacman.size;
                        pacman.x = Math.random() * (canvas.width - pacman.size);
                    }
                }
                if (!isInvincible && Math.abs(pacman.x - player.x) < (pacman.size + player.size) / 2 &&
                    Math.abs(pacman.y - player.y) < (pacman.size + player.size) / 2) {
                    if (player.shield <= 0) {
                        player.lives--;
                        if (player.lives <= 0) {
                            gameOver = true;
                            playSound('death');
                            finalScore.textContent = `Score: ${score}`;
                            gameOverMenu.style.display = 'block';
                            gameOverMenu.style.opacity = '0';
                            setTimeout(() => gameOverMenu.style.opacity = '1', 10);
                        } else {
                            pacman.y = -pacman.size;
                            showMessage(`Lives remaining: ${player.lives}`);
                        }
                    } else {
                        pacman.y = -pacman.size;
                    }
                }
            });

            bosses.forEach(boss => {
                boss.y += boss.speed;
                if (boss.y > canvas.height) {
                    boss.y = -boss.size;
                    boss.x = Math.random() * (canvas.width - boss.size);
                }
                if (!isInvincible && Math.abs(boss.x + boss.size / 2 - player.x) < (boss.size + player.size) / 2 &&
                    Math.abs(boss.y + boss.size / 2 - player.y) < (boss.size + player.size) / 2) {
                    if (player.shield <= 0) {
                        player.lives -= 2;
                        if (player.lives <= 0) {
                            gameOver = true;
                            playSound('death');
                            finalScore.textContent = `Score: ${score}`;
                            gameOverMenu.style.display = 'block';
                            gameOverMenu.style.opacity = '0';
                            setTimeout(() => gameOverMenu.style.opacity = '1', 10);
                        } else {
                            boss.y = -boss.size;
                            showMessage(`Lives remaining: ${player.lives}`);
                        }
                    } else {
                        boss.y = -boss.size;
                    }
                }
            });

            if (player.shield > 0) player.shield--;

            upgrades.forEach((upgrade, uIndex) => {
                upgrade.y += upgrade.speed;
                if (upgrade.y > canvas.height) {
                    upgrades.splice(uIndex, 1);
                } else if (Math.abs(upgrade.x + upgrade.size / 2 - player.x) < (upgrade.size + player.size) / 2 &&
                           Math.abs(upgrade.y + upgrade.size / 2 - player.y) < (upgrade.size + player.size) / 2) {
                    playSound('upgrade');
                    switch (upgrade.type) {
                        case 'gun':
                            if (player.bulletCount < 3) player.bulletCount++;
                            else if (player.fireRate > 5) player.fireRate -= 5;
                            else player.bulletSpeed += 2;
                            break;
                        case 'ship':
                            player.shipLevel = Math.min(player.shipLevel + 1, 2);
                            break;
                        case 'shield':
                            player.shield = 100;
                            break;
                        case 'speed':
                            player.speed += 2;
                            setTimeout(() => player.speed -= 2, 10000);
                            break;
                        case 'multi':
                            player.bulletCount = 5;
                            setTimeout(() => player.bulletCount = 1, 10000);
                            break;
                    }
                    upgrades.splice(uIndex, 1);
                }
            });

            ghosts.forEach((ghost, index) => {
                ghost.y += ghost.speed;
                if (ghost.y > canvas.height) {
                    ghosts.splice(index, 1);
                } else if (Math.abs(ghost.x + 10 - player.x) < (player.size / 2 + 10) &&
                           Math.abs(ghost.y + 10 - player.y) < (player.size / 2 + 10)) {
                    score += 50;
                    player.coins += 5;
                    achievements.ghostHunter.count++;
                    achievements.coinCollector.count += 5;
                    if (achievements.ghostHunter.count >= achievementRequirements.ghostHunter && !achievements.ghostHunter.unlocked) {
                        achievements.ghostHunter.unlocked = true;
                        showMessage('Achievement Unlocked: Ghost Hunter!');
                    }
                    if (achievements.coinCollector.count >= achievementRequirements.coinCollector && !achievements.coinCollector.unlocked) {
                        achievements.coinCollector.unlocked = true;
                        showMessage('Achievement Unlocked: Coin Collector!');
                    }
                    scoreDisplay.textContent = `Score: ${score}`;
                    coinsDisplay.textContent = `Coins: ${player.coins}`;
                    playSound('waka');
                    ghosts.splice(index, 1);
                }
            });

            if (gameMode === 'classic' && pacmen.length === 0 && bosses.length === 0) {
                level++;
                player.coins += 50;
                achievements.levelMaster.count++;
                achievements.coinCollector.count += 50;
                if (achievements.levelMaster.count >= achievementRequirements.levelMaster && !achievements.levelMaster.unlocked) {
                    achievements.levelMaster.unlocked = true;
                    showMessage('Achievement Unlocked: Level Master!');
                }
                if (achievements.coinCollector.count >= achievementRequirements.coinCollector && !achievements.coinCollector.unlocked) {
                    achievements.coinCollector.unlocked = true;
                    showMessage('Achievement Unlocked: Coin Collector!');
                }
                initLevel();
                levelDisplay.textContent = `Level: ${level}`;
                coinsDisplay.textContent = `Coins: ${player.coins}`;
            } else if (gameMode === 'survival' && Math.random() < 0.05) {
                pacmen.push({
                    x: Math.random() * (canvas.width - 40),
                    y: -40,
                    size: 40,
                    speed: 2 + level * 0.5,
                    mouthAngle: 0,
                    mouthSpeed: 0.05,
                    spinAngle: 0,
                    health: 1,
                    isAI: useAIEnemies && Math.random() < 0.5,
                    targetX: player.x,
                    targetY: player.y
                });
            }

            if (score > challengeScore && challengeScore > 0) {
                showMessage('You beat your friend\'s score!');
                challengeScore = 0;
            }
        }

        function gameLoop() {
            try {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawBackground();
                drawPlayer();
                drawPacmen();
                drawGhosts();
                drawBullets();
                drawUpgrades();
                drawBosses();
                drawExplosions();
                update();
                player.frameCount++;
                if (!gameOver && !isPaused) requestAnimationFrame(gameLoop);
            } catch (err) {
                console.error('Game loop crashed:', err);
                gameOver = true;
            }
        }

        // Event listeners
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') player.dx = -player.speed;
            if (e.key === 'ArrowRight') player.dx = player.speed;
            if (e.key === 'ArrowUp') player.dy = -player.speed;
            if (e.key === 'ArrowDown') player.dy = player.speed;
            if (e.key === ' ') {
                if (!gameOver) isShooting = true;
                else if (!isMobile && gameOverMenu.style.display === 'block') restartGame();
            }
            if (e.key === 'Escape' && !gameOver) pauseGame();
            if (e.key === 'b' && player.shipType === 'bomber') dropBomb();
            if (e.key === 'r' && player.shipType === 'scout') activateRadar();
        });

        document.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') player.dx = 0;
            if (e.key === 'ArrowUp' || e.key === 'ArrowDown') player.dy = 0;
            if (e.key === ' ' && !gameOver) isShooting = false;
        });

        joystick.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.changedTouches[0];
            moveTouchId = touch.identifier;
            const rect = joystick.getBoundingClientRect();
            const dx = (touch.clientX - rect.left - 50) / 50;
            const dy = (touch.clientY - rect.top - 50) / 50;
            player.dx = Math.max(-1, Math.min(1, dx)) * player.speed;
            player.dy = Math.max(-1, Math.min(1, dy)) * player.speed;
            joystickNub.style.left = `${50 + dx * 30}%`;
            joystickNub.style.top = `${50 + dy * 30}%`;
        }, { passive: false });

        joystick.addEventListener('touchmove', (e) => {
            e.preventDefault();
            for (let touch of e.changedTouches) {
                if (touch.identifier === moveTouchId) {
                    const rect = joystick.getBoundingClientRect();
                    const dx = Math.max(-1, Math.min(1, (touch.clientX - rect.left - 50) / 50));
                    const dy = Math.max(-1, Math.min(1, (touch.clientY - rect.top - 50) / 50));
                    player.dx = dx * player.speed;
                    player.dy = dy * player.speed;
                    joystickNub.style.left = `${50 + dx * 30}%`;
                    joystickNub.style.top = `${50 + dy * 30}%`;
                    break;
                }
            }
        }, { passive: false });

        joystick.addEventListener('touchend', (e) => {
            e.preventDefault();
            for (let touch of e.changedTouches) {
                if (touch.identifier === moveTouchId) {
                    player.dx = 0;
                    player.dy = 0;
                    joystickNub.style.left = '50%';
                    joystickNub.style.top = '50%';
                    moveTouchId = null;
                    break;
                }
            }
        }, { passive: false });

        shootBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            isShooting = true;
            if (player.shipType === 'bomber') dropBomb();
            if (player.shipType === 'scout') activateRadar();
        }, { passive: false });

        shootBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            isShooting = false;
        }, { passive: false });

        // Debug functions
        function debugAddScore(amount) { score += amount; scoreDisplay.textContent = `Score: ${score}`; }
        function debugNextLevel() { level++; initLevel(); levelDisplay.textContent = `Level: ${level}`; }
        function debugSpawnUpgrade() {
            upgrades.push({
                x: player.x, y: player.y - 50, size: 20, speed: 2,
                type: ['gun', 'ship', 'shield', 'speed', 'multi'][Math.floor(Math.random() * 5)],
                color: ['#FF0000', '#0000FF', '#00FF00', '#FFFF00', '#FF00FF'][Math.floor(Math.random() * 5)]
            });
        }
        function debugToggleInvincibility() { isInvincible = !isInvincible; showMessage(`Invincibility ${isInvincible ? 'ON' : 'OFF'}`); }
        function debugResetGame() { init(); scoreDisplay.textContent = `Score: ${score}`; levelDisplay.textContent = `Level: ${level}`; coinsDisplay.textContent = `Coins: ${player.coins}`; }
        function debugMaxBullets() { player.bulletCount = 5; showMessage('Max Bullets Activated!'); }
        function debugMaxSpeed() { player.speed = 15; showMessage('Max Speed Activated!'); }
        function debugInfiniteShield() { player.shield = Infinity; showMessage('Infinite Shield Activated!'); }
        function debugKillAllPacmen() { pacmen = []; showMessage('All Pacmen Killed!'); }
        function debugSpawnGhosts(count) { for (let i = 0; i < count; i++) spawnGhost(); showMessage(`${count} Ghosts Spawned!`); }
        function debugIncreaseFireRate() { player.fireRate = Math.max(5, player.fireRate - 5); showMessage('Fire Rate Increased!'); }
        function debugUnlockAllShips() { ownedShips = [...ownedShips, ...baseShips.filter(s => !ownedShips.includes(s))]; updateShipSelect(shipSelect); updateShipSelect(pauseShipSelect); showMessage('All Base Ships Unlocked!'); }
        function debugDoubleSize() { player.size *= 2; showMessage('Player Size Doubled!'); }
        function debugHalfSize() { player.size /= 2; showMessage('Player Size Halved!'); }
        function debugInstantLevel10() { level = 10; initLevel(); levelDisplay.textContent = `Level: ${level}`; showMessage('Jumped to Level 10!'); }
        function debugSlowEnemies() { pacmen.forEach(p => p.speed /= 2); showMessage('Enemies Slowed!'); }
        function debugFastEnemies() { pacmen.forEach(p => p.speed *= 2); showMessage('Enemies Sped Up!'); }
        function debugExtraLives(count) { player.lives += count; showMessage(`Added ${count} Lives! Lives: ${player.lives}`); }
        function debugUnlockAchievements() { for (let a in achievements) achievements[a].unlocked = true; updateAchievementsList(); showMessage('All Achievements Unlocked!'); }
        function debugAddCoins(amount) { player.coins += amount; coinsDisplay.textContent = `Coins: ${player.coins}`; showMessage(`Added ${amount} Coins!`); }

        // Additional features
        function syncLeaderboard() {
            console.log('Leaderboard sync not implemented in this version. Use Firebase for online sync.');
        }

        function shareScore() {
            if (navigator.share) {
                navigator.share({
                    title: 'PacInvaders Score',
                    text: `${playerNameInput.value.trim()} scored ${score} in PacInvaders!`,
                    url: window.location.href
                }).catch(() => showMessage('Sharing failed!'));
            } else {
                showMessage('Sharing only available on mobile browsers with Web Share API support!');
            }
        }

        function copyScore() {
            navigator.clipboard.writeText(`My PacInvaders Score: ${score}`).then(() => {
                showMessage('Score copied to clipboard!');
            }).catch(() => showMessage('Failed to copy score!'));
        }

        function challengeFriend() {
            const friendScore = parseInt(document.getElementById('challenge-score-input')?.value);
            if (!isNaN(friendScore) && friendScore > 0) {
                challengeScore = friendScore;
                showMessage(`Challenge set! Beat ${friendScore} to win!`);
                document.getElementById('challenge-score-input').value = '';
            } else {
                showMessage('Please enter a valid score to challenge!');
            }
        }

        // PayPal integration
        function initPayPalButtons() {
            if (typeof paypal === 'undefined') {
                console.error('PayPal SDK not loaded');
                showMessage('Payment system unavailable. Please try again later.');
                return;
            }

            paypal.Buttons({
                createOrder: (data, actions) => {
                    return actions.order.create({
                        purchase_units: [{
                            amount: { value: prices.premium.toFixed(2), currency_code: 'GBP' },
                            description: 'Space Pac-Invaders Premium Upgrade'
                        }]
                    });
                },
                onApprove: (data, actions) => {
                    return actions.order.capture().then(details => {
                        isPremium = true;
                        localStorage.setItem('isPremium', 'true');
                        bgImageInput.disabled = false;
                        bgMusicInput.disabled = false;
                        document.getElementById('premium-options').style.display = 'block';
                        player.fireRate = 15;
                        player.lives = 3;
                        updateShipSelect(shipSelect);
                        updateShipSelect(pauseShipSelect);
                        showMessage(`Thank you, ${details.payer.name.given_name}! Premium unlocked! Enjoy faster fire rate and extra lives.`);
                    });
                },
                onError: (err) => {
                    console.error('PayPal Premium Purchase Error:', err);
                    showMessage('Payment failed! Please try again.');
                }
            }).render('#paypal-premium-container');

            paypal.Buttons({
                createOrder: (data, actions) => {
                    return actions.order.create({
                        purchase_units: [{
                            amount: { value: prices.ship.toFixed(2), currency_code: 'GBP' },
                            description: 'Space Pac-Invaders Car Ship'
                        }]
                    });
                },
                onApprove: (data, actions) => {
                    return actions.order.capture().then(details => {
                        if (!ownedShips.includes('car')) {
                            ownedShips.push('car');
                            localStorage.setItem('ownedShips', JSON.stringify(ownedShips));
                            updateShipSelect(shipSelect);
                            updateShipSelect(pauseShipSelect);
                            showMessage(`Thank you, ${details.payer.name.given_name}! Car ship purchased!`);
                        } else {
                            showMessage('You already own the Car ship!');
                        }
                    });
                },
                onError: (err) => {
                    console.error('PayPal Car Purchase Error:', err);
                    showMessage('Payment failed! Please try again.');
                }
            }).render('#paypal-car-container');

            paypal.Buttons({
                createOrder: (data, actions) => {
                    return actions.order.create({
                        purchase_units: [{
                            amount: { value: prices.ship.toFixed(2), currency_code: 'GBP' },
                            description: 'Space Pac-Invaders Plane Ship'
                        }]
                    });
                },
                onApprove: (data, actions) => {
                    return actions.order.capture().then(details => {
                        if (!ownedShips.includes('plane')) {
                            ownedShips.push('plane');
                            localStorage.setItem('ownedShips', JSON.stringify(ownedShips));
                            updateShipSelect(shipSelect);
                            updateShipSelect(pauseShipSelect);
                            showMessage(`Thank you, ${details.payer.name.given_name}! Plane ship purchased!`);
                        } else {
                            showMessage('You already own the Plane ship!');
                        }
                    });
                },
                onError: (err) => {
                    console.error('PayPal Plane Purchase Error:', err);
                    showMessage('Payment failed! Please try again.');
                }
            }).render('#paypal-plane-container');

            paypal.Buttons({
                createOrder: (data, actions) => {
                    return actions.order.create({
                        purchase_units: [{
                            amount: { value: prices.ship.toFixed(2), currency_code: 'GBP' },
                            description: 'Space Pac-Invaders UFO Ship'
                        }]
                    });
                },
                onApprove: (data, actions) => {
                    return actions.order.capture().then(details => {
                        if (!ownedShips.includes('ufo')) {
                            ownedShips.push('ufo');
                            localStorage.setItem('ownedShips', JSON.stringify(ownedShips));
                            updateShipSelect(shipSelect);
                            updateShipSelect(pauseShipSelect);
                            showMessage(`Thank you, ${details.payer.name.given_name}! UFO ship purchased!`);
                        } else {
                            showMessage('You already own the UFO ship!');
                        }
                    });
                },
                onError: (err) => {
                    console.error('PayPal UFO Purchase Error:', err);
                    showMessage('Payment failed! Please try again.');
                }
            }).render('#paypal-ufo-container');

            paypal.Buttons({
                createOrder: (data, actions) => {
                    return actions.order.create({
                        purchase_units: [{
                            amount: { value: prices.ship.toFixed(2), currency_code: 'GBP' },
                            description: 'Space Pac-Invaders Spaceship'
                        }]
                    });
                },
                onApprove: (data, actions) => {
                    return actions.order.capture().then(details => {
                        if (!ownedShips.includes('spaceship')) {
                            ownedShips.push('spaceship');
                            localStorage.setItem('ownedShips', JSON.stringify(ownedShips));
                            updateShipSelect(shipSelect);
                            updateShipSelect(pauseShipSelect);
                            showMessage(`Thank you, ${details.payer.name.given_name}! Spaceship purchased!`);
                        } else {
                            showMessage('You already own the Spaceship!');
                        }
                    });
                },
                onError: (err) => {
                    console.error('PayPal Spaceship Purchase Error:', err);
                    showMessage('Payment failed! Please try again.');
                }
            }).render('#paypal-spaceship-container');

            paypal.Buttons({
                createOrder: (data, actions) => {
                    return actions.order.create({
                        purchase_units: [{
                            amount: { value: prices.ship.toFixed(2), currency_code: 'GBP' },
                            description: 'Space Pac-Invaders Tank Ship'
                        }]
                    });
                },
                onApprove: (data, actions) => {
                    return actions.order.capture().then(details => {
                        if (!ownedShips.includes('tank')) {
                            ownedShips.push('tank');
                            localStorage.setItem('ownedShips', JSON.stringify(ownedShips));
                            updateShipSelect(shipSelect);
                            updateShipSelect(pauseShipSelect);
                            showMessage(`Thank you, ${details.payer.name.given_name}! Tank ship purchased!`);
                        } else {
                            showMessage('You already own the Tank ship!');
                        }
                    });
                },
                onError: (err) => {
                    console.error('PayPal Tank Purchase Error:', err);
                    showMessage('Payment failed! Please try again.');
                }
            }).render('#paypal-tank-container');

            paypal.Buttons({
                createOrder: (data, actions) => {
                    return actions.order.create({
                        purchase_units: [{
                            amount: { value: prices.ship.toFixed(2), currency_code: 'GBP' },
                            description: 'Space Pac-Invaders Dragon Ship'
                        }]
                    });
                },
                onApprove: (data, actions) => {
                    return actions.order.capture().then(details => {
                        if (!ownedShips.includes('dragon')) {
                            ownedShips.push('dragon');
                            localStorage.setItem('ownedShips', JSON.stringify(ownedShips));
                            updateShipSelect(shipSelect);
                            updateShipSelect(pauseShipSelect);
                            showMessage(`Thank you, ${details.payer.name.given_name}! Dragon ship purchased!`);
                        } else {
                            showMessage('You already own the Dragon ship!');
                        }
                    });
                },
                onError: (err) => {
                    console.error('PayPal Dragon Purchase Error:', err);
                    showMessage('Payment failed! Please try again.');
                }
            }).render('#paypal-dragon-container');

            paypal.Buttons({
                createOrder: (data, actions) => {
                    return actions.order.create({
                        purchase_units: [{
                            amount: { value: prices.ship.toFixed(2), currency_code: 'GBP' },
                            description: 'Space Pac-Invaders Cruiser Ship'
                        }]
                    });
                },
                onApprove: (data, actions) => {
                    return actions.order.capture().then(details => {
                        if (!ownedShips.includes('cruiser')) {
                            ownedShips.push('cruiser');
                            localStorage.setItem('ownedShips', JSON.stringify(ownedShips));
                            updateShipSelect(shipSelect);
                            updateShipSelect(pauseShipSelect);
                            showMessage(`Thank you, ${details.payer.name.given_name}! Cruiser ship purchased!`);
                        } else {
                            showMessage('You already own the Cruiser ship!');
                        }
                    });
                },
                onError: (err) => {
                    console.error('PayPal Cruiser Purchase Error:', err);
                    showMessage('Payment failed! Please try again.');
                }
            }).render('#paypal-cruiser-container');

            paypal.Buttons({
                createOrder: (data, actions) => {
                    return actions.order.create({
                        purchase_units: [{
                            amount: { value: prices.ship.toFixed(2), currency_code: 'GBP' },
                            description: 'Space Pac-Invaders Bomber Ship'
                        }]
                    });
                },
                onApprove: (data, actions) => {
                    return actions.order.capture().then(details => {
                        if (!ownedShips.includes('bomber')) {
                            ownedShips.push('bomber');
                            localStorage.setItem('ownedShips', JSON.stringify(ownedShips));
                            updateShipSelect(shipSelect);
                            updateShipSelect(pauseShipSelect);
                            showMessage(`Thank you, ${details.payer.name.given_name}! Bomber ship purchased!`);
                        } else {
                            showMessage('You already own the Bomber ship!');
                        }
                    });
                },
                onError: (err) => {
                    console.error('PayPal Bomber Purchase Error:', err);
                    showMessage('Payment failed! Please try again.');
                }
            }).render('#paypal-bomber-container');

            paypal.Buttons({
                createOrder: (data, actions) => {
                    return actions.order.create({
                        purchase_units: [{
                            amount: { value: prices.ship.toFixed(2), currency_code: 'GBP' },
                            description: 'Space Pac-Invaders Pirate Ship'
                        }]
                    });
                },
                onApprove: (data, actions) => {
                    return actions.order.capture().then(details => {
                        if (!ownedShips.includes('pirate')) {
                            ownedShips.push('pirate');
                            localStorage.setItem('ownedShips', JSON.stringify(ownedShips));
                            updateShipSelect(shipSelect);
                            updateShipSelect(pauseShipSelect);
                            showMessage(`Thank you, ${details.payer.name.given_name}! Pirate ship purchased!`);
                        } else {
                            showMessage('You already own the Pirate ship!');
                        }
                    });
                },
                onError: (err) => {
                    console.error('PayPal Pirate Purchase Error:', err);
                    showMessage('Payment failed! Please try again.');
                }
            }).render('#paypal-pirate-container');

            paypal.Buttons({
                createOrder: (data, actions) => {
                    return actions.order.create({
                        purchase_units: [{
                            amount: { value: prices.random.toFixed(2), currency_code: 'GBP' },
                            description: 'Space Pac-Invaders Random AI Ship'
                        }]
                    });
                },
                onApprove: (data, actions) => {
                    return actions.order.capture().then(details => {
                        const newShip = generateUniqueShipName();
                        ownedShips.push(newShip);
                        localStorage.setItem('ownedShips', JSON.stringify(ownedShips));
                        updateShipSelect(shipSelect);
                        updateShipSelect(pauseShipSelect);
                        showMessage(`Thank you, ${details.payer.name.given_name}! You got a unique AI ship: ${newShip}!`);
                    });
                },
                onError: (err) => {
                    console.error('PayPal Random Ship Purchase Error:', err);
                    showMessage('Payment failed! Please try again.');
                }
            }).render('#paypal-random-container');

            paypal.Buttons({
                createOrder: (data, actions) => {
                    return actions.order.create({
                        purchase_units: [{
                            amount: { value: prices.speedboost.toFixed(2), currency_code: 'GBP' },
                            description: 'Space Pac-Invaders Speed Boost'
                        }]
                    });
                },
                onApprove: (data, actions) => {
                    return actions.order.capture().then(details => {
                        if (!player.speedBoost) {
                            player.speedBoost = true;
                            localStorage.setItem('speedBoost', 'true');
                            player.speed = 10;
                            showMessage(`Thank you, ${details.payer.name.given_name}! Speed Boost purchased! Your speed is now doubled.`);
                        } else {
                            showMessage('You already have the Speed Boost!');
                        }
                    });
                },
                onError: (err) => {
                    console.error('PayPal Speed Boost Purchase Error:', err);
                    showMessage('Payment failed! Please try again.');
                }
            }).render('#paypal-speedboost-container');

            paypal.Buttons({
                createOrder: (data, actions) => {
                    return actions.order.create({
                        purchase_units: [{
                            amount: { value: prices.shieldpack.toFixed(2), currency_code: 'GBP' },
                            description: 'Space Pac-Invaders Shield Pack'
                        }]
                    });
                },
                onApprove: (data, actions) => {
                    return actions.order.capture().then(details => {
                        if (!player.shieldPack) {
                            player.shieldPack = true;
                            localStorage.setItem('shieldPack', 'true');
                            player.shield = 200;
                            showMessage(`Thank you, ${details.payer.name.given_name}! Shield Pack purchased! Your shield is now doubled.`);
                        } else {
                            showMessage('You already have the Shield Pack!');
                        }
                    });
                },
                onError: (err) => {
                    console.error('PayPal Shield Pack Purchase Error:', err);
                    showMessage('Payment failed! Please try again.');
                }
            }).render('#paypal-shieldpack-container');
        }

        // Initialize game
        loadSettings();
        initPayPalButtons();
    </script>
</body>
</html>