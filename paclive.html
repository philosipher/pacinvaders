<!DOCTYPE html>
<html>
<head>
  <title>Space Pac-Invaders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    canvas {
      border: 1px solid #00FFFF;
      background: #000000;
      max-width: 100%;
      height: auto;
      display: none;
      touch-action: none;
    }
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background: #000000;
      overflow: hidden;
      touch-action: none;
      font-family: Arial, sans-serif;
    }
    #menu, #settings-menu, #game-over-menu, #pause-menu, #achievements-menu, #shop-menu, #debug-menu {
      text-align: center;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      transition: opacity 0.5s ease;
      max-height: 80vh;
      overflow-y: auto;
      padding: 10px;
      box-sizing: border-box;
      opacity: 1;
    }
    #settings-menu, #game-over-menu, #pause-menu, #achievements-menu, #shop-menu, #debug-menu {
      display: none;
    }
    #game-over-menu, #pause-menu, #achievements-menu, #shop-menu, #debug-menu {
      background: rgba(0, 0, 0, 0.8);
      padding: 20px;
      border-radius: 10px;
      animation: popIn 0.3s ease-out;
    }
    #debug-menu {
      max-height: 60vh;
      overflow-y: scroll;
      width: 300px;
    }
    #logo {
      font-size: 48px;
      font-weight: bold;
      margin-bottom: 20px;
      text-shadow: 2px 2px 4px #00FFFF;
      animation: bounce 2s infinite;
    }
    #made-by {
      font-size: 24px;
      margin-bottom: 20px;
    }
    #start-btn, #settings-btn, #back-btn, #save-settings-btn, #main-menu-btn, #restart-btn, #game-over-settings-btn, #leaderboard-btn, #leaderboard-go-btn, #rules-btn, #resume-btn, #pause-settings-btn, #share-btn, #redeem-code-btn, #donateBtn, #achievementsBtn, #back-to-menu-achievements, #shop-btn, #purchase-premium-btn, .shop-item-btn, .debug-btn {
      padding: 10px 20px;
      font-size: 20px;
      background: #00FFFF;
      color: #000000;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px;
      transition: background 0.3s, transform 0.2s;
    }
    #start-btn:hover, #settings-btn:hover, #back-btn:hover, #save-settings-btn:hover, #main-menu-btn:hover, #restart-btn:hover, #game-over-settings-btn:hover, #leaderboard-btn:hover, #leaderboard-go-btn:hover, #rules-btn:hover, #resume-btn:hover, #pause-settings-btn:hover, #share-btn:hover, #redeem-code-btn:hover, #donateBtn:hover, #achievementsBtn:hover, #back-to-menu-achievements:hover, #shop-btn:hover, #purchase-premium-btn:hover, .shop-item-btn:hover, .debug-btn:hover {
      background: #00baba;
      transform: scale(1.1);
    }
    #theme-select, #ship-select, #bg-image-input, #bg-music-input, #game-volume, #music-volume, .color-picker, .sound-input, #code-input {
      padding: 5px;
      font-size: 16px;
      background: #000000;
      color: #FFFF00;
      border: 1px solid #00FFFF;
      border-radius: 5px;
      margin: 5px;
    }
    #player-name {
      padding: 5px;
      font-size: 16px;
      background: #000000;
      color: #FFFF00;
      border: 1px solid #00FFFF;
      border-radius: 5px;
      margin: 10px;
    }
    label {
      display: block;
      margin: 5px 0;
    }
    #score, #level {
      font-family: Arial;
      position: absolute;
      z-index: 10;
      display: none;
    }
    #score { top: 10px; left: 10px; }
    #level { top: 10px; right: 10px; }
    #leaderboard {
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      border-radius: 5px;
      font-size: 16px;
      max-height: 50vh;
      overflow-y: auto;
      position: absolute;
      z-index: 10;
    }
    #joystick {
      position: absolute;
      bottom: 20px;
      left: 20px;
      width: 100px;
      height: 100px;
      background: rgba(255, 255, 0, 0.2);
      border-radius: 50%;
      touch-action: none;
      display: none;
    }
    #joystick-nub {
      position: absolute;
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 0, 0.5);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      top: 50%;
      left: 50%;
    }
    #shoot-btn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 80px;
      height: 80px;
      background: rgba(0, 255, 255, 0.5);
      border-radius: 50%;
      border: none;
      touch-action: none;
      display: none;
    }
    #control-bar {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 20;
      display: none;
    }
    #sound-btn, #pause-resume-btn {
      width: 50px;
      height: 50px;
      background: rgba(0, 255, 255, 0.8);
      color: #000000;
      border: 2px solid #00FFFF;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.2s, background 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #sound-btn:hover, #pause-resume-btn:hover {
      background: rgba(0, 186, 186, 0.8);
      transform: scale(1.1);
    }
    #sound-btn.muted {
      background: rgba(255, 0, 0, 0.8);
    }
    #messageDisplay {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: #FFF;
      padding: 10px;
      border-radius: 5px;
      display: none;
      z-index: 30;
    }
    .shop-item {
      display: inline-block;
      margin: 10px;
      text-align: center;
    }
    .shop-item img {
      width: 50px;
      height: 50px;
      border: 1px solid #00FFFF;
    }
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-15px); }
      60% { transform: translateY(-7px); }
    }
    @keyframes popIn {
      from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
      to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
  </style>
</head>
<body>
  <div id="menu">
    <div id="logo">PacInvaders</div>
    <div id="made-by">Made by Philo Sipher</div>
    <input type="text" id="player-name" placeholder="Enter your name" maxlength="10">
    <button id="start-btn" onclick="startGame()">Start Game</button>
    <button id="settings-btn" onclick="showSettings()">Settings</button>
    <button id="leaderboard-btn" onclick="showLeaderboard('main')">Leaderboard</button>
    <button id="rules-btn" onclick="showRules()">Rules</button>
    <button id="achievementsBtn" onclick="showAchievements()">Achievements</button>
    <button id="donateBtn" onclick="window.open('https://www.paypal.me/kingphilosipher', '_blank')">Donate via PayPal</button>
    <button id="shop-btn" onclick="showShop()">Shop</button>
    <br>
    <select id="theme-select" onchange="changeTheme()">
      <option value="default">Default</option>
      <option value="retro">Retro</option>
      <option value="neon">Neon</option>
      <option value="solar">Solar</option>
      <option value="cosmic">Cosmic</option>
      <option value="galaxy">Galaxy</option>
      <option value="cyber">Cyber</option>
      <option value="dark">Dark</option>
    </select>
    <div id="leaderboard-main"></div>
    <div id="rules-section" style="display: none; color: #FFFF00; font-size: 18px; margin-top: 20px;"></div>
  </div>
  <div id="settings-menu">
    <div id="logo">Settings</div>
    <input type="file" id="bg-image-input" accept="image/png, image/jpeg" onchange="uploadBackgroundImage()" disabled>
    <label for="bg-image-input">Upload Background Image (PNG/JPG) - Premium Only</label>
    <br>
    <input type="file" id="bg-music-input" accept="audio/mp3" onchange="uploadBackgroundMusic()" disabled>
    <label for="bg-music-input">Upload Background Music (MP3) - Premium Only</label>
    <br>
    <input type="range" id="game-volume" min="0" max="1" step="0.1" value="0.5">
    <label for="game-volume">Game Sound Volume</label>
    <br>
    <input type="range" id="music-volume" min="0" max="1" step="0.1" value="0.5">
    <label for="music-volume">Music Volume</label>
    <br>
    <select id="ship-select" onchange="changeShip()">
      <option value="default">Default Ship</option>
    </select>
    <label for="ship-select">Ship Type</label>
    <br>
    <div id="custom-theme" style="display: none;">
      <input type="color" id="player-color" value="#FFFF00"><label for="player-color">Player Color</label>
      <input type="color" id="pacman-color" value="#FFFF00"><label for="pacman-color">Pac-Man Color</label>
      <input type="color" id="ghost-color" value="#FF0000"><label for="ghost-color">Ghost Color</label>
      <input type="color" id="bullet-color" value="#FF00FF"><label for="bullet-color">Bullet Color</label>
      <input type="color" id="bg-color" value="#000033"><label for="bg-color">Background Color</label>
      <input type="color" id="border-color" value="#00FFFF"><label for="border-color">Border Color</label>
      <input type="color" id="button-color" value="#00FFFF"><label for="button-color">Button Color</label>
      <input type="color" id="menu-color" value="#000000"><label for="menu-color">Menu Background Color</label>
      <input type="color" id="text-color" value="#FFFF00"><label for="text-color">Text Color</label>
    </div>
    <div id="custom-sounds">
      <input type="file" id="waka-sound" accept="audio/mp3" class="sound-input" onchange="uploadSound('waka')">
      <label for="waka-sound">Waka Sound (MP3)</label>
      <input type="file" id="death-sound" accept="audio/mp3" class="sound-input" onchange="uploadSound('death')">
      <label for="death-sound">Death Sound (MP3)</label>
      <input type="file" id="shoot-sound" accept="audio/mp3" class="sound-input" onchange="uploadSound('shoot')">
      <label for="shoot-sound">Shoot Sound (MP3)</label>
      <input type="file" id="enemy-hit-sound" accept="audio/mp3" class="sound-input" onchange="uploadSound('enemyHit')">
      <label for="enemy-hit-sound">Pac-Man Hit Sound (MP3)</label>
      <input type="file" id="upgrade-sound" accept="audio/mp3" class="sound-input" onchange="uploadSound('upgrade')">
      <label for="upgrade-sound">Upgrade Sound (MP3)</label>
    </div>
    <input type="text" id="code-input" placeholder="Enter code">
    <button id="redeem-code-btn" onclick="redeemCode()">Redeem Code</button>
    <button id="purchase-premium-btn" onclick="purchasePremium()">Buy Premium (£15)</button>
    <button id="save-settings-btn" onclick="saveSettings()">Save Settings</button>
    <button id="back-btn" onclick="backToMenu()">Back</button>
  </div>
  <div id="game-over-menu">
    <div id="logo">Game Over</div>
    <div id="final-score">Score: 0</div>
    <button id="main-menu-btn" onclick="backToMainMenu()">Main Menu</button>
    <button id="restart-btn" onclick="restartGame()">Restart (Spacebar on PC)</button>
    <button id="game-over-settings-btn" onclick="showSettingsFromGameOver()">Settings</button>
    <button id="leaderboard-go-btn" onclick="showLeaderboard('go')">Leaderboard</button>
    <button id="share-btn" onclick="shareScore()">Share Score</button>
    <div id="leaderboard-go"></div>
  </div>
  <div id="pause-menu">
    <div id="logo">Paused</div>
    <button id="resume-btn" onclick="resumeGame()">Resume</button>
    <button id="pause-settings-btn" onclick="showSettingsFromPause()">Settings</button>
    <button id="main-menu-btn" onclick="backToMainMenuFromPause()">Main Menu</button>
  </div>
  <div id="achievements-menu">
    <div id="logo">Achievements</div>
    <div id="achievements-list" style="color: #FFFF00; font-size: 18px;"></div>
    <button id="back-to-menu-achievements" onclick="backToMenuFromAchievements()">Back</button>
  </div>
  <div id="shop-menu">
    <div id="logo">Shop</div>
    <div id="shop-items">
      <div class="shop-item">
        <img src="https://via.placeholder.com/50?text=Car" alt="Car">
        <button class="shop-item-btn" onclick="purchaseShip('car', 1)">Car - £1</button>
      </div>
      <div class="shop-item">
        <img src="https://via.placeholder.com/50?text=Plane" alt="Plane">
        <button class="shop-item-btn" onclick="purchaseShip('plane', 1)">Plane - £1</button>
      </div>
      <div class="shop-item">
        <img src="https://via.placeholder.com/50?text=UFO" alt="UFO">
        <button class="shop-item-btn" onclick="purchaseShip('ufo', 1)">UFO - £1</button>
      </div>
      <div class="shop-item">
        <img src="https://via.placeholder.com/50?text=Spaceship" alt="Spaceship">
        <button class="shop-item-btn" onclick="purchaseShip('spaceship', 1)">Spaceship - £1</button>
      </div>
      <div class="shop-item">
        <img src="https://via.placeholder.com/50?text=Tank" alt="Tank">
        <button class="shop-item-btn" onclick="purchaseShip('tank', 1)">Tank - £1</button>
      </div>
      <div class="shop-item">
        <img src="https://via.placeholder.com/50?text=Dragon" alt="Dragon">
        <button class="shop-item-btn" onclick="purchaseShip('dragon', 1)">Dragon - £1</button>
      </div>
      <div class="shop-item">
        <img src="https://via.placeholder.com/50?text=Cruiser" alt="Cruiser">
        <button class="shop-item-btn" onclick="purchaseShip('cruiser', 1)">Cruiser - £1</button>
      </div>
      <div class="shop-item">
        <img src="https://via.placeholder.com/50?text=Bomber" alt="Bomber">
        <button class="shop-item-btn" onclick="purchaseShip('bomber', 1)">Bomber - £1</button>
      </div>
      <div class="shop-item">
        <img src="https://via.placeholder.com/50?text=Pirate" alt="Pirate">
        <button class="shop-item-btn" onclick="purchaseShip('pirate', 1)">Pirate - £1</button>
      </div>
      <div class="shop-item">
        <img src="https://via.placeholder.com/50?text=Random" alt="Random">
        <button class="shop-item-btn" onclick="purchaseRandomShip()">Random AI Ship - £0.50</button>
      </div>
    </div>
    <button id="back-btn" onclick="backToMenuFromShop()">Back</button>
  </div>
  <div id="debug-menu">
    <div id="logo">Debug Menu</div>
    <button class="debug-btn" onclick="debugAddScore(1000)">Add 1000 Score</button>
    <button class="debug-btn" onclick="debugAddScore(10000)">Add 10000 Score</button>
    <button class="debug-btn" onclick="debugNextLevel()">Next Level</button>
    <button class="debug-btn" onclick="debugSpawnUpgrade()">Spawn Random Upgrade</button>
    <button class="debug-btn" onclick="debugToggleInvincibility()">Toggle Invincibility</button>
    <button class="debug-btn" onclick="debugResetGame()">Reset Game</button>
    <button class="debug-btn" onclick="debugMaxBullets()">Max Bullets</button>
    <button class="debug-btn" onclick="debugMaxSpeed()">Max Speed</button>
    <button class="debug-btn" onclick="debugInfiniteShield()">Infinite Shield</button>
    <button class="debug-btn" onclick="debugKillAllPacmen()">Kill All Pacmen</button>
    <button class="debug-btn" onclick="debugSpawnGhosts(5)">Spawn 5 Ghosts</button>
    <button class="debug-btn" onclick="debugIncreaseFireRate()">Increase Fire Rate</button>
    <button class="debug-btn" onclick="debugUnlockAllShips()">Unlock All Ships</button>
    <button class="debug-btn" onclick="debugDoubleSize()">Double Player Size</button>
    <button class="debug-btn" onclick="debugHalfSize()">Half Player Size</button>
    <button class="debug-btn" onclick="debugInstantLevel10()">Jump to Level 10</button>
    <button class="debug-btn" onclick="debugSlowEnemies()">Slow Enemies</button>
    <button class="debug-btn" onclick="debugFastEnemies()">Fast Enemies</button>
    <button class="debug-btn" onclick="debugExtraLives(3)">Add 3 Lives</button>
    <button class="debug-btn" onclick="debugUnlockAchievements()">Unlock All Achievements</button>
    <button id="back-btn" onclick="hideDebugMenu()">Back</button>
  </div>
  <div id="score">Score: 0</div>
  <div id="level">Level: 1</div>
  <div id="control-bar">
    <button id="sound-btn" onclick="toggleMute()">🔊</button>
    <button id="pause-resume-btn" onclick="pauseGame()">⏸️</button>
  </div>
  <canvas id="gameCanvas" width="800" height="600"></canvas>
  <div id="joystick">
    <div id="joystick-nub"></div>
  </div>
  <button id="shoot-btn"></button>
  <div id="messageDisplay"></div>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreDisplay = document.getElementById('score');
    const levelDisplay = document.getElementById('level');
    const joystick = document.getElementById('joystick');
    const joystickNub = document.getElementById('joystick-nub');
    const shootBtn = document.getElementById('shoot-btn');
    const soundBtn = document.getElementById('sound-btn');
    const pauseResumeBtn = document.getElementById('pause-resume-btn');
    const menu = document.getElementById('menu');
    const settingsMenu = document.getElementById('settings-menu');
    const gameOverMenu = document.getElementById('game-over-menu');
    const pauseMenu = document.getElementById('pause-menu');
    const achievementsMenu = document.getElementById('achievements-menu');
    const shopMenu = document.getElementById('shop-menu');
    const debugMenu = document.getElementById('debug-menu');
    const finalScore = document.getElementById('final-score');
    const leaderboardMain = document.getElementById('leaderboard-main');
    const leaderboardGO = document.getElementById('leaderboard-go');
    const themeSelect = document.getElementById('theme-select');
    const shipSelect = document.getElementById('ship-select');
    const bgImageInput = document.getElementById('bg-image-input');
    const bgMusicInput = document.getElementById('bg-music-input');
    const gameVolume = document.getElementById('game-volume');
    const musicVolume = document.getElementById('music-volume');
    const playerNameInput = document.getElementById('player-name');
    const customThemeDiv = document.getElementById('custom-theme');
    const codeInput = document.getElementById('code-input');

    canvas.width = Math.min(800, window.innerWidth - 20);
    canvas.height = Math.min(600, window.innerHeight - 20);

    const player = {
      x: canvas.width / 2,
      y: canvas.height - 60,
      size: 40,
      speed: 5,
      dx: 0,
      dy: 0,
      shootCooldown: 0,
      bulletSpeed: 10,
      fireRate: 20,
      bulletCount: 1,
      shipLevel: 0,
      shipType: 'default',
      frameCount: 0,
      wheelAngle: 0,
      propellerAngle: 0,
      lightAngle: 0,
      flameOffset: 0,
      flapAngle: 0,
      shield: 0,
      lives: 1
    };

    let bullets = [];
    let pacmen = [];
    let ghosts = [];
    let backgroundStars = [];
    let upgrades = [];
    let explosions = [];
    let score = 0;
    let level = 1;
    let gameOver = false;
    let isPaused = false;
    let moveTouchId = null;
    let isShooting = false;
    let ghostSpawnTimer = 0;
    let audioCtx = null;
    let isMuted = false;
    let backgroundMusic = null;
    let customBgImage = null;
    let gameVolumeLevel = 0.5;
    let musicVolumeLevel = 0.5;
    let leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];
    let customSounds = { waka: null, death: null, shoot: null, enemyHit: null, upgrade: null };
    let isPremium = localStorage.getItem('isPremium') === 'true';
    let ownedShips = JSON.parse(localStorage.getItem('ownedShips')) || ['default'];
    let pendingPurchase = null;
    let achievements = JSON.parse(localStorage.getItem('achievements')) || {
      pacmanSlayer: { count: 0, unlocked: false },
      ghostHunter: { count: 0, unlocked: false },
      levelMaster: { count: 0, unlocked: false }
    };
    let isDebugMode = false;
    let isInvincible = false;

    const themes = {
      default: { playerColor: '#FFFF00', pacmanColor: '#FFFF00', ghostColor: '#FF0000', bulletColor: '#FF00FF', bgColor: '#000033', borderColor: '#00FFFF', buttonColor: '#00FFFF', menuColor: '#000000', textColor: '#FFFF00' },
      retro: { playerColor: '#00FF00', pacmanColor: '#FFFF00', ghostColor: '#FF00FF', bulletColor: '#00FFFF', bgColor: '#000000', borderColor: '#00FF00', buttonColor: '#00FF00', menuColor: '#000000', textColor: '#FFFF00' },
      neon: { playerColor: '#FF00FF', pacmanColor: '#00FFFF', ghostColor: '#FF0000', bulletColor: '#FFFF00', bgColor: '#000022', borderColor: '#FF00FF', buttonColor: '#FF00FF', menuColor: '#000022', textColor: '#00FFFF' },
      solar: { playerColor: '#FF4500', pacmanColor: '#FFD700', ghostColor: '#FF8C00', bulletColor: '#FF00FF', bgColor: '#1A0000', borderColor: '#FFA500', buttonColor: '#FFA500', menuColor: '#1A0000', textColor: '#FFD700' },
      cosmic: { playerColor: '#00CED1', pacmanColor: '#FFFFFF', ghostColor: '#9400D3', bulletColor: '#00FFFF', bgColor: '#000011', borderColor: '#00CED1', buttonColor: '#00CED1', menuColor: '#000011', textColor: '#FFFFFF' },
      galaxy: { playerColor: '#8A2BE2', pacmanColor: '#DDA0DD', ghostColor: '#FF1493', bulletColor: '#FF00FF', bgColor: '#0A001A', borderColor: '#8A2BE2', buttonColor: '#8A2BE2', menuColor: '#0A001A', textColor: '#DDA0DD' },
      cyber: { playerColor: '#00FF7F', pacmanColor: '#7FFF00', ghostColor: '#FF00FF', bulletColor: '#FFFF00', bgColor: '#001100', borderColor: '#00FF7F', buttonColor: '#00FF7F', menuColor: '#001100', textColor: '#7FFF00' },
      dark: { playerColor: '#696969', pacmanColor: '#A9A9A9', ghostColor: '#FF4500', bulletColor: '#00FFFF', bgColor: '#1C2526', borderColor: '#696969', buttonColor: '#696969', menuColor: '#1C2526', textColor: '#A9A9A9' }
    };

    let theme = themes.default;
    const baseShips = ['default', 'car', 'plane', 'ufo', 'spaceship', 'tank', 'dragon', 'cruiser', 'bomber', 'pirate'];
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const achievementRequirements = {
      pacmanSlayer: 50,
      ghostHunter: 20,
      levelMaster: 10
    };

    function initAudioContext() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioCtx.state === 'suspended') {
        audioCtx.resume();
      }
    }
    document.addEventListener('touchstart', initAudioContext, { once: true });
    document.addEventListener('click', initAudioContext, { once: true });

    function showMessage(message) {
      const messageDiv = document.getElementById('messageDisplay');
      messageDiv.textContent = message;
      messageDiv.style.display = 'block';
      setTimeout(() => messageDiv.style.display = 'none', 3000);
    }

    function generateUniqueShipName() {
      const prefixes = ['Aero', 'Cosmo', 'Galactic', 'Nebula', 'Stellar', 'Quantum', 'Orbit', 'Nova', 'Astro', 'Lunar'];
      const suffixes = ['Blaster', 'Cruiser', 'Fighter', 'Voyager', 'Phantom', 'Raptor', 'Drift', 'Pulse', 'Scout', 'Xeno'];
      const randomNum = Math.floor(Math.random() * 1000);
      return `${prefixes[Math.floor(Math.random() * prefixes.length)]}${suffixes[Math.floor(Math.random() * suffixes.length)]}${randomNum}`;
    }

    function updateShipSelect() {
      shipSelect.innerHTML = '';
      ownedShips.forEach(ship => {
        const option = document.createElement('option');
        option.value = ship;
        option.textContent = ship;
        if (ship === player.shipType) option.selected = true;
        shipSelect.appendChild(option);
      });
      if (isPremium) {
        baseShips.forEach(ship => {
          if (!ownedShips.includes(ship)) {
            const option = document.createElement('option');
            option.value = ship;
            option.textContent = ship;
            shipSelect.appendChild(option);
          }
        });
      }
    }

    function loadSettings() {
      const savedImage = localStorage.getItem('customBgImage');
      const savedMusic = localStorage.getItem('customBgMusic');
      const savedTheme = localStorage.getItem('theme');
      const savedShip = localStorage.getItem('shipType');
      const savedGameVolume = localStorage.getItem('gameVolume');
      const savedMusicVolume = localStorage.getItem('musicVolume');
      const savedCustomTheme = JSON.parse(localStorage.getItem('customTheme'));
      const savedSounds = JSON.parse(localStorage.getItem('customSounds')) || {};

      if (isPremium) {
        bgImageInput.disabled = false;
        bgMusicInput.disabled = false;
      } else {
        bgImageInput.disabled = true;
        bgMusicInput.disabled = true;
      }

      customBgImage = new Image();
      customBgImage.src = savedImage && isPremium ? savedImage : 'https://picsum.photos/800/600';
      customBgImage.onload = () => {
        drawBackground();
        document.body.style.backgroundImage = `url(${customBgImage.src})`;
        document.body.style.backgroundSize = 'cover';
        showMessage('Background image loaded!');
      };
      customBgImage.onerror = () => {
        console.error('Error loading background image');
        showMessage('Failed to load background image.');
        customBgImage.src = 'https://picsum.photos/800/600';
      };

      backgroundMusic = new Audio(savedMusic && isPremium ? savedMusic : 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3');
      backgroundMusic.loop = true;
      backgroundMusic.volume = musicVolumeLevel;
      backgroundMusic.play().catch(err => {
        console.error('Error playing background music:', err);
        showMessage('Failed to play background music.');
      });

      if (savedTheme) {
        themeSelect.value = savedTheme;
        if (savedTheme === 'custom' && savedCustomTheme) {
          themes.custom = savedCustomTheme;
          document.getElementById('player-color').value = savedCustomTheme.playerColor;
          document.getElementById('pacman-color').value = savedCustomTheme.pacmanColor;
          document.getElementById('ghost-color').value = savedCustomTheme.ghostColor;
          document.getElementById('bullet-color').value = savedCustomTheme.bulletColor;
          document.getElementById('bg-color').value = savedCustomTheme.bgColor;
          document.getElementById('border-color').value = savedCustomTheme.borderColor;
          document.getElementById('button-color').value = savedCustomTheme.buttonColor;
          document.getElementById('menu-color').value = savedCustomTheme.menuColor;
          document.getElementById('text-color').value = savedCustomTheme.textColor;
        }
      }
      if (savedShip && ownedShips.includes(savedShip)) {
        player.shipType = savedShip;
      }
      if (savedGameVolume) {
        gameVolumeLevel = parseFloat(savedGameVolume);
        gameVolume.value = gameVolumeLevel;
      }
      if (savedMusicVolume) {
        musicVolumeLevel = parseFloat(savedMusicVolume);
        musicVolume.value = musicVolumeLevel;
        if (backgroundMusic) backgroundMusic.volume = musicVolumeLevel;
      }
      for (let sound in savedSounds) {
        if (savedSounds[sound]) {
          customSounds[sound] = new Audio(savedSounds[sound]);
        }
      }
      applyTheme();
      updateLeaderboardDisplay();
      updateShipSelect();
      checkPendingPurchase();
    }

    function applyTheme() {
      theme = themes[themeSelect.value];
      canvas.style.borderColor = theme.borderColor;
      const buttons = document.querySelectorAll('button:not(#sound-btn):not(#shoot-btn):not(#pause-resume-btn)');
      buttons.forEach(btn => btn.style.background = theme.buttonColor);
      shootBtn.style.background = `rgba(${parseInt(theme.buttonColor.slice(1,3), 16)}, ${parseInt(theme.buttonColor.slice(3,5), 16)}, ${parseInt(theme.buttonColor.slice(5,7), 16)}, 0.5)`;
      menu.style.background = theme.menuColor;
      settingsMenu.style.background = theme.menuColor;
      gameOverMenu.style.background = `rgba(${parseInt(theme.menuColor.slice(1,3), 16)}, ${parseInt(theme.menuColor.slice(3,5), 16)}, ${parseInt(theme.menuColor.slice(5,7), 16)}, 0.8)`;
      pauseMenu.style.background = `rgba(${parseInt(theme.menuColor.slice(1,3), 16)}, ${parseInt(theme.menuColor.slice(3,5), 16)}, ${parseInt(theme.menuColor.slice(5,7), 16)}, 0.8)`;
      achievementsMenu.style.background = `rgba(${parseInt(theme.menuColor.slice(1,3), 16)}, ${parseInt(theme.menuColor.slice(3,5), 16)}, ${parseInt(theme.menuColor.slice(5,7), 16)}, 0.8)`;
      shopMenu.style.background = `rgba(${parseInt(theme.menuColor.slice(1,3), 16)}, ${parseInt(theme.menuColor.slice(3,5), 16)}, ${parseInt(theme.menuColor.slice(5,7), 16)}, 0.8)`;
      debugMenu.style.background = `rgba(${parseInt(theme.menuColor.slice(1,3), 16)}, ${parseInt(theme.menuColor.slice(3,5), 16)}, ${parseInt(theme.menuColor.slice(5,7), 16)}, 0.8)`;
      document.querySelectorAll('#menu, #settings-menu, #game-over-menu, #pause-menu, #achievements-menu, #shop-menu, #debug-menu, #score, #level, #final-score, #leaderboard, label, #made-by').forEach(el => el.style.color = theme.textColor);
      customThemeDiv.style.display = themeSelect.value === 'custom' ? 'block' : 'none';
    }

    function changeTheme() {
      applyTheme();
    }

    function changeShip() {
      if (ownedShips.includes(shipSelect.value) || isPremium) {
        player.shipType = shipSelect.value;
        localStorage.setItem('shipType', player.shipType);
      } else {
        showMessage('You must own this ship or be a premium user to use it!');
        shipSelect.value = player.shipType;
      }
    }

    function redeemCode() {
      const code = codeInput.value.trim().toLowerCase();
      if (code === 'philo debug') {
        showDebugMenu();
        codeInput.value = '';
      } else if (code === 'gekyume') {
        isPremium = true;
        localStorage.setItem('isPremium', 'true');
        bgImageInput.disabled = false;
        bgMusicInput.disabled = false;
        showMessage('Premium unlocked with code "gekyume"!');
        updateShipSelect();
        codeInput.value = '';
      } else {
        showMessage('Invalid code! Please try again.');
      }
    }

    function purchasePremium() {
      pendingPurchase = { type: 'premium', amount: 15 };
      localStorage.setItem('pendingPurchase', JSON.stringify(pendingPurchase));
      window.open('https://www.paypal.me/kingphilosipher/15', '_blank');
    }

    function purchaseShip(ship, amount) {
      if (ownedShips.includes(ship)) {
        showMessage('You already own this ship!');
        return;
      }
      pendingPurchase = { type: 'ship', ship: ship, amount: amount };
      localStorage.setItem('pendingPurchase', JSON.stringify(pendingPurchase));
      window.open(`https://www.paypal.me/kingphilosipher/${amount}`, '_blank');
    }

    function purchaseRandomShip() {
      pendingPurchase = { type: 'randomShip', amount: 0.50 };
      localStorage.setItem('pendingPurchase', JSON.stringify(pendingPurchase));
      window.open('https://www.paypal.me/kingphilosipher/0.50', '_blank');
    }

    function checkPendingPurchase() {
      pendingPurchase = JSON.parse(localStorage.getItem('pendingPurchase'));
      if (pendingPurchase) {
        const confirmed = confirm(`Did you complete the payment of £${pendingPurchase.amount} for ${pendingPurchase.type === 'premium' ? 'Premium' : pendingPurchase.type === 'ship' ? pendingPurchase.ship : 'a random AI ship'}? Confirm truthfully or lose access and funds!`);
        if (confirmed) {
          if (pendingPurchase.type === 'premium') {
            isPremium = true;
            localStorage.setItem('isPremium', 'true');
            bgImageInput.disabled = false;
            bgMusicInput.disabled = false;
            showMessage('Premium purchased! All ships and uploads unlocked.');
          } else if (pendingPurchase.type === 'ship') {
            ownedShips.push(pendingPurchase.ship);
            localStorage.setItem('ownedShips', JSON.stringify(ownedShips));
            showMessage(`Purchased ${pendingPurchase.ship}!`);
          } else if (pendingPurchase.type === 'randomShip') {
            const newShip = generateUniqueShipName();
            ownedShips.push(newShip);
            localStorage.setItem('ownedShips', JSON.stringify(ownedShips));
            showMessage(`You got a unique AI ship: ${newShip}!`);
          }
          updateShipSelect();
        } else {
          showMessage('Purchase not confirmed. Funds and access denied.');
        }
        localStorage.removeItem('pendingPurchase');
        pendingPurchase = null;
      }
    }

    function toggleMute() {
      isMuted = !isMuted;
      if (isMuted) {
        backgroundMusic.volume = 0;
        soundBtn.textContent = '🔇';
        soundBtn.classList.add('muted');
      } else {
        backgroundMusic.volume = musicVolumeLevel;
        soundBtn.textContent = '🔊';
        soundBtn.classList.remove('muted');
      }
    }

    function uploadBackgroundImage() {
      if (!isPremium) {
        showMessage('Premium required to upload background images!');
        return;
      }
      const file = bgImageInput.files[0];
      if (!file) {
        showMessage('No file selected!');
        return;
      }
      if (file && (file.type === 'image/png' || file.type === 'image/jpeg')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          customBgImage = new Image();
          customBgImage.src = e.target.result;
          customBgImage.onload = () => {
            drawBackground();
            document.body.style.backgroundImage = `url(${customBgImage.src})`;
            document.body.style.backgroundSize = 'cover';
            localStorage.setItem('customBgImage', customBgImage.src);
            showMessage('Background image uploaded successfully!');
          };
          customBgImage.onerror = () => {
            showMessage('Failed to load uploaded image.');
            customBgImage = null;
          };
        };
        reader.readAsDataURL(file);
      } else {
        showMessage('Please upload a valid PNG or JPG image.');
      }
    }

    function uploadBackgroundMusic() {
      if (!isPremium) {
        showMessage('Premium required to upload background music!');
        return;
      }
      const file = bgMusicInput.files[0];
      if (!file) {
        showMessage('No file selected!');
        return;
      }
      if (file && file.type === 'audio/mpeg') {
        const reader = new FileReader();
        reader.onload = (e) => {
          backgroundMusic.src = e.target.result;
          backgroundMusic.loop = true;
          backgroundMusic.volume = musicVolumeLevel;
          localStorage.setItem('customBgMusic', backgroundMusic.src);
          if (!isMuted) backgroundMusic.play().catch(() => showMessage('Failed to play uploaded music.'));
        };
        reader.readAsDataURL(file);
      } else {
        showMessage('Please upload a valid MP3 file.');
      }
    }

    function uploadSound(type) {
      const file = document.getElementById(`${type}-sound`).files[0];
      if (!file) {
        showMessage('No file selected!');
        return;
      }
      if (file && file.type === 'audio/mpeg') {
        const reader = new FileReader();
        reader.onload = (e) => {
          customSounds[type] = new Audio(e.target.result);
          customSounds[type].volume = gameVolumeLevel;
        };
        reader.readAsDataURL(file);
      } else {
        showMessage('Please upload a valid MP3 file.');
      }
    }

    function saveSettings() {
      if (customBgImage) localStorage.setItem('customBgImage', customBgImage.src);
      if (backgroundMusic) localStorage.setItem('customBgMusic', backgroundMusic.src);
      localStorage.setItem('theme', themeSelect.value);
      localStorage.setItem('shipType', player.shipType);
      localStorage.setItem('gameVolume', gameVolume.value);
      localStorage.setItem('musicVolume', musicVolume.value);
      localStorage.setItem('achievements', JSON.stringify(achievements));
      localStorage.setItem('ownedShips', JSON.stringify(ownedShips));
      gameVolumeLevel = parseFloat(gameVolume.value);
      musicVolumeLevel = parseFloat(musicVolume.value);
      if (backgroundMusic) backgroundMusic.volume = isMuted ? 0 : musicVolumeLevel;
      if (themeSelect.value === 'custom') {
        themes.custom = {
          playerColor: document.getElementById('player-color').value,
          pacmanColor: document.getElementById('pacman-color').value,
          ghostColor: document.getElementById('ghost-color').value,
          bulletColor: document.getElementById('bullet-color').value,
          bgColor: document.getElementById('bg-color').value,
          borderColor: document.getElementById('border-color').value,
          buttonColor: document.getElementById('button-color').value,
          menuColor: document.getElementById('menu-color').value,
          textColor: document.getElementById('text-color').value
        };
        localStorage.setItem('customTheme', JSON.stringify(themes.custom));
      }
      const savedSounds = {};
      for (let sound in customSounds) {
        if (customSounds[sound]) savedSounds[sound] = customSounds[sound].src;
      }
      localStorage.setItem('customSounds', JSON.stringify(savedSounds));
      applyTheme();
      showMessage('Settings saved!');
    }

    function updateLeaderboardDisplay() {
      leaderboard.sort((a, b) => b.score - a.score);
      leaderboard = leaderboard.slice(0, 5);
      leaderboardMain.innerHTML = '<strong>Local Leaderboard:</strong><br>' + leaderboard.map((entry, i) => `${i + 1}. ${entry.name}: ${entry.score}`).join('<br>');
      leaderboardGO.innerHTML = leaderboardMain.innerHTML;
    }

    function showLeaderboard(source) {
      const leaderboardDiv = source === 'main' ? leaderboardMain : leaderboardGO;
      leaderboardDiv.style.display = leaderboardDiv.style.display === 'block' ? 'none' : 'block';
      syncLeaderboard();
    }

    function showRules() {
      const rulesSection = document.getElementById('rules-section');
      leaderboardMain.style.display = 'none';
      if (rulesSection.style.display === 'block') {
        rulesSection.style.display = 'none';
      } else {
        rulesSection.style.display = 'block';
        rulesSection.innerHTML = `
          <strong>Rules of PacInvaders:</strong><br>
          1. Move your spaceship using the joystick (touch) or arrow keys (keyboard).<br>
          2. Shoot Pac-Men with the shoot button (touch) or spacebar (keyboard).<br>
          3. Collect ghosts for bonus points (50 points each).<br>
          4. Destroy all Pac-Men to advance to the next level.<br>
          5. Avoid Pac-Men - collision ends the game.<br>
          6. Grab upgrades for better firepower or speed.<br>
          7. Score points: Pac-Men (50 points), Ghosts (50 points).<br>
          8. Higher levels increase Pac-Men speed and numbers.<br>
          9. Enter your name to save your score locally.<br>
          10. Pause with the pause button (top center).`;
      }
    }

    function showAchievements() {
      menu.style.opacity = '0';
      setTimeout(() => {
        menu.style.display = 'none';
        menu.style.opacity = '1';
        achievementsMenu.style.display = 'block';
        achievementsMenu.style.opacity = '0';
        setTimeout(() => {
          achievementsMenu.style.opacity = '1';
          updateAchievementsList();
        }, 10);
      }, 500);
    }

    function updateAchievementsList() {
      const achievementsList = document.getElementById('achievements-list');
      achievementsList.innerHTML = '';
      for (let achievement in achievements) {
        const name = achievement.replace(/([A-Z])/g, ' $1').trim();
        const { count, unlocked } = achievements[achievement];
        const required = achievementRequirements[achievement];
        const status = unlocked ? 'Unlocked' : `Progress: ${count}/${required}`;
        const trophy = unlocked ? '🏆' : '';
        achievementsList.innerHTML += `<div>${name}: ${status} ${trophy}</div>`;
      }
    }

    function backToMenuFromAchievements() {
      achievementsMenu.style.opacity = '0';
      setTimeout(() => {
        achievementsMenu.style.display = 'none';
        achievementsMenu.style.opacity = '1';
        menu.style.display = 'block';
        menu.style.opacity = '0';
        setTimeout(() => menu.style.opacity = '1', 10);
      }, 500);
    }

    function showShop() {
      menu.style.opacity = '0';
      setTimeout(() => {
        menu.style.display = 'none';
        menu.style.opacity = '1';
        shopMenu.style.display = 'block';
        shopMenu.style.opacity = '0';
        setTimeout(() => shopMenu.style.opacity = '1', 10);
      }, 500);
    }

    function backToMenuFromShop() {
      shopMenu.style.opacity = '0';
      setTimeout(() => {
        shopMenu.style.display = 'none';
        shopMenu.style.opacity = '1';
        menu.style.display = 'block';
        menu.style.opacity = '0';
        setTimeout(() => {
          menu.style.opacity = '1';
          checkPendingPurchase();
        }, 10);
      }, 500);
    }

    function showDebugMenu() {
      isDebugMode = true;
      menu.style.opacity = '0';
      setTimeout(() => {
        menu.style.display = 'none';
        menu.style.opacity = '1';
        debugMenu.style.display = 'block';
        debugMenu.style.opacity = '0';
        setTimeout(() => debugMenu.style.opacity = '1', 10);
      }, 500);
    }

    function hideDebugMenu() {
      debugMenu.style.opacity = '0';
      setTimeout(() => {
        debugMenu.style.display = 'none';
        debugMenu.style.opacity = '1';
        menu.style.display = 'block';
        menu.style.opacity = '0';
        setTimeout(() => menu.style.opacity = '1', 10);
      }, 500);
    }

    function playSound(type) {
      if (isMuted || !audioCtx) return;
      if (customSounds[type]) {
        customSounds[type].currentTime = 0;
        customSounds[type].volume = gameVolumeLevel;
        customSounds[type].play().catch(() => {});
      } else {
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        switch(type) {
          case 'waka':
            osc.type = 'square';
            osc.frequency.setValueAtTime(523.25, audioCtx.currentTime);
            osc.frequency.setValueAtTime(659.25, audioCtx.currentTime + 0.1);
            gainNode.gain.setValueAtTime(gameVolumeLevel * 0.2, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.2);
            break;
          case 'death':
            osc.type = 'square';
            osc.frequency.setValueAtTime(784, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(523, audioCtx.currentTime + 0.3);
            gainNode.gain.setValueAtTime(gameVolumeLevel * 0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
            break;
          case 'shoot':
            osc.type = 'square';
            osc.frequency.setValueAtTime(880, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(440, audioCtx.currentTime + 0.1);
            gainNode.gain.setValueAtTime(gameVolumeLevel * 0.2, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
            break;
          case 'enemyHit':
            osc.type = 'square';
            osc.frequency.setValueAtTime(220, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(110, audioCtx.currentTime + 0.15);
            gainNode.gain.setValueAtTime(gameVolumeLevel * 0.25, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.15);
            break;
          case 'upgrade':
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(440, audioCtx.currentTime);
            osc.frequency.setValueAtTime(880, audioCtx.currentTime + 0.2);
            gainNode.gain.setValueAtTime(gameVolumeLevel * 0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
            break;
        }
      }
    }

    function initBackground() {
      backgroundStars = [];
      for (let i = 0; i < 300; i++) {
        backgroundStars.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          size: Math.random() * 5 + 1,
          speed: Math.random() * 0.5 + 0.5,
          color: Math.random() < 0.8 ? '#FFFFFF' : theme.playerColor
        });
      }
    }

    function initLevel() {
      pacmen = [];
      ghosts = [];
      upgrades = [];
      const pacmanCount = level * 3;
      for (let i = 0; i < pacmanCount; i++) {
        pacmen.push({
          x: Math.random() * (canvas.width - 40),
          y: -40,
          size: 40,
          speed: 1 + level * 0.5,
          mouthAngle: 0,
          mouthSpeed: 0.05,
          spinAngle: 0,
          health: 1
        });
      }
      if (Math.random() < 0.5) {
        upgrades.push({
          x: Math.random() * (canvas.width - 20),
          y: -20,
          size: 20,
          speed: 2,
          type: ['gun', 'ship', 'shield', 'speed', 'multi'][Math.floor(Math.random() * 5)],
          color: ['#FF0000', '#0000FF', '#00FF00', '#FFFF00', '#FF00FF'][Math.floor(Math.random() * 5)]
        });
      }
    }

    function spawnGhost() {
      if (Math.random() < 0.02) {
        ghosts.push({
          x: Math.random() * (canvas.width - 20),
          y: -20,
          size: 20,
          speed: 2,
          type: Math.floor(Math.random() * 4)
        });
      }
    }

    function init() {
      score = 0;
      level = 1;
      gameOver = false;
      isPaused = false;
      player.x = canvas.width / 2;
      player.y = canvas.height - 60;
      player.dx = 0;
      player.dy = 0;
      player.shootCooldown = 0;
      player.speed = 5;
      player.bulletSpeed = 10;
      player.fireRate = 20;
      player.bulletCount = 1;
      player.shipLevel = 0;
      player.frameCount = 0;
      player.wheelAngle = 0;
      player.propellerAngle = 0;
      player.lightAngle = 0;
      player.flameOffset = 0;
      player.flapAngle = 0;
      player.shield = 0;
      player.lives = 1;
      isShooting = false;
      bullets = [];
      pacmen = [];
      ghosts = [];
      upgrades = [];
      explosions = [];
      ghostSpawnTimer = 0;
      gameOverMenu.style.display = 'none';
      pauseMenu.style.display = 'none';
      achievementsMenu.style.display = 'none';
      shopMenu.style.display = 'none';
      debugMenu.style.display = 'none';
      leaderboardMain.style.display = 'none';
      leaderboardGO.style.display = 'none';
      document.getElementById('control-bar').style.display = 'flex';
      initLevel();
      initBackground();
      applyTheme();
    }

    function startGame() {
      if (!playerNameInput.value.trim()) {
        showMessage('Please enter your name!');
        return;
      }
      initAudioContext();
      menu.style.opacity = '0';
      setTimeout(() => {
        menu.style.display = 'none';
        menu.style.opacity = '1';
        canvas.style.display = 'block';
        scoreDisplay.style.display = 'block';
        levelDisplay.style.display = 'block';
        document.getElementById('control-bar').style.display = 'flex';
        if (isMobile) {
          joystick.style.display = 'block';
          shootBtn.style.display = 'block';
        }
        init();
        gameLoop();
      }, 500);
    }

    function restartGame() {
      gameOverMenu.style.opacity = '0';
      setTimeout(() => {
        gameOverMenu.style.display = 'none';
        gameOverMenu.style.opacity = '1';
        document.getElementById('control-bar').style.display = 'flex';
        if (isMobile) {
          joystick.style.display = 'block';
          shootBtn.style.display = 'block';
        }
        init();
        gameLoop();
      }, 300);
    }

    function showSettings() {
      menu.style.opacity = '0';
      setTimeout(() => {
        menu.style.display = 'none';
        menu.style.opacity = '1';
        settingsMenu.style.display = 'block';
        settingsMenu.style.opacity = '0';
        setTimeout(() => settingsMenu.style.opacity = '1', 10);
      }, 500);
    }

    function showSettingsFromGameOver() {
      gameOverMenu.style.opacity = '0';
      setTimeout(() => {
        gameOverMenu.style.display = 'none';
        gameOverMenu.style.opacity = '1';
        settingsMenu.style.display = 'block';
        settingsMenu.style.opacity = '0';
        setTimeout(() => settingsMenu.style.opacity = '1', 10);
      }, 300);
    }

    function showSettingsFromPause() {
      pauseMenu.style.opacity = '0';
      setTimeout(() => {
        pauseMenu.style.display = 'none';
        pauseMenu.style.opacity = '1';
        settingsMenu.style.display = 'block';
        settingsMenu.style.opacity = '0';
        setTimeout(() => settingsMenu.style.opacity = '1', 10);
      }, 300);
    }

    function backToMenu() {
      settingsMenu.style.opacity = '0';
      setTimeout(() => {
        settingsMenu.style.display = 'none';
        settingsMenu.style.opacity = '1';
        menu.style.display = 'block';
        menu.style.opacity = '0';
        setTimeout(() => {
          menu.style.opacity = '1';
          checkPendingPurchase();
        }, 10);
      }, 500);
    }

    function backToMainMenu() {
      gameOverMenu.style.opacity = '0';
      setTimeout(() => {
        gameOverMenu.style.display = 'none';
        gameOverMenu.style.opacity = '1';
        menu.style.display = 'block';
        menu.style.opacity = '0';
        setTimeout(() => {
          menu.style.opacity = '1';
          checkPendingPurchase();
        }, 10);
        canvas.style.display = 'none';
        scoreDisplay.style.display = 'none';
        levelDisplay.style.display = 'none';
        joystick.style.display = 'none';
        shootBtn.style.display = 'none';
        document.getElementById('control-bar').style.display = 'none';
        leaderboard.push({ name: playerNameInput.value.trim(), score: score });
        localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
        updateLeaderboardDisplay();
      }, 300);
    }

    function backToMainMenuFromPause() {
      pauseMenu.style.opacity = '0';
      setTimeout(() => {
        pauseMenu.style.display = 'none';
        pauseMenu.style.opacity = '1';
        menu.style.display = 'block';
        menu.style.opacity = '0';
        setTimeout(() => {
          menu.style.opacity = '1';
          checkPendingPurchase();
        }, 10);
        canvas.style.display = 'none';
        scoreDisplay.style.display = 'none';
        levelDisplay.style.display = 'none';
        joystick.style.display = 'none';
        shootBtn.style.display = 'none';
        document.getElementById('control-bar').style.display = 'none';
        leaderboard.push({ name: playerNameInput.value.trim(), score: score });
        localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
        updateLeaderboardDisplay();
      }, 300);
    }

    function pauseGame() {
      if (!gameOver) {
        if (isPaused) {
          resumeGame();
        } else {
          isPaused = true;
          pauseMenu.style.display = 'block';
          pauseMenu.style.opacity = '0';
          setTimeout(() => pauseMenu.style.opacity = '1', 10);
          pauseResumeBtn.textContent = '▶️';
          pauseResumeBtn.classList.add('paused');
        }
      }
    }

    function resumeGame() {
      pauseMenu.style.opacity = '0';
      setTimeout(() => {
        pauseMenu.style.display = 'none';
        pauseMenu.style.opacity = '1';
        isPaused = false;
        document.getElementById('control-bar').style.display = 'flex';
        if (isMobile) {
          joystick.style.display = 'block';
          shootBtn.style.display = 'block';
        }
        pauseResumeBtn.textContent = '⏸️';
        pauseResumeBtn.classList.remove('paused');
        gameLoop();
      }, 300);
    }

    function drawBackground() {
      if (customBgImage && customBgImage.complete) {
        ctx.drawImage(customBgImage, 0, 0, canvas.width, canvas.height);
      } else {
        ctx.fillStyle = theme.bgColor;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }
      backgroundStars.forEach(star => {
        ctx.fillStyle = star.color;
        ctx.beginPath();
        ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
        ctx.fill();
        star.y += star.speed;
        if (star.y > canvas.height) {
          star.y = -star.size;
          star.x = Math.random() * canvas.width;
        }
      });
    }

    function drawPlayer() {
      ctx.save();
      ctx.translate(player.x, player.y);
      ctx.fillStyle = theme.playerColor;

      switch (player.shipType) {
        case 'default':
          ctx.beginPath();
          ctx.moveTo(0, -player.size / 2);
          ctx.lineTo(player.size / 2, player.size / 2);
          ctx.lineTo(player.size / 3, player.size / 3);
          ctx.lineTo(0, 0);
          ctx.lineTo(-player.size / 3, player.size / 3);
          ctx.lineTo(-player.size / 2, player.size / 2);
          ctx.closePath();
          ctx.fill();
          ctx.fillStyle = '#FFFFFF';
          ctx.beginPath();
          ctx.arc(0, -player.size / 4, player.size / 8, 0, Math.PI * 2);
          ctx.fill();
          ctx.fillStyle = `rgba(255, 69, 0, ${Math.sin(player.frameCount * 0.2) * 0.5 + 0.5})`;
          ctx.fillRect(-player.size / 4, player.size / 2, player.size / 2, 5 + Math.sin(player.frameCount * 0.1) * 3);
          break;

        case 'car':
          ctx.fillRect(-player.size / 2, -player.size / 3, player.size, player.size / 2);
          ctx.fillStyle = '#FFFFFF';
          ctx.fillRect(-player.size / 3, -player.size / 4, player.size / 1.5, player.size / 8);
          ctx.fillStyle = '#FFFF00';
          ctx.beginPath();
          ctx.arc(-player.size / 2.5, -player.size / 6, 3, 0, Math.PI * 2);
          ctx.arc(player.size / 2.5, -player.size / 6, 3, 0, Math.PI * 2);
          ctx.fill();
          ctx.fillStyle = '#000000';
          for (let i = -1; i <= 1; i += 2) {
            ctx.save();
            ctx.translate(i * player.size / 3, player.size / 6);
            ctx.rotate(player.wheelAngle);
            ctx.beginPath();
            ctx.arc(0, 0, player.size / 8, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
          }
          break;

        case 'plane':
          ctx.beginPath();
          ctx.moveTo(0, -player.size / 2);
          ctx.lineTo(player.size / 2, player.size / 4);
          ctx.lineTo(player.size / 3, player.size / 2);
          ctx.lineTo(-player.size / 3, player.size / 2);
          ctx.lineTo(-player.size / 2, player.size / 4);
          ctx.closePath();
          ctx.fill();
          ctx.fillStyle = '#AAAAAA';
          ctx.fillRect(-player.size / 6, -player.size / 2, player.size / 3, player.size / 2);
          ctx.fillStyle = '#000000';
          ctx.save();
          ctx.translate(0, -player.size / 2);
          ctx.rotate(player.propellerAngle);
          ctx.fillRect(-player.size / 8, -player.size / 16, player.size / 4, player.size / 8);
          ctx.restore();
          break;

        case 'ufo':
          ctx.beginPath();
          ctx.ellipse(0, 0, player.size / 2, player.size / 4, 0, 0, Math.PI * 2);
          ctx.fill();
          ctx.fillStyle = '#AAAAAA';
          ctx.beginPath();
          ctx.ellipse(0, -player.size / 8, player.size / 3, player.size / 6, 0, 0, Math.PI * 2);
          ctx.fill();
          ctx.fillStyle = `rgba(0, 255, 255, ${Math.sin(player.frameCount * 0.2) * 0.5 + 0.5})`;
          for (let i = -1; i <= 1; i += 2) {
            ctx.beginPath();
            ctx.arc(i * player.size / 3, player.size / 4, player.size / 12, 0, Math.PI * 2);
            ctx.fill();
          }
          break;

        case 'spaceship':
          ctx.beginPath();
          ctx.moveTo(0, -player.size / 2);
          ctx.lineTo(player.size / 2, player.size / 3);
          ctx.lineTo(player.size / 3, player.size / 2);
          ctx.lineTo(-player.size / 3, player.size / 2);
          ctx.lineTo(-player.size / 2, player.size / 3);
          ctx.closePath();
          ctx.fill();
          ctx.fillStyle = '#FFFFFF';
          ctx.beginPath();
          ctx.arc(0, -player.size / 4, player.size / 10, 0, Math.PI * 2);
          ctx.fill();
          ctx.fillStyle = `rgba(255, 165, 0, ${Math.sin(player.frameCount * 0.2) * 0.5 + 0.5})`;
          ctx.fillRect(-player.size / 4, player.size / 2, player.size / 2, 10);
          break;

        case 'tank':
          ctx.fillRect(-player.size / 2, -player.size / 4, player.size, player.size / 2);
          ctx.fillStyle = '#666633';
          ctx.save();
          ctx.rotate(Math.sin(player.frameCount * 0.05) * 0.1);
          ctx.fillRect(-player.size / 8, -player.size / 2, player.size / 4, player.size / 2);
          ctx.restore();
          ctx.fillStyle = '#333333';
          for (let i = -2; i <= 2; i++) {
            ctx.fillRect(-player.size / 2 + i * player.size / 5, player.size / 4, player.size / 5, player.size / 8);
          }
          break;

        case 'dragon':
          ctx.beginPath();
          ctx.moveTo(0, -player.size / 2);
          ctx.lineTo(player.size / 2, 0);
          ctx.lineTo(player.size / 3, player.size / 2);
          ctx.lineTo(-player.size / 3, player.size / 2);
          ctx.lineTo(-player.size / 2, 0);
          ctx.closePath();
          ctx.fill();
          ctx.fillStyle = '#FF4500';
          ctx.beginPath();
          ctx.moveTo(0, -player.size / 2);
          ctx.lineTo(10 + Math.sin(player.frameCount * 0.1) * 5, -player.size / 2 - 15);
          ctx.lineTo(-10 - Math.sin(player.frameCount * 0.1) * 5, -player.size / 2 - 15);
          ctx.fill();
          break;

        case 'cruiser':
          ctx.fillRect(-player.size / 2, -player.size / 2, player.size, player.size);
          ctx.fillStyle = '#AAAAAA';
          ctx.beginPath();
          ctx.arc(0, -player.size / 2, player.size / 4, 0, Math.PI * 2);
          ctx.fill();
          ctx.fillStyle = '#FF0000';
          ctx.fillRect(-player.size / 4, 0, player.size / 8, player.size / 4);
          ctx.fillRect(player.size / 4 - player.size / 8, 0, player.size / 8, player.size / 4);
          break;

        case 'bomber':
          ctx.beginPath();
          ctx.moveTo(0, -player.size / 2);
          ctx.lineTo(player.size / 2, player.size / 4);
          ctx.lineTo(player.size / 3, player.size / 2);
          ctx.lineTo(-player.size / 3, player.size / 2);
          ctx.lineTo(-player.size / 2, player.size / 4);
          ctx.closePath();
          ctx.fill();
          ctx.fillStyle = '#666666';
          ctx.fillRect(-player.size / 4, 0, player.size / 2, player.size / 4);
          ctx.fillStyle = '#000000';
          ctx.fillRect(-player.size / 6, player.size / 2, player.size / 3, player.size / 8);
          break;

        case 'pirate':
          ctx.fillStyle = '#8B4513';
          ctx.beginPath();
          ctx.moveTo(-player.size / 2, player.size / 2);
          ctx.lineTo(player.size / 2, player.size / 2);
          ctx.lineTo(player.size / 3, -player.size / 4);
          ctx.lineTo(-player.size / 3, -player.size / 4);
          ctx.closePath();
          ctx.fill();
          ctx.fillStyle = '#FFFFFF';
          ctx.beginPath();
          ctx.moveTo(0, -player.size / 2);
          ctx.lineTo(player.size / 4, -player.size / 8 + Math.sin(player.frameCount * 0.05) * 5);
          ctx.lineTo(-player.size / 4, -player.size / 8 + Math.sin(player.frameCount * 0.05) * 5);
          ctx.fill();
          ctx.fillStyle = '#000000';
          ctx.fillRect(-player.size / 3, 0, player.size / 8, player.size / 8);
          ctx.fillRect(player.size / 3 - player.size / 8, 0, player.size / 8, player.size / 8);
          ctx.fillStyle = '#FFD700';
          for (let i = 0; i < 3; i++) {
            ctx.beginPath();
            ctx.arc((Math.random() - 0.5) * player.size / 2, (Math.random() - 0.5) * player.size / 2, 2 + Math.sin(player.frameCount * 0.2 + i) * 2, 0, Math.PI * 2);
            ctx.fill();
          }
          break;

        default:
          ctx.beginPath();
          ctx.moveTo(0, -player.size / 2);
          ctx.lineTo(player.size / 2, player.size / 2);
          ctx.lineTo(-player.size / 2, player.size / 2);
          ctx.closePath();
          ctx.fill();
          ctx.fillStyle = `rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, 0.8)`;
          ctx.beginPath();
          ctx.arc(0, 0, player.size / 3, 0, Math.PI * 2);
          ctx.fill();
          break;
      }

      if (player.shipLevel >= 1 && player.shipType !== 'dragon') {
        ctx.fillStyle = '#00FFFF';
        ctx.fillRect(-player.size / 2 - 5, 0, 5, player.size / 2);
        ctx.fillRect(player.size / 2, 0, 5, player.size / 2);
      }
      if (player.shipLevel >= 2 && player.shipType !== 'dragon') {
        ctx.fillStyle = '#FF00FF';
        ctx.beginPath();
        ctx.moveTo(0, -player.size / 2 - 10);
        ctx.lineTo(5, -player.size / 2);
        ctx.lineTo(-5, -player.size / 2);
        ctx.fill();
      }
      if (player.shield > 0) {
        ctx.strokeStyle = '#00FF00';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(0, 0, player.size / 1.5,        0, Math.PI * 2);
        ctx.stroke();
      }

      ctx.restore();
    }

    function drawPacmen() {
      pacmen.forEach(pacman => {
        ctx.save();
        ctx.translate(pacman.x + pacman.size / 2, pacman.y + pacman.size / 2);
        ctx.rotate(pacman.spinAngle);
        ctx.fillStyle = theme.pacmanColor;
        ctx.beginPath();
        ctx.arc(0, 0, pacman.size / 2, pacman.mouthAngle, Math.PI * 2 - pacman.mouthAngle);
        ctx.lineTo(0, 0);
        ctx.fill();
        ctx.fillStyle = '#000000';
        ctx.beginPath();
        ctx.arc(pacman.size / 5, -pacman.size / 4, pacman.size / 10, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
        pacman.mouthAngle += pacman.mouthSpeed;
        if (pacman.mouthAngle > 0.4 || pacman.mouthAngle < 0) pacman.mouthSpeed = -pacman.mouthSpeed;
        pacman.spinAngle += 0.02;
      });
    }

    function drawGhosts() {
      const ghostColors = ['#FF0000', '#FFB8FF', '#00FFFF', '#FFB852'];
      ghosts.forEach(ghost => {
        ctx.fillStyle = ghostColors[ghost.type];
        ctx.beginPath();
        ctx.arc(ghost.x + 10, ghost.y + 8, 10, Math.PI, 0, false);
        ctx.lineTo(ghost.x + 20, ghost.y + 20);
        ctx.lineTo(ghost.x + 16, ghost.y + 16);
        ctx.lineTo(ghost.x + 12, ghost.y + 20);
        ctx.lineTo(ghost.x + 8, ghost.y + 16);
        ctx.lineTo(ghost.x + 4, ghost.y + 20);
        ctx.lineTo(ghost.x, ghost.y + 8);
        ctx.closePath();
        ctx.fill();
        ctx.fillStyle = '#FFFFFF';
        ctx.beginPath();
        ctx.arc(ghost.x + 6, ghost.y + 6, 3, 0, Math.PI * 2);
        ctx.arc(ghost.x + 14, ghost.y + 6, 3, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#000000';
        ctx.beginPath();
        ctx.arc(ghost.x + 6, ghost.y + 6, 1, 0, Math.PI * 2);
        ctx.arc(ghost.x + 14, ghost.y + 6, 1, 0, Math.PI * 2);
        ctx.fill();
      });
    }

    function drawBullets() {
      bullets.forEach(bullet => {
        ctx.shadowBlur = 10;
        ctx.shadowColor = theme.bulletColor;
        ctx.fillStyle = theme.bulletColor;
        if (player.shipType === 'pirate') {
          ctx.font = '20px Arial';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText('L', bullet.x, bullet.y);
        } else {
          ctx.beginPath();
          ctx.arc(bullet.x, bullet.y, 5, 0, Math.PI * 2);
          ctx.fill();
          ctx.shadowBlur = 5;
          ctx.fillStyle = `${theme.bulletColor}80`;
          ctx.beginPath();
          ctx.arc(bullet.x, bullet.y + 5, 4, 0, Math.PI * 2);
          ctx.fill();
        }
        ctx.shadowBlur = 0;
      });
    }

    function drawUpgrades() {
      upgrades.forEach(upgrade => {
        ctx.fillStyle = upgrade.color;
        ctx.beginPath();
        ctx.arc(upgrade.x + upgrade.size / 2, upgrade.y + upgrade.size / 2, upgrade.size / 2, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#FFFFFF';
        ctx.font = '12px Arial';
        ctx.fillText(upgrade.type[0].toUpperCase(), upgrade.x + upgrade.size / 2 - 3, upgrade.y + upgrade.size / 2 + 4);
      });
    }

    function drawExplosions() {
      explosions.forEach((explosion, index) => {
        ctx.fillStyle = `rgba(255, 165, 0, ${explosion.opacity * 0.5})`;
        ctx.beginPath();
        ctx.arc(explosion.x, explosion.y, explosion.size, 0, Math.PI * 2);
        ctx.fill();
        explosion.size += 0.5;
        explosion.opacity -= 0.03;
        if (explosion.opacity <= 0) explosions.splice(index, 1);
      });
    }

    function shoot() {
      if (player.shootCooldown <= 0) {
        if (player.shipType === 'pirate') {
          if (player.bulletCount === 1) {
            bullets.push({ x: player.x, y: player.y - player.size / 2 - 5, speed: player.bulletSpeed });
          } else if (player.bulletCount === 2) {
            bullets.push({ x: player.x - 10, y: player.y - player.size / 2 - 5, speed: player.bulletSpeed });
            bullets.push({ x: player.x + 10, y: player.y - player.size / 2 - 5, speed: player.bulletSpeed });
          } else {
            bullets.push({ x: player.x - 15, y: player.y - player.size / 2 - 5, speed: player.bulletSpeed });
            bullets.push({ x: player.x, y: player.y - player.size / 2 - 5, speed: player.bulletSpeed });
            bullets.push({ x: player.x + 15, y: player.y - player.size / 2 - 5, speed: player.bulletSpeed });
          }
        } else {
          if (player.bulletCount === 1) {
            bullets.push({ x: player.x, y: player.y - player.size / 2 - 5, speed: player.bulletSpeed });
          } else if (player.bulletCount === 2) {
            bullets.push({ x: player.x - 10, y: player.y - player.size / 2 - 5, speed: player.bulletSpeed });
            bullets.push({ x: player.x + 10, y: player.y - player.size / 2 - 5, speed: player.bulletSpeed });
          } else {
            bullets.push({ x: player.x - 15, y: player.y - player.size / 2 - 5, speed: player.bulletSpeed });
            bullets.push({ x: player.x, y: player.y - player.size / 2 - 5, speed: player.bulletSpeed });
            bullets.push({ x: player.x + 15, y: player.y - player.size / 2 - 5, speed: player.bulletSpeed });
          }
        }
        player.shootCooldown = player.fireRate;
        playSound('shoot');
      }
    }

    function update() {
      if (gameOver || isPaused) return;

      player.x += player.dx;
      player.y += player.dy;
      player.x = Math.max(player.size / 2, Math.min(canvas.width - player.size / 2, player.x));
      player.y = Math.max(player.size / 2, Math.min(canvas.height - player.size / 2, player.y));

      player.wheelAngle += 0.1;
      player.propellerAngle += 0.2;
      player.lightAngle += 0.05;
      player.flameOffset = Math.sin(player.frameCount * 0.1) * 5;
      player.flapAngle = Math.sin(player.frameCount * 0.1) * 0.2;

      if (player.shootCooldown > 0) player.shootCooldown--;
      if (isShooting) shoot();

      spawnGhost();

      bullets.forEach((bullet, bIndex) => {
        bullet.y -= bullet.speed;
        if (bullet.y < 0) bullets.splice(bIndex, 1);
        pacmen.forEach((pacman, eIndex) => {
          const bulletWidth = player.shipType === 'pirate' ? 10 : 5;
          const bulletHeight = player.shipType === 'pirate' ? 20 : 5;
          if (bullet.x > pacman.x - bulletWidth && bullet.x < pacman.x + pacman.size + bulletWidth &&
              bullet.y > pacman.y - bulletHeight && bullet.y < pacman.y + pacman.size + bulletHeight) {
            pacman.health--;
            bullets.splice(bIndex, 1);
            if (pacman.health <= 0) {
              explosions.push({ x: pacman.x + pacman.size / 2, y: pacman.y + pacman.size / 2, size: 10, opacity: 1 });
              pacmen.splice(eIndex, 1);
              score += 50;
              achievements.pacmanSlayer.count++;
              if (achievements.pacmanSlayer.count >= achievementRequirements.pacmanSlayer && !achievements.pacmanSlayer.unlocked) {
                achievements.pacmanSlayer.unlocked = true;
                showMessage('Achievement Unlocked: Pac-Man Slayer!');
              }
              scoreDisplay.textContent = `Score: ${score}`;
              playSound('enemyHit');
            }
          }
        });
      });

      pacmen.forEach(pacman => {
        pacman.y += pacman.speed;
        if (pacman.y > canvas.height) {
          pacman.y = -pacman.size;
          pacman.x = Math.random() * (canvas.width - pacman.size);
        }
        if (!isInvincible && Math.abs(pacman.x - player.x) < (pacman.size + player.size) / 2 &&
            Math.abs(pacman.y - player.y) < (pacman.size + player.size) / 2) {
          if (player.shield <= 0) {
            player.lives--;
            if (player.lives <= 0) {
              gameOver = true;
              playSound('death');
              finalScore.textContent = `Score: ${score}`;
              gameOverMenu.style.display = 'block';
              gameOverMenu.style.opacity = '0';
              setTimeout(() => gameOverMenu.style.opacity = '1', 10);
            } else {
              pacman.y = -pacman.size;
              showMessage(`Lives remaining: ${player.lives}`);
            }
          } else {
            pacman.y = -pacman.size;
          }
        }
      });

      if (player.shield > 0) player.shield--;

      upgrades.forEach((upgrade, uIndex) => {
        upgrade.y += upgrade.speed;
        if (upgrade.y > canvas.height) {
          upgrades.splice(uIndex, 1);
        } else if (Math.abs(upgrade.x + upgrade.size / 2 - player.x) < (upgrade.size + player.size) / 2 &&
                   Math.abs(upgrade.y + upgrade.size / 2 - player.y) < (upgrade.size + player.size) / 2) {
          playSound('upgrade');
          switch (upgrade.type) {
            case 'gun':
              if (player.bulletCount < 3) player.bulletCount++;
              else if (player.fireRate > 5) player.fireRate -= 5;
              else player.bulletSpeed += 2;
              break;
            case 'ship':
              player.shipLevel = Math.min(player.shipLevel + 1, 2);
              break;
            case 'shield':
              player.shield = 100;
              break;
            case 'speed':
              player.speed += 2;
              setTimeout(() => player.speed -= 2, 5000);
              break;
            case 'multi':
              player.bulletCount = 5;
              setTimeout(() => player.bulletCount = 1, 5000);
              break;
          }
          upgrades.splice(uIndex, 1);
        }
      });

      ghosts.forEach((ghost, index) => {
        ghost.y += ghost.speed;
        if (ghost.y > canvas.height) {
          ghosts.splice(index, 1);
        } else if (Math.abs(ghost.x + 10 - player.x) < (player.size / 2 + 10) &&
                   Math.abs(ghost.y + 10 - player.y) < (player.size / 2 + 10)) {
          score += 50;
          achievements.ghostHunter.count++;
          if (achievements.ghostHunter.count >= achievementRequirements.ghostHunter && !achievements.ghostHunter.unlocked) {
            achievements.ghostHunter.unlocked = true;
            showMessage('Achievement Unlocked: Ghost Hunter!');
          }
          scoreDisplay.textContent = `Score: ${score}`;
          playSound('waka');
          ghosts.splice(index, 1);
        }
      });

      if (pacmen.length === 0) {
        level++;
        achievements.levelMaster.count++;
        if (achievements.levelMaster.count >= achievementRequirements.levelMaster && !achievements.levelMaster.unlocked) {
          achievements.levelMaster.unlocked = true;
          showMessage('Achievement Unlocked: Level Master!');
        }
        initLevel();
        levelDisplay.textContent = `Level: ${level}`;
      }
    }

    function gameLoop() {
      try {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawBackground();
        drawPlayer();
        drawPacmen();
        drawGhosts();
        drawBullets();
        drawUpgrades();
        drawExplosions();
        update();
        player.frameCount++;
        if (!gameOver && !isPaused) requestAnimationFrame(gameLoop);
      } catch (err) {
        console.error('Game loop crashed:', err);
        gameOver = true;
      }
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') player.dx = -player.speed;
      if (e.key === 'ArrowRight') player.dx = player.speed;
      if (e.key === 'ArrowUp') player.dy = -player.speed;
      if (e.key === 'ArrowDown') player.dy = player.speed;
      if (e.key === ' ') {
        if (!gameOver) isShooting = true;
        else if (!isMobile && gameOverMenu.style.display === 'block') restartGame();
      }
      if (e.key === 'Escape' && !gameOver) pauseGame();
    });

    document.addEventListener('keyup', (e) => {
      if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') player.dx = 0;
      if (e.key === 'ArrowUp' || e.key === 'ArrowDown') player.dy = 0;
      if (e.key === ' ' && !gameOver) isShooting = false;
    });

    joystick.addEventListener('touchstart', (e) => {
      e.preventDefault();
      const touch = e.changedTouches[0];
      moveTouchId = touch.identifier;
      const rect = joystick.getBoundingClientRect();
      const dx = (touch.clientX - rect.left - 50) / 50;
      const dy = (touch.clientY - rect.top - 50) / 50;
      player.dx = Math.max(-1, Math.min(1, dx)) * player.speed;
      player.dy = Math.max(-1, Math.min(1, dy)) * player.speed;
      joystickNub.style.left = `${50 + dx * 30}%`;
      joystickNub.style.top = `${50 + dy * 30}%`;
    }, { passive: false });

    joystick.addEventListener('touchmove', (e) => {
      e.preventDefault();
      for (let touch of e.changedTouches) {
        if (touch.identifier === moveTouchId) {
          const rect = joystick.getBoundingClientRect();
          const dx = Math.max(-1, Math.min(1, (touch.clientX - rect.left - 50) / 50));
          const dy = Math.max(-1, Math.min(1, (touch.clientY - rect.top - 50) / 50));
          player.dx = dx * player.speed;
          player.dy = dy * player.speed;
          joystickNub.style.left = `${50 + dx * 30}%`;
          joystickNub.style.top = `${50 + dy * 30}%`;
          break;
        }
      }
    }, { passive: false });

    joystick.addEventListener('touchend', (e) => {
      e.preventDefault();
      for (let touch of e.changedTouches) {
        if (touch.identifier === moveTouchId) {
          player.dx = 0;
          player.dy = 0;
          joystickNub.style.left = '50%';
          joystickNub.style.top = '50%';
          moveTouchId = null;
          break;
        }
      }
    }, { passive: false });

    shootBtn.addEventListener('touchstart', (e) => {
      e.preventDefault();
      isShooting = true;
    }, { passive: false });

    shootBtn.addEventListener('touchend', (e) => {
      e.preventDefault();
      isShooting = false;
    }, { passive: false });

    // Debug Functions
    function debugAddScore(amount) { score += amount; scoreDisplay.textContent = `Score: ${score}`; }
    function debugNextLevel() { level++; initLevel(); levelDisplay.textContent = `Level: ${level}`; }
    function debugSpawnUpgrade() {
      upgrades.push({
        x: player.x, y: player.y - 50, size: 20, speed: 2,
        type: ['gun', 'ship', 'shield', 'speed', 'multi'][Math.floor(Math.random() * 5)],
        color: ['#FF0000', '#0000FF', '#00FF00', '#FFFF00', '#FF00FF'][Math.floor(Math.random() * 5)]
      });
    }
    function debugToggleInvincibility() { isInvincible = !isInvincible; showMessage(`Invincibility ${isInvincible ? 'ON' : 'OFF'}`); }
    function debugResetGame() { init(); scoreDisplay.textContent = `Score: ${score}`; levelDisplay.textContent = `Level: ${level}`; }
    function debugMaxBullets() { player.bulletCount = 5; showMessage('Max Bullets Activated!'); }
    function debugMaxSpeed() { player.speed = 15; showMessage('Max Speed Activated!'); }
    function debugInfiniteShield() { player.shield = Infinity; showMessage('Infinite Shield Activated!'); }
    function debugKillAllPacmen() { pacmen = []; showMessage('All Pacmen Killed!'); }
    function debugSpawnGhosts(count) { for (let i = 0; i < count; i++) spawnGhost(); showMessage(`${count} Ghosts Spawned!`); }
    function debugIncreaseFireRate() { player.fireRate = Math.max(5, player.fireRate - 5); showMessage('Fire Rate Increased!'); }
    function debugUnlockAllShips() { ownedShips = [...ownedShips, ...baseShips.filter(s => !ownedShips.includes(s))]; updateShipSelect(); showMessage('All Base Ships Unlocked!'); }
    function debugDoubleSize() { player.size *= 2; showMessage('Player Size Doubled!'); }
    function debugHalfSize() { player.size /= 2; showMessage('Player Size Halved!'); }
    function debugInstantLevel10() { level = 10; initLevel(); levelDisplay.textContent = `Level: ${level}`; showMessage('Jumped to Level 10!'); }
    function debugSlowEnemies() { pacmen.forEach(p => p.speed /= 2); showMessage('Enemies Slowed!'); }
    function debugFastEnemies() { pacmen.forEach(p => p.speed *= 2); showMessage('Enemies Sped Up!'); }
    function debugExtraLives(count) { player.lives += count; showMessage(`Added ${count} Lives! Lives: ${player.lives}`); }
    function debugUnlockAchievements() { for (let a in achievements) achievements[a].unlocked = true; updateAchievementsList(); showMessage('All Achievements Unlocked!'); }

    function syncLeaderboard() {
      console.log('Leaderboard sync not implemented in this version. Use Firebase for online sync.');
    }

    function shareScore() {
      if (navigator.share) {
        navigator.share({
          title: 'PacInvaders Score',
          text: `${playerNameInput.value.trim()} scored ${score} in PacInvaders!`,
          url: window.location.href
        }).catch(() => showMessage('Sharing failed!'));
      } else {
        showMessage('Sharing only available on mobile browsers with Web Share API support!');
      }
    }

    loadSettings();
  </script>
</body>
</html>